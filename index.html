<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher App</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f4f4f4; margin: 0; padding: 20px; box-sizing: border-box; }
        .page-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        input, select, textarea { display: block; width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 60px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .logout-btn, .delete-btn, .reject-btn { background-color: #dc3545; }
        .logout-btn:hover, .delete-btn:hover, .reject-btn:hover { background-color: #c82333; }
        .clear-btn { background-color: #ffc107; color: #333; }
        .clear-btn:hover { background-color: #e0a800; }
        .back-btn { background-color: #6c757d; }
        .back-btn:hover { background-color: #5a6268; }
        .approve-btn { background-color: #28a745; }
        .approve-btn:hover { background-color: #218838; }
        .hidden { display: none !important; }
        .suggestion-box { border: 1px solid #ddd; max-height: 150px; overflow-y: auto; background-color: white; position: absolute; width: calc(100% - 42px); z-index: 100; }
        .suggestion-item { padding: 8px; cursor: pointer; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        input[type="checkbox"] { width: auto; margin-right: 5px;}
        .checkbox-container { display: flex; align-items: center; margin-bottom: 10px; }
        .request-item { border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-bottom: 15px; }
        .request-item h4 { margin-top: 0; }
        .last-modified { font-style: italic; color: #888; font-size: 12px; margin-top: -5px; margin-bottom: 10px; }
        #uploadStatus, #uploadStatusPublishers { margin-top: 15px; font-weight: bold; }
        #uploadStatus pre, #uploadStatusPublishers pre { white-space: pre-wrap; word-wrap: break-word; background-color: #eee; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="loginPage" class="page-container">
        <h2>Login</h2>
        <input type="email" id="loginUsername" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button id="loginBtn">Login</button>
    </div>
    <div id="homePage" class="page-container hidden">
        <h2>Welcome, <span id="loggedInUser"></span>!</h2>
        <div id="adminButtons">
    <button id="managePublisherBtn">Manage Publisher</button>
    <button id="manageAuxiliaryPioneerBtn">Manage Auxiliary Pioneer</button>
    <button id="addReportBtnAdmin">Add Report</button>
    <button id="updateReportPageBtn">Update Report</button>
    <button id="reviewApprovalsBtn">Review Approvals</button>
    <button id="viewSummaryBtn">View Summary Report</button>
    <button id="exportExcelBtn">Export to Excel</button>
    <button id="uploadReportsBtn">Upload Reports</button>
    <button id="uploadPublishersBtn">Upload Publishers</button>
</div>
        <div id="userButtons">
            <button id="addReportBtnUser">Add Report</button>
            <button id="submitRequestPageBtn">Submit Request to Update</button>
        </div>
        <button id="logoutBtn" class="logout-btn">Logout</button>
        <div id="adminSection" style="margin-top: 20px;">
             <button id="clearAllDataBtn">Clear All Data</button>
             <p style="color: red; font-size: 12px; margin-top: 5px;">Warning: This will delete all publisher and report data.</p>
        </div>
    </div>
    <div id="manageAuxiliaryPage" class="page-container hidden">
        <h2>Manage Auxiliary Pioneer Status</h2>
        <p>Select a "Publisher/Auxi" and the month to set their pioneer status.</p>
        <label for="searchPublisherAux">Search Publisher (Publisher/Auxi only):</label>
        <input type="text" id="searchPublisherAux" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxAux" class="suggestion-box"></div>
        <label for="publisherNameDropdownAux">Publisher Name:</label>
        <select id="publisherNameDropdownAux"></select>
        <label for="fieldGroupAux">Field Service Group:</label>
        <input type="text" id="fieldGroupAux" disabled>
        <label for="privilege2Aux">Privilege 2:</label>
        <input type="text" id="privilege2Aux" disabled>
        <label for="serviceYearDropdownAux">Service Year:</label>
        <select id="serviceYearDropdownAux"></select>
        <label for="monthYearDropdownAux">Month:</label>
        <select id="monthYearDropdownAux"></select>
        <hr style="margin: 20px 0;">
        <label for="isAuxiliaryPioneerThisMonthAux">Is this publisher an Auxiliary Pioneer for the selected month?</label>
        <select id="isAuxiliaryPioneerThisMonthAux">
            <option value="No">No</option>
            <option value="Yes">Yes</option>
        </select>
        <div id="lastModifiedByAux" class="last-modified"></div>
        <button id="addAuxStatusBtn">Add</button>
        <button id="updateAuxStatusBtn">Update</button>
        <button id="previousAuxStatusBtn">Previous</button>
        <button id="nextAuxStatusBtn">Next</button>
        <button id="clearAuxFormBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromAuxBtn" class="back-btn">Back to Home</button>
    </div>
    <div id="addReportPage" class="page-container hidden">
        <h2>Add Field Service Report</h2>
        <label for="searchPublisherReport">Search Publisher:</label>
        <input type="text" id="searchPublisherReport" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxReport" class="suggestion-box"></div>
        <label for="publisherNameDropdown">Publisher Name:</label>
        <select id="publisherNameDropdown"></select>
        <label for="fieldGroup">Field Service Group:</label>
        <input type="text" id="fieldGroup" disabled>
        <label for="privilege2Report">Privilege 2:</label>
        <input type="text" id="privilege2Report" disabled>
        <label for="serviceYearDropdown">Service Year:</label>
        <select id="serviceYearDropdown"></select>
        <label for="monthYearDropdown">Month:</label>
        <select id="monthYearDropdown"></select>
        <label for="consolidateYearReport">Consolidate Report to:</label>
        <select id="consolidateYearReport"></select>
        <select id="consolidateMonthReport"></select>
        <div id="fieldHoursContainer" class="hidden">
            <label for="fieldHours">Field Hours:</label>
            <input type="number" id="fieldHours" min="1">
        </div>
        <div id="bibleStudiesContainer" class="hidden">
            <label for="bibleStudies">Bible Studies:</label>
            <input type="number" id="bibleStudies" min="0">
        </div>
        <div id="sharedMinistryContainer" class="hidden">
            <div class="checkbox-container">
                <input type="checkbox" id="sharedMinistry">
                <label for="sharedMinistry">Shared in Ministry</label>
            </div>
        </div>
        <div id="auxiliaryPioneerCheckboxContainer" class="hidden">
            <div class="checkbox-container">
                <input type="checkbox" id="auxiliaryPioneerCheckbox">
                <label for="auxiliaryPioneerCheckbox">Auxiliary Pioneer</label>
            </div>
        </div>
        <label for="commentsAdd">Comments (Optional):</label>
        <textarea id="commentsAdd"></textarea>
        <div id="lastModifiedByAdd" class="last-modified"></div>
        <button id="saveReportBtn">Save Report</button>
        <button id="clearReportBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromReportBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromReport" class="logout-btn">Logout</button>
    </div>
    <div id="updateReportPage" class="page-container hidden">
        <h2>Update Field Service Report</h2>
        <label for="searchPublisherUpdate">Search Publisher:</label>
        <input type="text" id="searchPublisherUpdate" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxUpdate" class="suggestion-box"></div>
        <label for="publisherNameDropdownUpdate">Publisher Name:</label>
        <select id="publisherNameDropdownUpdate"></select>
        <label for="fieldGroupUpdate">Field Service Group:</label>
        <input type="text" id="fieldGroupUpdate" disabled>
        <label for="privilege2Update">Privilege 2:</label>
        <input type="text" id="privilege2Update" disabled>
        <label for="serviceYearDropdownUpdate">Service Year:</label>
        <select id="serviceYearDropdownUpdate"></select>
        <label for="monthYearDropdownUpdate">Month:</label>
        <select id="monthYearDropdownUpdate"></select>
        <label for="consolidateYearUpdate">Consolidate Report to:</label>
        <select id="consolidateYearUpdate"></select>
        <select id="consolidateMonthUpdate"></select>
        <hr style="margin: 20px 0;">
        <div id="updateReportFields" style="display: none;">
            <div id="fieldHoursContainerUpdate" class="hidden">
                <label for="fieldHoursUpdate">Field Hours:</label>
                <input type="number" id="fieldHoursUpdate" min="1">
            </div>
            <div id="bibleStudiesContainerUpdate" class="hidden">
                <label for="bibleStudiesUpdate">Bible Studies:</label>
                <input type="number" id="bibleStudiesUpdate" min="0">
            </div>
            <div id="sharedMinistryContainerUpdate" class="hidden">
                <div class="checkbox-container">
                    <input type="checkbox" id="sharedMinistryUpdate">
                    <label for="sharedMinistryUpdate">Shared in Ministry</label>
                </div>
            </div>
            <div id="auxiliaryPioneerCheckboxContainerUpdate" class="hidden">
                <div class="checkbox-container">
                    <input type="checkbox" id="auxiliaryPioneerCheckboxUpdate">
                    <label for="auxiliaryPioneerCheckboxUpdate">Auxiliary Pioneer</label>
                </div>
            </div>
            <label for="commentsUpdate">Comments (Optional):</label>
            <textarea id="commentsUpdate"></textarea>
            <div id="lastModifiedByUpdate" class="last-modified"></div>
        </div>
        <button id="updateReportBtn">Update</button>
        <button id="deleteReportBtn" class="delete-btn">Delete</button>
        <button id="clearUpdateFormBtn" class="clear-btn">Clear</button>
        <button id="backHomeFromUpdateBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromUpdate" class="logout-btn">Logout</button>
    </div>
    <div id="publisherPage" class="page-container hidden">
        <h2>Manage Publisher Records</h2>
        <input type="text" id="searchPublisher" placeholder="Search Publisher...">
        <div id="suggestionBox" class="suggestion-box"></div>
        <label for="firstName">First Name:</label>
        <input type="text" id="firstName">
        <label for="lastName">Last Name:</label>
        <input type="text" id="lastName">
        <label for="fullName">Full Name:</label>
        <input type="text" id="fullName" disabled>

        <label for="publisherStatus">Publisher Status:</label>
        <select id="publisherStatus">
            <option value="">-- Select --</option>
            <option value="In the Congregation">In the Congregation</option>
            <option value="Transferred">Transferred</option>
            <option value="Dead">Dead</option>
        </select>

        <div id="transferDateContainer" class="hidden">
            <label for="transferYear">Year of Transfer:</label>
            <select id="transferYear"></select>
            <label for="transferMonth">Month of Transfer:</label>
            <select id="transferMonth"></select>
        </div>

        <div id="deathDateContainer" class="hidden">
            <label for="deathYear">Year of Death:</label>
            <select id="deathYear"></select>
            <label for="deathMonth">Month of Death:</label>
            <select id="deathMonth"></select>
        </div>

        <label for="birthdate">Birthdate:</label>
        <input type="date" id="birthdate">
        <label for="baptismStatus">Baptism Status:</label>
        <select id="baptismStatus">
            <option value="">-- Select --</option>
            <option value="Baptized">Baptized</option>
            <option value="Baptized but can't remember the date">Baptized but can't remember the date</option>
            <option value="Unbaptized">Unbaptized</option>
        </select>
        <div id="baptismDateContainer" class="hidden">
            <label for="baptismDate">Baptism Date:</label>
            <input type="date" id="baptismDate">
        </div>
        <label for="gender">Gender:</label>
        <select id="gender">
            <option value="">-- Select --</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
        <label for="hope">Hope:</label>
        <select id="hope">
            <option value="">-- Select --</option>
            <option value="Anointed">Anointed</option>
            <option value="Other Sheep">Other Sheep</option>
        </select>
        <label for="privilege">Privilege:</label>
        <select id="privilege">
            <option value="">-- Select --</option>
            <option value="Not Applicable">Not Applicable</option>
            <option value="Ministerial Servant">Ministerial Servant</option>
            <option value="Elder">Elder</option>
        </select>
        <label for="privilege2">Privilege 2:</label>
        <select id="privilege2">
            <option value="">-- Select --</option>
            <option value="Regular Pioneer">Regular Pioneer</option>
            <option value="Special Pioneer">Special Pioneer</option>
            <option value="Field Missionary">Field Missionary</option>
            <option value="Continuous Auxiliary Pioneer">Continuous Auxiliary Pioneer</option>
            <option value="Publisher/Auxi">Publisher/Auxi</option>
        </select>
        <label for="fieldServiceGroup">Field Service Group:</label>
        <select id="fieldServiceGroup">
            <option value="">-- Select --</option>
            <option value="Field Service Group 1">Field Service Group 1</option>
            <option value="Field Service Group 2">Field Service Group 2</option>
            <option value="Field Service Group 3">Field Service Group 3</option>
            <option value="Field Service Group 4">Field Service Group 4</option>
            <option value="Field Service Group 5">Field Service Group 5</option>
            <option value="Field Service Group 6">Field Service Group 6</option>
            <option value="Field Service Group 7">Field Service Group 7</option>
            <option value="Field Service Group 8">Field Service Group 8</option>
        </select>
        <button id="addPublisherBtn">Add</button>
        <button id="updatePublisherBtn">Update</button>
        <button id="deletePublisherBtn" class="delete-btn">Delete</button>
        <button id="previousPublisherBtn">Previous</button>
        <button id="nextPublisherBtn">Next</button>
        <button id="clearPublisherFormBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromPublisherBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromPublisher" class="logout-btn">Logout</button>
    </div>
    <div id="submitRequestPage" class="page-container hidden">
        <h2>Submit Request to Update Report</h2>
        <h4>Who do you want to update?</h4>
        <label for="searchPublisherRequest">Search Publisher:</label>
        <input type="text" id="searchPublisherRequest" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxRequest" class="suggestion-box"></div>
        <label for="publisherNameDropdownRequest">Publisher Name:</label>
        <select id="publisherNameDropdownRequest"></select>
        <label for="fieldGroupRequest">Field Service Group:</label>
        <input type="text" id="fieldGroupRequest" disabled>
        <label for="privilege2Request">Privilege 2:</label>
        <input type="text" id="privilege2Request" disabled>
        <hr style="margin: 20px 0;">
        <h4>What Service Year and Month do you want to update?</h4>
        <label for="serviceYearRequest">Service Year:</label>
        <select id="serviceYearRequest"></select>
        <label for="monthYearRequest">Month:</label>
        <select id="monthYearRequest"></select>
        <label for="consolidateYearRequest">Consolidate Report to:</label>
        <select id="consolidateYearRequest"></select>
        <select id="consolidateMonthRequest"></select>
        <div id="requestFields" style="display: none;">
            </div>
        <button id="submitRequestApprovalBtn">Submit Request for Admin Approval</button>
        <button id="clearRequestFormBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromRequestBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromRequest" class="logout-btn">Logout</button>
    </div>
    <div id="reviewApprovalsPage" class="page-container hidden">
        <h2>Review Approvals</h2>
        <div id="pendingRequestsList">
            <p id="noPendingRequestsLabel" class="hidden">Walang naka-pending na request sa ngayon.</p>
        </div>
        <button id="backHomeFromReviewBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromReview" class="logout-btn">Logout</button>
    </div>
    <div id="uploadPage" class="page-container hidden">
        <h2>Upload Field Service Reports</h2>
        <p>Please select an Excel (.xlsx, .xls) or .csv file. The format must match the one from "Export to Excel".</p>
        <input type="file" id="excelFileInput" class="hidden" accept=".xlsx, .xls, .csv">
        <button id="selectFileBtn">Select File</button>
        <div id="uploadStatus">
            <p>No file selected.</p>
        </div>
        <button id="processUploadBtn" disabled>Upload and Process Records</button>
        <hr>
        <button id="backHomeFromUploadBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromUpload" class="logout-btn">Logout</button>
    </div>
    <div id="uploadPublishersPage" class="page-container hidden">
        <h2>Upload Publishers</h2>
        <p>Please select an Excel (.xlsx, .xls) or .csv file. All columns are required.</p>
        <input type="file" id="excelFileInputPublishers" class="hidden" accept=".xlsx, .xls, .csv">
        <button id="selectFileBtnPublishers">Select File</button>
        <div id="uploadStatusPublishers">
            <p>No file selected.</p>
        </div>
        <button id="processUploadBtnPublishers" disabled>Upload and Process Publishers</button>
        <hr>
        <button id="backHomeFromUploadPublishersBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromUploadPublishers" class="logout-btn">Logout</button>
    </div>
    <div id="summaryReportPage" class="page-container hidden">
        <h2>Monthly Summary Report</h2>
        <p>Select a service year and month to generate the summary.</p>
        <label for="serviceYearSummary">Service Year:</label>
        <select id="serviceYearSummary"></select>
        <label for="monthSummary">Month:</label>
        <select id="monthSummary"></select>
        <button id="generateSummaryBtn">Generate Summary</button>
        <button id="clearSummaryBtn" class="clear-btn">Clear</button>
        <hr style="margin: 20px 0;">
        <div id="summaryResults">
            <p>No summary generated yet.</p>
        </div>
        <button id="backHomeFromSummaryBtn" class="back-btn">Back to Home</button>
    </div>
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyDbKyWaYclW4jZ2eQ0qrK_PIfrh-7sahwY",
        authDomain: "field-service-reporter.firebaseapp.com",
        projectId: "field-service-reporter",
        storageBucket: "field-service-reporter.appspot.com",
        messagingSenderId: "434729902657",
        appId: "1:434729902657:web:c1b06d2695a47924f89cc0",
        measurementId: "G-9N52K2CGDD"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    const auth = firebase.auth();
    let publisherList = [];
    let auxStatusList = [];
    let currentIndex = -1;
    let currentAuxStatusIndex = -1;
    let currentDocId = null;
    let currentUser = null;
    let currentReportId = null;
    let parsedExcelData = [];
    let adminPassword = null;
    let loginPage, homePage, addReportPage, publisherPage, updateReportPage, submitRequestPage, reviewApprovalsPage, uploadPage, uploadPublishersPage, manageAuxiliaryPage;
    let loggedInUser, adminButtons, userButtons, adminSection;
    let loginUsername, loginPassword;
    let serviceYearDropdown, monthYearDropdown;
    let fieldHoursContainer, fieldHoursInput, bibleStudiesContainer, bibleStudiesInput;
    let sharedMinistryContainer, sharedMinistryCheckbox, auxiliaryPioneerCheckboxContainer, auxiliaryPioneerCheckbox;
    let privilege2ReportInput, logoutBtnFromReport, searchPublisherReportInput, suggestionBoxReport, publisherNameDropdown, fieldGroupInput;
    let firstNameInput, lastNameInput, fullNameInput, birthdateInput, baptismStatusDropdown;
    let baptismDateContainer, baptismDateInput, genderDropdown, hopeDropdown, privilegeDropdown;
    let privilege2Dropdown, fieldServiceGroupDropdown;
    let addPublisherBtn, updatePublisherBtn, deletePublisherBtn, previousPublisherBtn, nextPublisherBtn;
    let clearPublisherFormBtn, backHomeFromPublisherBtn, logoutBtnFromPublisher, searchInputManage, suggestionBoxManage;
    let publisherNameDropdownUpdate, serviceYearDropdownUpdate, monthYearDropdownUpdate, searchPublisherUpdate, suggestionBoxUpdate;
    let fieldGroupUpdate, privilege2Update;
    let fieldHoursUpdate, bibleStudiesUpdate, sharedMinistryUpdate, auxiliaryPioneerCheckboxUpdate;
    let updateReportFieldsDiv;
    let fieldHoursContainerUpdate, bibleStudiesContainerUpdate, sharedMinistryContainerUpdate, auxiliaryPioneerCheckboxContainerUpdate;
    let updateReportBtn, deleteReportBtn, clearUpdateFormBtn, backHomeFromUpdateBtn, logoutBtnFromUpdate;
    let commentsAdd, lastModifiedByAdd, commentsUpdate, lastModifiedByUpdate;
    let searchPublisherRequest, suggestionBoxRequest, publisherNameDropdownRequest, fieldGroupRequest, privilege2Request;
    let serviceYearRequest, monthYearRequest, requestFields, submitRequestApprovalBtn, clearRequestFormBtn, backHomeFromRequestBtn, logoutBtnFromRequest;
    let pendingRequestsList, noPendingRequestsLabel;
    let selectFileBtn, excelFileInput, uploadStatus, processUploadBtn, backHomeFromUploadBtn, logoutBtnFromUpload;
    let selectFileBtnPublishers, excelFileInputPublishers, uploadStatusPublishers, processUploadBtnPublishers, backHomeFromUploadPublishersBtn, logoutBtnFromUploadPublishers;
    let searchPublisherAux, suggestionBoxAux, publisherNameDropdownAux, fieldGroupAux, privilege2Aux, serviceYearDropdownAux, monthYearDropdownAux, isAuxiliaryPioneerThisMonthAux, addAuxStatusBtn, updateAuxStatusBtn, previousAuxStatusBtn, nextAuxStatusBtn, clearAuxFormBtn, backHomeFromAuxBtn, lastModifiedByAux;
    let summaryReportPage;
    let serviceYearSummary, monthSummary, generateSummaryBtn, summaryResults, backHomeFromSummaryBtn;
    let clearSummaryBtn;
    let publisherStatus, transferDateContainer, transferYear, transferMonth, deathDateContainer, deathYear, deathMonth;
    let consolidateYearReport, consolidateMonthReport, consolidateYearUpdate, consolidateMonthUpdate, consolidateYearRequest, consolidateMonthRequest;
    
    document.addEventListener("DOMContentLoaded", initializeApp);
    async function initializeApp() {
        getAllElements();
        attachAllListeners();
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDoc = await db.collection("users").doc(user.uid).get();
                if (userDoc.exists) {
                    currentUser = { uid: user.uid, email: user.email, role: userDoc.data().role };
                } else {
                    console.error("User document not found in Firestore. Signing out.");
                    await auth.signOut();
                    return;
                }
                await loadPublishers();
                if (currentUser.role === 'admin') {
                    await loadAuxStatuses();
                }
                handleRouteChange();
            } else {
                currentUser = null;
                publisherList = [];
                auxStatusList = [];
                handleRouteChange();
            }
        });
    }
        function getAllElements() {
    loginPage = document.getElementById('loginPage');
    homePage = document.getElementById('homePage');
    addReportPage = document.getElementById('addReportPage');
    publisherPage = document.getElementById('publisherPage');
    updateReportPage = document.getElementById('updateReportPage');
    submitRequestPage = document.getElementById('submitRequestPage');
    reviewApprovalsPage = document.getElementById('reviewApprovalsPage');
    uploadPage = document.getElementById('uploadPage');
    uploadPublishersPage = document.getElementById('uploadPublishersPage');
    manageAuxiliaryPage = document.getElementById('manageAuxiliaryPage');
    summaryReportPage = document.getElementById('summaryReportPage');
    loggedInUser = document.getElementById('loggedInUser');
    adminButtons = document.getElementById('adminButtons');
    userButtons = document.getElementById('userButtons');
    adminSection = document.getElementById('adminSection');
    loginUsername = document.getElementById('loginUsername');
    loginPassword = document.getElementById('loginPassword');
    serviceYearDropdown = document.getElementById("serviceYearDropdown");
    monthYearDropdown = document.getElementById("monthYearDropdown");
    fieldHoursContainer = document.getElementById("fieldHoursContainer");
    fieldHoursInput = document.getElementById("fieldHours");
    bibleStudiesContainer = document.getElementById("bibleStudiesContainer");
    bibleStudiesInput = document.getElementById("bibleStudies");
    sharedMinistryContainer = document.getElementById("sharedMinistryContainer");
    sharedMinistryCheckbox = document.getElementById("sharedMinistry");
    auxiliaryPioneerCheckboxContainer = document.getElementById("auxiliaryPioneerCheckboxContainer");
    auxiliaryPioneerCheckbox = document.getElementById("auxiliaryPioneerCheckbox");
    privilege2ReportInput = document.getElementById("privilege2Report");
    searchPublisherReportInput = document.getElementById("searchPublisherReport");
    suggestionBoxReport = document.getElementById("suggestionBoxReport");
    publisherNameDropdown = document.getElementById("publisherNameDropdown");
    fieldGroupInput = document.getElementById("fieldGroup");
    logoutBtnFromReport = document.getElementById("logoutBtnFromReport");
    commentsAdd = document.getElementById('commentsAdd');
    lastModifiedByAdd = document.getElementById('lastModifiedByAdd');
    firstNameInput = document.getElementById("firstName");
    lastNameInput = document.getElementById("lastName");
    fullNameInput = document.getElementById("fullName");
    birthdateInput = document.getElementById("birthdate");
    baptismStatusDropdown = document.getElementById("baptismStatus");
    baptismDateContainer = document.getElementById("baptismDateContainer");
    baptismDateInput = document.getElementById("baptismDate");
    genderDropdown = document.getElementById("gender");
    hopeDropdown = document.getElementById("hope");
    privilegeDropdown = document.getElementById("privilege");
    privilege2Dropdown = document.getElementById("privilege2");
    fieldServiceGroupDropdown = document.getElementById("fieldServiceGroup");
    addPublisherBtn = document.getElementById("addPublisherBtn");
    updatePublisherBtn = document.getElementById("updatePublisherBtn");
    deletePublisherBtn = document.getElementById("deletePublisherBtn");
    previousPublisherBtn = document.getElementById("previousPublisherBtn");
    nextPublisherBtn = document.getElementById("nextPublisherBtn");
    clearPublisherFormBtn = document.getElementById("clearPublisherFormBtn");
    backHomeFromPublisherBtn = document.getElementById("backHomeFromPublisherBtn");
    logoutBtnFromPublisher = document.getElementById("logoutBtnFromPublisher");
    searchInputManage = document.getElementById("searchPublisher");
    suggestionBoxManage = document.getElementById("suggestionBox");
    publisherNameDropdownUpdate = document.getElementById('publisherNameDropdownUpdate');
    serviceYearDropdownUpdate = document.getElementById('serviceYearDropdownUpdate');
    monthYearDropdownUpdate = document.getElementById('monthYearDropdownUpdate');
    searchPublisherUpdate = document.getElementById('searchPublisherUpdate');
    suggestionBoxUpdate = document.getElementById('suggestionBoxUpdate');
    fieldGroupUpdate = document.getElementById('fieldGroupUpdate');
    privilege2Update = document.getElementById('privilege2Update');
    updateReportFieldsDiv = document.getElementById('updateReportFields');
    fieldHoursUpdate = document.getElementById('fieldHoursUpdate');
    bibleStudiesUpdate = document.getElementById('bibleStudiesUpdate');
    sharedMinistryUpdate = document.getElementById('sharedMinistryUpdate');
    auxiliaryPioneerCheckboxUpdate = document.getElementById('auxiliaryPioneerCheckboxUpdate');
    fieldHoursContainerUpdate = document.getElementById('fieldHoursContainerUpdate');
    bibleStudiesContainerUpdate = document.getElementById('bibleStudiesContainerUpdate');
    sharedMinistryContainerUpdate = document.getElementById('sharedMinistryContainerUpdate');
    auxiliaryPioneerCheckboxContainerUpdate = document.getElementById('auxiliaryPioneerCheckboxContainerUpdate');
    updateReportBtn = document.getElementById('updateReportBtn');
    deleteReportBtn = document.getElementById('deleteReportBtn');
    clearUpdateFormBtn = document.getElementById('clearUpdateFormBtn');
    backHomeFromUpdateBtn = document.getElementById('backHomeFromUpdateBtn');
    logoutBtnFromUpdate = document.getElementById('logoutBtnFromUpdate');
    commentsUpdate = document.getElementById('commentsUpdate');
    lastModifiedByUpdate = document.getElementById('lastModifiedByUpdate');
    searchPublisherRequest = document.getElementById('searchPublisherRequest');
    suggestionBoxRequest = document.getElementById('suggestionBoxRequest');
    publisherNameDropdownRequest = document.getElementById('publisherNameDropdownRequest');
    fieldGroupRequest = document.getElementById('fieldGroupRequest');
    privilege2Request = document.getElementById('privilege2Request');
    serviceYearRequest = document.getElementById('serviceYearRequest');
    monthYearRequest = document.getElementById('monthYearRequest');
    requestFields = document.getElementById('requestFields');
    submitRequestApprovalBtn = document.getElementById('submitRequestApprovalBtn');
    clearRequestFormBtn = document.getElementById('clearRequestFormBtn');
    backHomeFromRequestBtn = document.getElementById('backHomeFromRequestBtn');
    logoutBtnFromRequest = document.getElementById('logoutBtnFromRequest');
    pendingRequestsList = document.getElementById('pendingRequestsList');
    noPendingRequestsLabel = document.getElementById('noPendingRequestsLabel');
    selectFileBtn = document.getElementById('selectFileBtn');
    excelFileInput = document.getElementById('excelFileInput');
    uploadStatus = document.getElementById('uploadStatus');
    processUploadBtn = document.getElementById('processUploadBtn');
    backHomeFromUploadBtn = document.getElementById('backHomeFromUploadBtn');
    logoutBtnFromUpload = document.getElementById('logoutBtnFromUpload');
    selectFileBtnPublishers = document.getElementById('selectFileBtnPublishers');
    excelFileInputPublishers = document.getElementById('excelFileInputPublishers');
    uploadStatusPublishers = document.getElementById('uploadStatusPublishers');
    processUploadBtnPublishers = document.getElementById('processUploadBtnPublishers');
    backHomeFromUploadPublishersBtn = document.getElementById('backHomeFromUploadPublishersBtn');
    logoutBtnFromUploadPublishers = document.getElementById('logoutBtnFromUploadPublishers');
    searchPublisherAux = document.getElementById('searchPublisherAux');
    suggestionBoxAux = document.getElementById('suggestionBoxAux');
    publisherNameDropdownAux = document.getElementById('publisherNameDropdownAux');
    fieldGroupAux = document.getElementById('fieldGroupAux');
    privilege2Aux = document.getElementById('privilege2Aux');
    serviceYearDropdownAux = document.getElementById('serviceYearDropdownAux');
    monthYearDropdownAux = document.getElementById('monthYearDropdownAux');
    isAuxiliaryPioneerThisMonthAux = document.getElementById('isAuxiliaryPioneerThisMonthAux');
    addAuxStatusBtn = document.getElementById('addAuxStatusBtn');
    updateAuxStatusBtn = document.getElementById('updateAuxStatusBtn');
    previousAuxStatusBtn = document.getElementById('previousAuxStatusBtn');
    nextAuxStatusBtn = document.getElementById('nextAuxStatusBtn');
    clearAuxFormBtn = document.getElementById('clearAuxFormBtn');
    backHomeFromAuxBtn = document.getElementById('backHomeFromAuxBtn');
    lastModifiedByAux = document.getElementById('lastModifiedByAux');
    summaryReportPage = document.getElementById('summaryReportPage');
    serviceYearSummary = document.getElementById('serviceYearSummary');
    monthSummary = document.getElementById('monthSummary');
    generateSummaryBtn = document.getElementById('generateSummaryBtn');
    summaryResults = document.getElementById('summaryResults');
    backHomeFromSummaryBtn = document.getElementById('backHomeFromSummaryBtn');
    clearSummaryBtn = document.getElementById('clearSummaryBtn');
    publisherStatus = document.getElementById('publisherStatus');
transferDateContainer = document.getElementById('transferDateContainer');
transferYear = document.getElementById('transferYear');
transferMonth = document.getElementById('transferMonth');
deathDateContainer = document.getElementById('deathDateContainer');
deathYear = document.getElementById('deathYear');
deathMonth = document.getElementById('deathMonth');
    consolidateYearReport = document.getElementById('consolidateYearReport');
consolidateMonthReport = document.getElementById('consolidateMonthReport');
consolidateYearUpdate = document.getElementById('consolidateYearUpdate');
consolidateMonthUpdate = document.getElementById('consolidateMonthUpdate');
consolidateYearRequest = document.getElementById('consolidateYearRequest');
consolidateMonthRequest = document.getElementById('consolidateMonthRequest');
        }
    function toggleStatusDateFields() {
    const status = publisherStatus.value;
    transferDateContainer.classList.add('hidden');
    deathDateContainer.classList.add('hidden');
    transferYear.value = '';
    transferMonth.innerHTML = '<option value="">-- Select --</option>';
    deathYear.value = '';
    deathMonth.innerHTML = '<option value="">-- Select --</option>';

    if (status === 'Transferred') {
        transferDateContainer.classList.remove('hidden');
        populateServiceYears(transferYear);
    } else if (status === 'Dead') {
        deathDateContainer.classList.remove('hidden');
        populateServiceYears(deathYear);
    }
}
    function attachAllListeners() {
    document.getElementById("loginBtn")?.addEventListener("click", login);
    document.getElementById("logoutBtn")?.addEventListener("click", logout);
    document.getElementById("managePublisherBtn")?.addEventListener("click", () => showPage('publisherPage'));
    document.getElementById("manageAuxiliaryPioneerBtn")?.addEventListener("click", () => showPage('manageAuxiliaryPage'));
    document.getElementById("addReportBtnAdmin")?.addEventListener("click", () => showPage('addReportPage'));
    document.getElementById("updateReportPageBtn")?.addEventListener("click", () => showPage('updateReportPage'));
    document.getElementById("reviewApprovalsBtn")?.addEventListener("click", () => showPage('reviewApprovalsPage'));
    document.getElementById("viewSummaryBtn")?.addEventListener("click", () => showPage('summaryReportPage'));
    document.getElementById("exportExcelBtn")?.addEventListener("click", exportToExcel);
    document.getElementById("uploadReportsBtn")?.addEventListener("click", () => promptForAdminPassword(() => showPage('uploadPage')));
    document.getElementById("uploadPublishersBtn")?.addEventListener("click", () => promptForAdminPassword(() => showPage('uploadPublishersPage')));
    document.getElementById("clearAllDataBtn")?.addEventListener("click", () => promptForAdminPassword(clearAllData));
    document.getElementById("addReportBtnUser")?.addEventListener("click", () => showPage('addReportPage'));
    document.getElementById("submitRequestPageBtn")?.addEventListener("click", () => showPage('submitRequestPage'));
    document.getElementById("backHomeFromReportBtn")?.addEventListener("click", () => showPage('homePage'));
    document.getElementById("backHomeFromPublisherBtn")?.addEventListener("click", () => showPage('homePage'));
    document.getElementById("backHomeFromUpdateBtn")?.addEventListener("click", () => showPage('homePage'));
    document.getElementById("backHomeFromRequestBtn")?.addEventListener("click", () => showPage('homePage'));
    document.getElementById("backHomeFromReviewBtn")?.addEventListener('click', () => showPage('homePage'));
    document.getElementById("backHomeFromUploadBtn")?.addEventListener('click', () => showPage('homePage'));
    document.getElementById("backHomeFromUploadPublishersBtn")?.addEventListener('click', () => showPage('homePage'));
    backHomeFromAuxBtn?.addEventListener("click", () => showPage('homePage'));
    backHomeFromSummaryBtn?.addEventListener("click", () => showPage('homePage'));
    document.getElementById("saveReportBtn")?.addEventListener("click", saveReport);
    document.getElementById("clearReportBtn")?.addEventListener("click", clearAddReportForm);
    logoutBtnFromReport?.addEventListener("click", logout);
    addPublisherBtn?.addEventListener("click", addPublisher);
    updatePublisherBtn?.addEventListener("click", updatePublisher);
    deletePublisherBtn?.addEventListener("click", deletePublisher);
    previousPublisherBtn?.addEventListener("click", previousPublisher);
    nextPublisherBtn?.addEventListener("click", nextPublisher);
    clearPublisherFormBtn?.addEventListener("click", clearPublisherForm);
    logoutBtnFromPublisher?.addEventListener("click", logout);
    firstNameInput?.addEventListener("input", updateFullName);
    lastNameInput?.addEventListener("input", updateFullName);
    baptismStatusDropdown?.addEventListener("change", toggleBaptismDate);
    updateReportBtn?.addEventListener("click", updateReport);
    deleteReportBtn?.addEventListener("click", deleteReport);
    clearUpdateFormBtn?.addEventListener("click", clearUpdateFormBtn);
    logoutBtnFromUpdate?.addEventListener("click", logout);
    submitRequestApprovalBtn?.addEventListener('click', submitRequestForApproval);
    clearRequestFormBtn?.addEventListener('click', clearSubmitRequestForm);
    logoutBtnFromRequest?.addEventListener('click', logout);
    document.getElementById("logoutBtnFromReview")?.addEventListener("click", logout);
    selectFileBtn?.addEventListener('click', () => excelFileInput.click());
    excelFileInput?.addEventListener('change', handleFileSelect);
    processUploadBtn?.addEventListener('click', processAndUploadRecords);
    logoutBtnFromUpload?.addEventListener('click', logout);
    selectFileBtnPublishers?.addEventListener('click', () => excelFileInputPublishers.click());
    excelFileInputPublishers?.addEventListener('change', handlePublisherFileSelect);
    processUploadBtnPublishers?.addEventListener('click', processAndUploadPublishers);
    logoutBtnFromUploadPublishers?.addEventListener('click', logout);
    addAuxStatusBtn?.addEventListener("click", addAuxiliaryStatus);
    updateAuxStatusBtn?.addEventListener("click", updateAuxiliaryStatus);
    previousAuxStatusBtn?.addEventListener("click", previousAuxStatus);
    nextAuxStatusBtn?.addEventListener("click", nextAuxStatus);
    clearAuxFormBtn?.addEventListener("click", clearManageAuxiliaryForm);
    generateSummaryBtn?.addEventListener("click", generateSummaryReport);
    publisherStatus?.addEventListener('change', toggleStatusDateFields);
    transferYear?.addEventListener('change', () => populateMonths(transferMonth, transferYear.value));
    deathYear?.addEventListener('change', () => populateMonths(deathMonth, deathYear.value));
}
        function showPage(pageId) {
    document.querySelectorAll('.page-container').forEach(page => page.classList.add('hidden'));
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.remove('hidden');
    }
    if (pageId === 'homePage') { updateHomePage(); } 
    else if (pageId === 'addReportPage') { setupAddReportPage(); } 
    else if (pageId === 'publisherPage') { setupManagePublisherPage(); } 
    else if (pageId === 'updateReportPage') { setupUpdateReportPage(); }
    else if (pageId === 'submitRequestPage') { setupSubmitRequestPage(); }
    else if (pageId === 'reviewApprovalsPage') { setupReviewApprovalsPage(); }
    else if (pageId === 'uploadPage') { setupUploadPage(); }
    else if (pageId === 'uploadPublishersPage') { setupUploadPublishersPage(); }
    else if (pageId === 'manageAuxiliaryPage') { setupManageAuxiliaryPage(); }
    else if (pageId === 'summaryReportPage') { setupSummaryReportPage(); }
}
    function handleRouteChange() {
    if (!currentUser) {
        showPage('loginPage');
        return;
    }
    const path = window.location.pathname;
    const isAdminOrAssistant = currentUser.role === 'admin' || currentUser.role === 'assistant_admin';

    switch (path) {
        case '/': 
        case '/home': 
            showPage('homePage'); 
            break;
        case '/add-report': 
            showPage('addReportPage'); 
            break;
        case '/submit-request': 
            showPage('submitRequestPage'); 
            break;
        case '/manage-publisher':
        case '/update-report':
        case '/review-approvals':
        case '/manage-auxiliary':
        case '/view-summary':
            if (isAdminOrAssistant) {
                showPage(path.substring(1).replace('-', '') + 'Page');
            } else {
                alert("Access denied.");
                showPage('homePage');
            }
            break;
        case '/upload-reports':
        case '/upload-publishers':
            if (currentUser.role === 'admin') {
                showPage(path.substring(1).replace('-', '') + 'Page');
            } else {
                alert("Access denied.");
                showPage('homePage');
            }
            break;
        default: 
            showPage('homePage'); 
            break;
    }
}
    async function login() {
        const email = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) {
            alert("Please enter both email and password.");
            return;
        }
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error("Login failed:", error);
            alert("Invalid email or password.");
        }
    }
    async function logout() {
        try {
            await auth.signOut();
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showPage('loginPage');
        } catch (error) {
            console.error("Logout failed:", error);
        }
    }
    async function fetchAdminPassword() {
        if (adminPassword) return;
        try {
            const doc = await db.collection("config").doc("admin_settings").get();
            if (doc.exists) {
                adminPassword = doc.data().adminPassword;
            } else {
                console.warn("Admin password not set in Firestore.");
            }
        } catch (error) {
            console.error("Error fetching admin password:", error);
        }
    }
    async function promptForAdminPassword(callbackFunction) {
        if (currentUser?.role !== 'admin') {
            alert("This action is for admins only.");
            return;
        }
        await fetchAdminPassword();
        if (!adminPassword) {
            alert("Admin password configuration is missing. Please set it up in Firebase Firestore.");
            return;
        }
        const input = prompt("This is a sensitive action. Please enter the admin password to proceed:");
        if (input === null) return;
        if (input === adminPassword) {
            callbackFunction();
        } else {
            alert("Incorrect password. Action cancelled.");
        }
    }
    async function clearAllData() {
        if (confirm("Are you sure you want to delete ALL data? This cannot be undone.")) {
            try {
                const publishers = await db.collection("publishers").get();
                const reports = await db.collection("reports").get();
                const batch = db.batch();
                publishers.forEach(doc => batch.delete(doc.ref));
                reports.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                alert("All publisher and report records deleted.");
                publisherList = [];
                clearPublisherForm();
                clearAddReportForm();
                clearUpdateReportForm();
            } catch (error) { console.error("Error clearing data:", error); alert("Failed to clear data."); }
        }
    }
    async function exportToExcel() {
        try {
            const snapshot = await db.collection("reports").orderBy("publisherFullName", "asc").get();
            if (snapshot.empty) {
                alert("No reports found to export.");
                return;
            }
            const reports = snapshot.docs.map(doc => doc.data());
            const headers = [ "Publisher Name", "Service Year", "Month", "Field Service Group", "Privilege at Time of Report", "Hours", "Bible Studies", "Shared in Ministry", "Was Auxiliary Pioneer", "Comments", "Last Modified By" ];
            let csvContent = headers.join(",") + "\n";
            reports.forEach(report => {
                const comments = report.comments ? report.comments.replace(/"/g, '""') : '';
                const row = [ 
                    `"\u200B${report.publisherFullName || ''}"`, 
                    `"\u200B${report.serviceYear || ''}"`, 
                    `"\u200B${report.month || ''}"`, 
                    `"\u200B${report.fieldServiceGroup || ''}"`, 
                    `"\u200B${report.privilege2AtTimeOfReport || ''}"`, 
                    report.hours || 0, 
                    report.bibleStudies || 0, 
                    report.sharedInMinistry ? 'Yes' : 'No', 
                    report.wasAuxiliaryPioneer ? 'Yes' : 'No',
                    `"${comments}"`,
                    `"\u200B${report.lastModifiedBy || ''}"`
                ];
                csvContent += row.join(",") + "\n";
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const dateStr = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `Field_Service_Reports_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("Error exporting to Excel:", error);
            alert("An error occurred during export. Please check the console.");
        }
    }
    async function updateHomePage() {
    if (currentUser) {
        loggedInUser.textContent = currentUser.email;

        adminButtons.classList.add('hidden');
        userButtons.classList.add('hidden');
        adminSection.classList.add('hidden');
        
        document.getElementById('uploadReportsBtn').style.display = 'none';
        document.getElementById('uploadPublishersBtn').style.display = 'none';

        if (currentUser.role === 'admin' || currentUser.role === 'assistant_admin') {
            adminButtons.classList.remove('hidden');

            const reviewApprovalsBtn = document.getElementById('reviewApprovalsBtn');
            try {
                const snapshot = await db.collection('updateRequests').where('status', '==', 'pending').get();
                const count = snapshot.size;
                reviewApprovalsBtn.textContent = `Review Approvals ${count > 0 ? `(${count})` : ''}`;
            } catch(e) {
                console.error("Could not fetch request count", e);
                reviewApprovalsBtn.textContent = "Review Approvals";
            }
        }

        if (currentUser.role === 'admin') {
            document.getElementById('uploadReportsBtn').style.display = '';
            document.getElementById('uploadPublishersBtn').style.display = '';
            adminSection.classList.remove('hidden');
            fetchAdminPassword();
        } else if (currentUser.role === 'user') {
            userButtons.classList.remove('hidden');
        }
    }
}
        async function loadPublishers() {
        try {
            const snapshot = await db.collection("publishers").orderBy("fullName", "asc").get();
            publisherList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) { console.error("Error loading publishers:", error); }
    }
    async function loadAuxStatuses() {
        try {
            const snapshot = await db.collection("auxiliary_status").orderBy("publisherFullName").orderBy("serviceYear").orderBy("month").get();
            auxStatusList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) { console.error("Error loading auxiliary statuses:", error); }
    }
    function setupManageAuxiliaryPage() {
        clearManageAuxiliaryForm();
        publisherNameDropdownAux.innerHTML = '<option value="">-- Select Publisher --</option>';
        const auxiPublishers = publisherList.filter(p => p.privilege2 === 'Publisher/Auxi');
        auxiPublishers.forEach(pub => {
            const opt = document.createElement("option");
            opt.value = pub.id;
            opt.textContent = pub.fullName;
            publisherNameDropdownAux.appendChild(opt);
        });
        populateServiceYears(serviceYearDropdownAux);
        populateMonths(monthYearDropdownAux, serviceYearDropdownAux.value);
        const handlePublisherSelection = () => {
            const selected = publisherList.find(p => p.id === publisherNameDropdownAux.value);
            if(selected) {
                fieldGroupAux.value = selected.fieldServiceGroup || '';
                privilege2Aux.value = selected.privilege2 || '';
            } else {
                fieldGroupAux.value = '';
                privilege2Aux.value = '';
            }
            fetchAndDisplayAuxStatus();
        };
        publisherNameDropdownAux.addEventListener('change', handlePublisherSelection);
        serviceYearDropdownAux.addEventListener('change', () => {
            populateMonths(monthYearDropdownAux, serviceYearDropdownAux.value);
            fetchAndDisplayAuxStatus();
        });
        monthYearDropdownAux.addEventListener('change', fetchAndDisplayAuxStatus);
        searchPublisherAux.addEventListener("input", function () {
            const query = this.value.toLowerCase();
            suggestionBoxAux.innerHTML = "";
            if (!query) return;
            const matches = auxiPublishers.filter(pub => pub.fullName.toLowerCase().includes(query));
            matches.forEach(pub => {
                const div = document.createElement("div");
                div.textContent = pub.fullName;
                div.classList.add("suggestion-item");
                div.addEventListener("click", () => {
                    this.value = pub.fullName;
                    suggestionBoxAux.innerHTML = "";
                    publisherNameDropdownAux.value = pub.id;
                    publisherNameDropdownAux.dispatchEvent(new Event('change'));
                });
                suggestionBoxAux.appendChild(div);
            });
        });
        if (auxStatusList.length > 0) {
            updateAuxStatusBtn.disabled = false;
            previousAuxStatusBtn.disabled = false;
            nextAuxStatusBtn.disabled = false;
        } else {
            updateAuxStatusBtn.disabled = true;
            previousAuxStatusBtn.disabled = true;
            nextAuxStatusBtn.disabled = true;
        }
    }
    function clearManageAuxiliaryForm() {
        publisherNameDropdownAux.value = "";
        serviceYearDropdownAux.value = "";
        monthYearDropdownAux.innerHTML = '<option value="">-- Select Month --</option>';
        searchPublisherAux.value = "";
        fieldGroupAux.value = "";
        privilege2Aux.value = "";
        isAuxiliaryPioneerThisMonthAux.value = "No";
        lastModifiedByAux.textContent = "";
        suggestionBoxAux.innerHTML = "";
        currentAuxStatusIndex = -1;
    }
    async function fetchAndDisplayAuxStatus() {
        const publisherId = publisherNameDropdownAux.value;
        const serviceYear = serviceYearDropdownAux.value;
        const month = monthYearDropdownAux.value;
        isAuxiliaryPioneerThisMonthAux.value = "No";
        lastModifiedByAux.textContent = "";
        if (!publisherId || !serviceYear || !month) {
            return;
        }
        const docId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
        try {
            const docSnap = await db.collection("auxiliary_status").doc(docId).get();
            if (docSnap.exists) {
                const data = docSnap.data();
                isAuxiliaryPioneerThisMonthAux.value = data.isAuxiliary ? "Yes" : "No";
                lastModifiedByAux.textContent = data.lastModifiedBy ? `Last set by: ${data.lastModifiedBy}` : '';
                const recordIndex = auxStatusList.findIndex(item => item.id === docId);
                if (recordIndex !== -1) {
                    currentAuxStatusIndex = recordIndex;
                } else {
                    currentAuxStatusIndex = -1;
                }
            } else {
                isAuxiliaryPioneerThisMonthAux.value = "No";
                lastModifiedByAux.textContent = "No status set for this period.";
                currentAuxStatusIndex = -1;
            }
        } catch (e) {
            console.error("Error fetching status", e);
            isAuxiliaryPioneerThisMonthAux.value = "No";
            lastModifiedByAux.textContent = "Error fetching status.";
        }
    }
    function displayAuxStatus(index) {
        const status = auxStatusList[index];
        if (!status) return;
        publisherNameDropdownAux.value = status.publisherId || "";
        const selected = publisherList.find(p => p.id === status.publisherId);
        if(selected) {
            fieldGroupAux.value = selected.fieldServiceGroup || '';
            privilege2Aux.value = selected.privilege2 || '';
        }
        serviceYearDropdownAux.value = status.serviceYear || "";
        populateMonths(monthYearDropdownAux, status.serviceYear);
        monthYearDropdownAux.value = status.month || "";
        isAuxiliaryPioneerThisMonthAux.value = status.isAuxiliary ? "Yes" : "No";
        lastModifiedByAux.textContent = status.lastModifiedBy ? `Last set by: ${status.lastModifiedBy}` : '';
        currentAuxStatusIndex = index;
    }
    function previousAuxStatus() {
        if (auxStatusList.length === 0) return;
        if (currentAuxStatusIndex > 0) {
            currentAuxStatusIndex--;
            displayAuxStatus(currentAuxStatusIndex);
        } else {
            alert("This is the first record.");
        }
    }
    function nextAuxStatus() {
        if (auxStatusList.length === 0) return;
        if (currentAuxStatusIndex < auxStatusList.length - 1) {
            currentAuxStatusIndex++;
            displayAuxStatus(currentAuxStatusIndex);
        } else {
            alert("This is the last record.");
        }
    }
    async function addAuxiliaryStatus() {
        const publisherId = publisherNameDropdownAux.value;
        const serviceYear = serviceYearDropdownAux.value;
        const month = monthYearDropdownAux.value;
        const status = isAuxiliaryPioneerThisMonthAux.value;
        if (!publisherId || !serviceYear || !month) {
            alert("Please complete all publisher, year, and month fields before adding.");
            return;
        }
        const docId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
        const docRef = db.collection("auxiliary_status").doc(docId);
        try {
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                alert("Error: A status for this publisher and month already exists. Use the navigation buttons to find and update it.");
                return;
            }
            const publisherFullName = publisherNameDropdownAux.options[publisherNameDropdownAux.selectedIndex].text;
            const statusData = {
                publisherId, publisherFullName, serviceYear, month,
                isAuxiliary: status === "Yes",
                lastModifiedBy: currentUser.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await docRef.set(statusData);
            alert(`Status for ${publisherFullName} for ${month} has been added as '${status}'.`);
            await loadAuxStatuses();
            const newIndex = auxStatusList.findIndex(item => item.id === docId);
            if (newIndex !== -1) displayAuxStatus(newIndex);
        } catch (error) {
            console.error("Error adding auxiliary status: ", error);
            alert("An error occurred while adding the status.");
        }
    }
    async function updateAuxiliaryStatus() {
        if (currentAuxStatusIndex < 0) {
            alert("Please select a record to update using the navigation buttons first.");
            return;
        }
        const record = auxStatusList[currentAuxStatusIndex];
        const docId = record.id;
        const status = isAuxiliaryPioneerThisMonthAux.value;
        const updatedData = {
            isAuxiliary: status === "Yes",
            lastModifiedBy: currentUser.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection("auxiliary_status").doc(docId).update(updatedData);
            alert(`Status for ${record.publisherFullName} for ${record.month} has been updated to '${status}'.`);
            await loadAuxStatuses();
            displayAuxStatus(currentAuxStatusIndex);
        } catch (error) {
            console.error("Error updating auxiliary status: ", error);
            alert("An error occurred while updating the status.");
        }
    }
        async function handleReportFieldLogic(elements, publisherId, serviceYear, month) {
    elements.fieldHoursContainer.classList.add("hidden");
    elements.bibleStudiesContainer.classList.add("hidden");
    elements.sharedMinistryContainer.classList.add("hidden");
    elements.auxiliaryPioneerCheckboxContainer.classList.add("hidden");
    elements.fieldHoursInput.value = "";
    elements.bibleStudiesInput.value = "";
    elements.sharedMinistryCheckbox.checked = false;
    elements.auxiliaryPioneerCheckbox.checked = false;
    elements.sharedMinistryCheckbox.disabled = false;
    elements.auxiliaryPioneerCheckbox.disabled = false;

    const handleHoursInput_Standard = () => {
        let value = elements.fieldHoursInput.value.replace(/\D/g, '');
        if (value && parseInt(value, 10) === 0) { value = ''; }
        elements.fieldHoursInput.value = value;
        elements.sharedMinistryCheckbox.checked = parseInt(value, 10) > 0;
    };

    const handleHoursInput_WithAux = () => {
        let value = elements.fieldHoursInput.value.replace(/\D/g, '');
        if (value && parseInt(value, 10) === 0) { value = ''; }
        elements.fieldHoursInput.value = value;
        const hasHours = parseInt(value, 10) > 0;
        elements.sharedMinistryCheckbox.checked = hasHours;
        elements.auxiliaryPioneerCheckbox.checked = hasHours;
    };

    const handleStudiesInput = () => { elements.bibleStudiesInput.value = elements.bibleStudiesInput.value.replace(/\D/g, ''); };
    
    elements.fieldHoursInput.oninput = null;
    elements.bibleStudiesInput.oninput = null;

    const privilege2 = elements.privilegeInput.value;
    switch (privilege2) {
        case "Regular Pioneer":
        case "Special Pioneer":
        case "Field Missionary":
            elements.fieldHoursContainer.classList.remove("hidden");
            elements.bibleStudiesContainer.classList.remove("hidden");
            elements.sharedMinistryContainer.classList.remove("hidden");
            elements.sharedMinistryCheckbox.disabled = true;
            elements.fieldHoursInput.oninput = handleHoursInput_Standard; 
            elements.bibleStudiesInput.oninput = handleStudiesInput;
            break;
        case "Continuous Auxiliary Pioneer":
            elements.fieldHoursContainer.classList.remove("hidden");
            elements.bibleStudiesContainer.classList.remove("hidden");
            elements.sharedMinistryContainer.classList.remove("hidden");
            elements.auxiliaryPioneerCheckboxContainer.classList.remove("hidden");
            elements.sharedMinistryCheckbox.disabled = true;
            elements.auxiliaryPioneerCheckbox.disabled = true;
            elements.fieldHoursInput.oninput = handleHoursInput_WithAux;
            elements.bibleStudiesInput.oninput = handleStudiesInput;
            break;
        case "Publisher/Auxi":
            let isAux = false;
            if (publisherId && serviceYear && month) {
                const docId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
                const auxStatusRef = db.collection("auxiliary_status").doc(docId);
                try {
                    const docSnap = await auxStatusRef.get();
                    if (docSnap.exists && docSnap.data().isAuxiliary) {
                        isAux = true;
                    }
                } catch (e) { console.error("Error fetching aux status", e); }
            }
            if (isAux) {
                elements.fieldHoursContainer.classList.remove("hidden");
                elements.bibleStudiesContainer.classList.remove("hidden");
                elements.sharedMinistryContainer.classList.remove("hidden");
                elements.auxiliaryPioneerCheckboxContainer.classList.remove("hidden");
                elements.sharedMinistryCheckbox.disabled = true;
                elements.auxiliaryPioneerCheckbox.disabled = true;
                elements.fieldHoursInput.oninput = handleHoursInput_WithAux;
                elements.bibleStudiesInput.oninput = handleStudiesInput;
            } else {
                elements.bibleStudiesContainer.classList.remove("hidden");
                elements.sharedMinistryContainer.classList.remove("hidden");
                elements.sharedMinistryCheckbox.disabled = false;
                elements.bibleStudiesInput.oninput = handleStudiesInput;
            }
            break;
    }
}
    function setupManagePublisherPage() {
        clearPublisherForm();
        searchInputManage.addEventListener("input", function () {
            const query = this.value.toLowerCase();
            suggestionBoxManage.innerHTML = "";
            if (!query) return;
            const matches = publisherList.filter(pub => pub.fullName.toLowerCase().includes(query));
            matches.forEach((pub) => {
                const div = document.createElement("div");
                div.textContent = pub.fullName;
                div.classList.add("suggestion-item");
                div.addEventListener("click", () => {
                    this.value = "";
                    suggestionBoxManage.innerHTML = "";
                    currentIndex = publisherList.findIndex(p => p.id === pub.id);
                    if (currentIndex !== -1) displayPublisher(currentIndex);
                });
                suggestionBoxManage.appendChild(div);
            });
        });
    }
    function updateFullName() { 
        if (!firstNameInput || !lastNameInput || !fullNameInput) return;
        fullNameInput.value = (lastNameInput.value.trim() && firstNameInput.value.trim()) ? `${lastNameInput.value.trim()}, ${firstNameInput.value.trim()}` : ""; 
    }
    function toggleBaptismDate() { 
        if (!baptismStatusDropdown || !baptismDateContainer || !baptismDateInput) return;
        baptismDateContainer.classList.toggle("hidden", baptismStatusDropdown.value !== "Baptized"); 
        if (baptismStatusDropdown.value !== "Baptized") baptismDateInput.value = ""; 
    }
    async function addPublisher() {
        if (!firstNameInput.value.trim() || !lastNameInput.value.trim() || !publisherStatus.value) {
            alert("Please complete First Name, Last Name, and Publisher Status."); return;
        }
        const status = publisherStatus.value;
        if ((status === 'Transferred' && (!transferYear.value || !transferMonth.value)) || (status === 'Dead' && (!deathYear.value || !deathMonth.value))) {
            alert("Please select the month and year for the selected status."); return;
        }

        const docId = `${lastNameInput.value.trim()}_${firstNameInput.value.trim()}_${birthdateInput.value}`.replace(/\s+/g, "_");
        try {
            const existingDoc = await db.collection("publishers").doc(docId).get();
            if (existingDoc.exists) { alert("A publisher with the same last name, first name, and birthdate already exists."); return; }
            
            const publisherData = {
                firstName: firstNameInput.value.trim(),
                lastName: lastNameInput.value.trim(),
                fullName: `${lastNameInput.value.trim()}, ${firstNameInput.value.trim()}`,
                publisherStatus: publisherStatus.value,
                monthOfTransfer: status === 'Transferred' ? `${transferMonth.value} ${transferYear.value}` : '',
                monthOfDeath: status === 'Dead' ? `${deathMonth.value} ${deathYear.value}` : '',
                birthdate: birthdateInput.value,
                baptismStatus: baptismStatusDropdown.value,
                baptismDate: baptismStatusDropdown.value === "Baptized" ? baptismDateInput.value : "",
                gender: genderDropdown.value,
                hope: hopeDropdown.value,
                privilege: privilegeDropdown.value,
                privilege2: privilege2Dropdown.value,
                fieldServiceGroup: fieldServiceGroupDropdown.value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection("publishers").doc(docId).set(publisherData);
            alert("Publisher record successfully added!");
            await loadPublishers();
            clearPublisherForm();
        } catch (error) { console.error("Error adding publisher:", error); alert("Failed to add publisher record."); }
    }
    async function updatePublisher() {
    if (!currentDocId) { 
        alert("Please select a publisher to update."); 
        return; 
    }
    if (!firstNameInput.value.trim() || !lastNameInput.value.trim() || !publisherStatus.value) {
        alert("Please complete First Name, Last Name, and Publisher Status."); 
        return;
    }
    const status = publisherStatus.value;
    if ((status === 'Transferred' && (!transferYear.value || !transferMonth.value)) || (status === 'Dead' && (!deathYear.value || !deathMonth.value))) {
        alert("Please select the month and year for the selected status."); 
        return;
    }
    if (!confirm("Are you sure you want to update this publisher? This will also update their name on all past reports.")) {
        return;
    }

    const oldPublisherData = publisherList.find(p => p.id === currentDocId);
    const oldFullName = oldPublisherData ? oldPublisherData.fullName : '';
    const newFullName = `${lastNameInput.value.trim()}, ${firstNameInput.value.trim()}`;

    const updatedData = {
        firstName: firstNameInput.value.trim(),
        lastName: lastNameInput.value.trim(),
        fullName: newFullName,
        publisherStatus: publisherStatus.value,
        monthOfTransfer: status === 'Transferred' ? transferMonth.value : '',
        monthOfDeath: status === 'Dead' ? deathMonth.value : '',
        birthdate: birthdateInput.value,
        baptismStatus: baptismStatusDropdown.value,
        baptismDate: baptismStatusDropdown.value === "Baptized" ? baptismDateInput.value : "",
        gender: genderDropdown.value,
        hope: hopeDropdown.value,
        privilege: privilegeDropdown.value,
        privilege2: privilege2Dropdown.value,
        fieldServiceGroup: fieldServiceGroupDropdown.value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        const batch = db.batch();
        const publisherRef = db.collection("publishers").doc(currentDocId);
        batch.update(publisherRef, updatedData);

        if (oldFullName !== newFullName && newFullName.trim() !== '') {
            const reportsQuery = db.collection("reports").where("publisherId", "==", currentDocId);
            const reportsSnapshot = await reportsQuery.get();
            
            if (!reportsSnapshot.empty) {
                reportsSnapshot.forEach(doc => {
                    batch.update(doc.ref, { publisherFullName: newFullName });
                });
            }
        }

        await batch.commit();
        
        alert("Publisher record and all associated reports updated successfully!");
        
        await loadPublishers();
        
        const updatedIndex = publisherList.findIndex(p => p.id === currentDocId);
        if (updatedIndex !== -1) {
            displayPublisher(updatedIndex);
        } else {
            clearPublisherForm();
        }

    } catch (error) {
        console.error("Error updating publisher and reports:", error);
        alert("Failed to update publisher record and reports.");
    }
}
    async function deletePublisher() {
        if (!currentDocId) { alert("Please select a publisher to delete."); return; }
        if (!confirm("Are you sure you want to permanently delete this publisher record? This action cannot be undone.")) return;
        try {
            await db.collection("publishers").doc(currentDocId).delete();
            alert("Publisher record deleted successfully!");
            await loadPublishers();
            clearPublisherForm();
        } catch (error) { console.error("Error deleting publisher:", error); alert("Failed to delete publisher record."); }
    }
    function previousPublisher() { 
        if (publisherList.length === 0) return;
        if (currentIndex > 0) { 
            currentIndex--; 
            displayPublisher(currentIndex); 
        } else { 
            alert("This is the first record."); 
        } 
    }
    function nextPublisher() { 
        if (publisherList.length === 0) return;
        if (currentIndex < publisherList.length - 1) { 
            currentIndex++; 
            displayPublisher(currentIndex); 
        } else { 
            alert("This is the last record."); 
        } 
    }
    function clearPublisherForm() {
        const inputs = [firstNameInput, lastNameInput, fullNameInput, birthdateInput, baptismDateInput, searchInputManage];
        const selects = [baptismStatusDropdown, genderDropdown, hopeDropdown, privilegeDropdown, privilege2Dropdown, fieldServiceGroupDropdown, publisherStatus, transferYear, transferMonth, deathYear, deathMonth];
        inputs.forEach(i => i && (i.value = ''));
        selects.forEach(s => s && (s.value = ''));
        baptismDateContainer?.classList.add("hidden");
        transferDateContainer?.classList.add("hidden");
        deathDateContainer?.classList.add("hidden");
        suggestionBoxManage && (suggestionBoxManage.innerHTML = "");
        currentIndex = -1;
        currentDocId = null;
    }
    function displayPublisher(index) {
        const pub = publisherList[index];
        if (!pub) { clearPublisherForm(); return; }
        currentIndex = index;
        currentDocId = pub.id;
        firstNameInput.value = pub.firstName || "";
        lastNameInput.value = pub.lastName || "";
        fullNameInput.value = pub.fullName || "";
        publisherStatus.value = pub.publisherStatus || "In the Congregation";
        birthdateInput.value = pub.birthdate || "";
        baptismStatusDropdown.value = pub.baptismStatus || "";
        toggleBaptismDate();
        if (pub.baptismStatus === "Baptized") { baptismDateInput.value = pub.baptismDate || ""; }
        genderDropdown.value = pub.gender || "";
        hopeDropdown.value = pub.hope || "";
        privilegeDropdown.value = pub.privilege || "";
        privilege2Dropdown.value = pub.privilege2 || "";
        fieldServiceGroupDropdown.value = pub.fieldServiceGroup || "";

        toggleStatusDateFields();

        if (pub.monthOfTransfer) {
            const [transferM, transferY] = pub.monthOfTransfer.split(' ');
            transferYear.value = transferY;
            populateMonths(transferMonth, transferY);
            transferMonth.value = pub.monthOfTransfer;
        }
        if (pub.monthOfDeath) {
            const [deathM, deathY] = pub.monthOfDeath.split(' ');
            deathYear.value = deathY;
            populateMonths(deathMonth, deathY);
            deathMonth.value = pub.monthOfDeath;
        }
    }
        function setupUpdateReportPage() {
    clearUpdateReportForm(); 
    publisherNameDropdownUpdate.innerHTML = '<option value="">-- Select Publisher --</option>';
    publisherList.forEach(pub => {
        const opt = document.createElement("option");
        opt.value = pub.id;
        opt.textContent = pub.fullName;
        publisherNameDropdownUpdate.appendChild(opt);
    });
    populateServiceYears(serviceYearDropdownUpdate);
    populateServiceYears(consolidateYearUpdate);

    consolidateYearUpdate.addEventListener('change', () => populateMonths(consolidateMonthUpdate, consolidateYearUpdate.value));
    
    searchPublisherUpdate.addEventListener("input", function () {
        const query = this.value.toLowerCase();
        suggestionBoxUpdate.innerHTML = "";
        if (!query) return;
        const matches = publisherList.filter(pub => pub.fullName.toLowerCase().includes(query));
        matches.forEach(pub => {
            const div = document.createElement("div");
            div.textContent = pub.fullName;
            div.classList.add("suggestion-item");
            div.addEventListener("click", () => {
                this.value = pub.fullName;
                suggestionBoxUpdate.innerHTML = "";
                publisherNameDropdownUpdate.value = pub.id;
                publisherNameDropdownUpdate.dispatchEvent(new Event('change'));
            });
            suggestionBoxUpdate.appendChild(div);
        });
    });
    const handlePublisherSelection = async () => {
        const selectedPublisher = publisherList.find(p => p.id === publisherNameDropdownUpdate.value);
        if(selectedPublisher) {
            fieldGroupUpdate.value = selectedPublisher.fieldServiceGroup || '';
            privilege2Update.value = selectedPublisher.privilege2 || '';
        } else {
            fieldGroupUpdate.value = '';
            privilege2Update.value = '';
        }
        await fetchReportData();
    }
    publisherNameDropdownUpdate.addEventListener('change', handlePublisherSelection);
    serviceYearDropdownUpdate.addEventListener('change', async () => {
        populateMonths(monthYearDropdownUpdate, serviceYearDropdownUpdate.value);
        await fetchReportData();
    });
    monthYearDropdownUpdate.addEventListener('change', fetchReportData);
}
    async function fetchReportData() {
    const publisherId = publisherNameDropdownUpdate.value;
    const serviceYear = serviceYearDropdownUpdate.value;
    const month = monthYearDropdownUpdate.value;
    if (!publisherId || !serviceYear || !month) {
         clearUpdateReportForm(false);
         return;
    }
    const reportId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
    const reportRef = db.collection("reports").doc(reportId);
    try {
        const doc = await reportRef.get();
        if (doc.exists) {
            const data = doc.data();
            currentReportId = doc.id;
            
            const consolidationMonthStr = data.consolidateToMonth || data.month;
            const consolidationDate = parseMonthString(consolidationMonthStr);
            if (consolidationDate) {
                const consolidationMonthIndex = consolidationDate.getMonth();
                const consolidationCalendarYear = consolidationDate.getFullYear();

                let correctServiceYearForConsolidation = (consolidationMonthIndex >= 8) ? consolidationCalendarYear + 1 : consolidationCalendarYear;
                
                consolidateYearUpdate.value = correctServiceYearForConsolidation;
                populateMonths(consolidateMonthUpdate, correctServiceYearForConsolidation);
                consolidateMonthUpdate.value = consolidationMonthStr;
            }

            await updateReportFieldsVisibility_UpdatePage();
            updateReportFieldsDiv.style.display = 'block';
            fieldHoursUpdate.value = data.hours || '';
            bibleStudiesUpdate.value = data.bibleStudies || '';
            sharedMinistryUpdate.checked = data.sharedInMinistry || false;
            auxiliaryPioneerCheckboxUpdate.checked = data.wasAuxiliaryPioneer || false;
            commentsUpdate.value = data.comments || '';
            lastModifiedByUpdate.textContent = data.lastModifiedBy ? `Last modified by: ${data.lastModifiedBy}` : '';
        } else {
            alert("No report found for the selected publisher and period.");
            clearUpdateReportForm(false);
            currentReportId = null;
        }
    } catch (error) {
        console.error("Error fetching report data:", error);
        alert("An error occurred while fetching the report.");
        currentReportId = null;
    }
}
    async function updateReport() {
    if (!currentReportId) { alert("Error: No report is loaded to update."); return; }
    if (!consolidateYearUpdate.value || !consolidateMonthUpdate.value) {
        alert("Validation Error: 'Consolidate Report to' is a mandatory field.");
        return;
    }
    if (!confirm("Are you sure you want to update this record?")) return;
    
    let hoursVal = parseInt(fieldHoursUpdate.value) || 0;
    fieldHoursUpdate.value = hoursVal;
    let studiesVal = parseInt(bibleStudiesUpdate.value) || 0;
    bibleStudiesUpdate.value = studiesVal;
    
    const updatedData = {
        hours: hoursVal,
        bibleStudies: studiesVal,
        sharedInMinistry: sharedMinistryUpdate.checked,
        wasAuxiliaryPioneer: auxiliaryPioneerCheckboxUpdate.checked,
        comments: commentsUpdate.value,
        consolidateToMonth: consolidateMonthUpdate.value,
        lastModifiedBy: currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
        await db.collection("reports").doc(currentReportId).update(updatedData);
        alert("Report updated successfully!");
        clearUpdateReportForm();
    } catch (error) {
        console.error("Error updating report:", error);
        alert("Failed to update report.");
    }
}
    async function deleteReport() {
        if (!currentReportId) {
            alert("Error: No report is loaded to delete.");
            return;
        }
        if (!confirm("Are you sure you want to permanently delete this record? This action cannot be undone.")) return;
        try {
            await db.collection("reports").doc(currentReportId).delete();
            alert("Report deleted successfully!");
            clearUpdateReportForm();
        } catch (error) {
            console.error("Error deleting report:", error);
            alert("Failed to delete report.");
        }
    }
    function clearUpdateReportForm(clearAll = true) {
    if (clearAll) {
        publisherNameDropdownUpdate.value = "";
        serviceYearDropdownUpdate.value = "";
        monthYearDropdownUpdate.innerHTML = '<option value="">-- Select Month --</option>';
        searchPublisherUpdate.value = "";
        fieldGroupUpdate.value = "";
        privilege2Update.value = "";
        consolidateYearUpdate.value = "";
        consolidateMonthUpdate.innerHTML = '<option value="">-- Select Month --</option>';
    }
    if(fieldHoursUpdate) fieldHoursUpdate.value = "";
    if(bibleStudiesUpdate) bibleStudiesUpdate.value = "";
    if(sharedMinistryUpdate) sharedMinistryUpdate.checked = false;
    if(auxiliaryPioneerCheckboxUpdate) auxiliaryPioneerCheckboxUpdate.checked = false;
    if(commentsUpdate) commentsUpdate.value = "";
    if(lastModifiedByUpdate) lastModifiedByUpdate.textContent = "";
    updateReportFieldsDiv.style.display = 'none';
    currentReportId = null;
}
        function setupSubmitRequestPage() {
    clearSubmitRequestForm();
    publisherNameDropdownRequest.innerHTML = '<option value="">-- Select Publisher --</option>';
    publisherList.forEach(pub => {
        const opt = document.createElement("option");
        opt.value = pub.id;
        opt.textContent = pub.fullName;
        publisherNameDropdownRequest.appendChild(opt);
    });

    populateServiceYears(serviceYearRequest);
    populateMonths(monthYearRequest, serviceYearRequest.value);
    populateServiceYears(consolidateYearRequest);
    populateMonths(consolidateMonthRequest, consolidateYearRequest.value);

    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const prevMonthDate = new Date();
    prevMonthDate.setMonth(today.getMonth() - 1);
    const prevMonthName = prevMonthDate.toLocaleString('en-US', { month: 'long' });
    const prevMonthYear = prevMonthDate.getFullYear();

    let consolidateToServiceYear = (currentMonth >= 9) ? currentYear + 1 : currentYear;
    consolidateYearRequest.value = consolidateToServiceYear;
    consolidateYearRequest.disabled = true;
    populateMonths(consolidateMonthRequest, consolidateToServiceYear);
    consolidateMonthRequest.value = `${prevMonthName} ${prevMonthYear}`;
    consolidateMonthRequest.disabled = true;

    const handlePublisherSelection = () => {
        const selectedPublisher = publisherList.find(p => p.id === publisherNameDropdownRequest.value);
        if(selectedPublisher) {
            fieldGroupRequest.value = selectedPublisher.fieldServiceGroup || '';
            privilege2Request.value = selectedPublisher.privilege2 || '';
        } else {
            fieldGroupRequest.value = '';
            privilege2Request.value = '';
        }
        fetchReportDataForRequest();
    };
    searchPublisherRequest.addEventListener("input", function () {
        const query = this.value.toLowerCase();
        suggestionBoxRequest.innerHTML = "";
        if (!query) return;
        const matches = publisherList.filter(pub => pub.fullName.toLowerCase().includes(query));
        matches.forEach(pub => {
            const div = document.createElement("div");
            div.textContent = pub.fullName;
            div.classList.add("suggestion-item");
            div.addEventListener("click", () => {
                this.value = pub.fullName;
                suggestionBoxRequest.innerHTML = "";
                publisherNameDropdownRequest.value = pub.id;
                publisherNameDropdownRequest.dispatchEvent(new Event('change'));
            });
            suggestionBoxRequest.appendChild(div);
        });
    });
    publisherNameDropdownRequest.addEventListener('change', handlePublisherSelection);
    serviceYearRequest.addEventListener('change', () => {
        populateMonths(monthYearRequest, serviceYearRequest.value);
        fetchReportDataForRequest();
    });
    monthYearRequest.addEventListener('change', fetchReportDataForRequest);
    consolidateYearRequest.addEventListener('change', () => populateMonths(consolidateMonthRequest, consolidateYearRequest.value));
}
    async function setupReviewApprovalsPage() {
        pendingRequestsList.innerHTML = '';
        noPendingRequestsLabel.classList.remove('hidden'); 
        try {
            const snapshot = await db.collection('updateRequests').where('status', '==', 'pending').get();
            if (snapshot.empty) {
                noPendingRequestsLabel.classList.remove('hidden');
                return;
            }
            noPendingRequestsLabel.classList.add('hidden'); 
            const newPendingList = pendingRequestsList.cloneNode(false);
            pendingRequestsList.parentNode.replaceChild(newPendingList, pendingRequestsList);
            pendingRequestsList = newPendingList;
            snapshot.forEach(doc => {
                const request = doc.data();
                const requestId = doc.id;
                const changes = request.requestedChanges;
                const requestDiv = document.createElement('div');
                requestDiv.className = 'request-item';
                requestDiv.innerHTML = `<h4>Request from: ${request.requestingUserEmail}</h4><p><strong>Publisher:</strong> ${request.publisherToUpdateName}<br><strong>Period:</strong> ${request.month}</p><p><strong>New Values:</strong><br>Hours: ${changes.hours}, Studies: ${changes.bibleStudies}<br>Shared in Ministry: ${changes.sharedInMinistry ? 'Yes' : 'No'}<br>Was Aux Pioneer: ${changes.wasAuxiliaryPioneer ? 'Yes' : 'No'}<br>Comments: ${changes.comments || '<i>No comments</i>'}</p><button class="approve-btn" data-id="${requestId}">Approve</button><button class="reject-btn" data-id="${requestId}">Reject</button>`;
                pendingRequestsList.appendChild(requestDiv);
            });
            pendingRequestsList.addEventListener('click', async (e) => {
                const target = e.target;
                const requestId = target.dataset.id;
                if (!requestId) return;
                if (target.classList.contains('approve-btn')) await approveRequest(requestId);
                else if (target.classList.contains('reject-btn')) await rejectRequest(requestId);
            });
        } catch (error) {
            console.error("Error fetching pending requests:", error);
            pendingRequestsList.innerHTML = '<p style="color:red;">Could not load requests.</p>';
        }
    }
    function clearSubmitRequestForm() {
    publisherNameDropdownRequest.value = "";
    serviceYearRequest.value = "";
    monthYearRequest.innerHTML = '<option value="">-- Select Month --</option>';
    searchPublisherRequest.value = "";
    fieldGroupRequest.value = "";
    privilege2Request.value = "";
    requestFields.innerHTML = "";
    requestFields.style.display = 'none';
    consolidateYearRequest.value = "";
    consolidateMonthRequest.innerHTML = '<option value="">-- Select Month --</option>';
}
    async function fetchReportDataForRequest() {
    const publisherId = publisherNameDropdownRequest.value;
    const serviceYear = serviceYearRequest.value;
    const month = monthYearRequest.value;
    requestFields.innerHTML = "";
    requestFields.style.display = 'none';
    if (!publisherId || !serviceYear || !month) { return; }

    const reportId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
    const reportRef = db.collection("reports").doc(reportId);
    try {
        const doc = await reportRef.get();
        let data = {};
        
        let fieldsHTML = `
            <div id="fieldHoursContainerRequest" class="hidden">
                <label for="fieldHoursRequest">Field Hours:</label>
                <input type="number" id="fieldHoursRequest" min="1">
            </div>
            <div id="bibleStudiesContainerRequest" class="hidden">
                <label for="bibleStudiesRequest">Bible Studies:</label>
                <input type="number" id="bibleStudiesRequest" min="0">
            </div>
            <div id="sharedMinistryContainerRequest" class="hidden checkbox-container">
                <input type="checkbox" id="sharedMinistryRequest">
                <label for="sharedMinistryRequest">Shared in Ministry</label>
            </div>
            <div id="auxiliaryPioneerCheckboxContainerRequest" class="hidden checkbox-container">
                <input type="checkbox" id="auxiliaryPioneerRequest">
                <label for="auxiliaryPioneerRequest">Auxiliary Pioneer</label>
            </div>
            <label for="commentsRequest">Comments/Reason for Update (Optional):</label>
            <textarea id="commentsRequest"></textarea>
            <div id="lastModifiedByRequest" class="last-modified"></div>
        `;
        requestFields.innerHTML = fieldsHTML;

        const dynamicElements = {
            privilegeInput: privilege2Request,
            fieldHoursContainer: document.getElementById('fieldHoursContainerRequest'),
            fieldHoursInput: document.getElementById('fieldHoursRequest'),
            bibleStudiesContainer: document.getElementById('bibleStudiesContainerRequest'),
            bibleStudiesInput: document.getElementById('bibleStudiesRequest'),
            sharedMinistryContainer: document.getElementById('sharedMinistryContainerRequest'),
            sharedMinistryCheckbox: document.getElementById('sharedMinistryRequest'),
            auxiliaryPioneerCheckboxContainer: document.getElementById('auxiliaryPioneerCheckboxContainerRequest'),
            auxiliaryPioneerCheckbox: document.getElementById('auxiliaryPioneerRequest')
        };
        
        await handleReportFieldLogic(dynamicElements, publisherId, serviceYear, month);
        
        if (doc.exists) {
            data = doc.data();
            document.getElementById('lastModifiedByRequest').textContent = data.lastModifiedBy ? `Last modified by: ${data.lastModifiedBy}` : 'Existing Report';
        } else {
            document.getElementById('lastModifiedByRequest').textContent = 'No existing report for this month. This will be a new entry.';
        }
        
        dynamicElements.fieldHoursInput.value = data.hours || '';
        dynamicElements.bibleStudiesInput.value = data.bibleStudies || '';
        dynamicElements.sharedMinistryCheckbox.checked = data.sharedInMinistry || false;
        if(dynamicElements.auxiliaryPioneerCheckbox) {
            dynamicElements.auxiliaryPioneerCheckbox.checked = data.wasAuxiliaryPioneer || false;
        }
        document.getElementById('commentsRequest').value = data.comments || '';

        requestFields.style.display = 'block';

    } catch (error) {
        console.error("Error fetching report for request:", error);
    }
}
    async function submitRequestForApproval() {
    const publisherId = publisherNameDropdownRequest.value;
    const serviceYear = serviceYearRequest.value;
    const month = monthYearRequest.value;
    if (!publisherId || !serviceYear || !month) {
        alert("Please select the publisher, service year, and month of the report.");
        return;
    }
    const originalReportId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
    const hoursInput = document.getElementById('fieldHoursRequest');
    if (!hoursInput) {
        alert("No report data loaded. Please select a valid period with an existing report.");
        return;
    }
    const studiesInput = document.getElementById('bibleStudiesRequest');
    const sharedMinistryInput = document.getElementById('sharedMinistryRequest');
    const auxPioneerInput = document.getElementById('auxiliaryPioneerRequest');
    const commentsInput = document.getElementById('commentsRequest');

    const privilege = privilege2Request.value;
    let isAuxThisMonth = false;
    if (privilege === 'Publisher/Auxi') {
         try {
            const docId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
            const docSnap = await db.collection("auxiliary_status").doc(docId).get();
            if (docSnap.exists && docSnap.data().isAuxiliary) { isAuxThisMonth = true; }
        } catch (e) { console.error("Error checking aux status on submit", e); }
    }

    if (isAuxThisMonth && (parseInt(hoursInput.value) || 0) <= 0) {
         alert("Validation Error: Field Hours must be greater than zero for an Auxiliary Pioneer."); return;
    }
    if (privilege === 'Publisher/Auxi' && !isAuxThisMonth && !sharedMinistryInput.checked) {
        alert("Validation Error: The 'Shared in Ministry' box must be checked."); return;
    }

    const wasAuxPioneerThisMonth = (auxPioneerInput && !auxPioneerInput.parentElement.classList.contains('hidden') && auxPioneerInput.checked);

    const requestedChanges = {
        hours: parseInt(hoursInput.value) || 0,
        bibleStudies: parseInt(studiesInput.value) || 0,
        sharedInMinistry: sharedMinistryInput.checked,
        wasAuxiliaryPioneer: wasAuxPioneerThisMonth,
        comments: commentsInput.value,
        consolidateToMonth: consolidateMonthRequest.value,
        lastModifiedBy: currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    const requestData = {
        requestingUserUid: currentUser.uid,
        requestingUserEmail: currentUser.email,
        publisherToUpdateId: publisherId,
        publisherToUpdateName: publisherNameDropdownRequest.options[publisherNameDropdownRequest.selectedIndex].text,
        originalReportId: originalReportId,
        serviceYear: serviceYear,
        month: month,
        requestedChanges: requestedChanges,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
        await db.collection('updateRequests').add(requestData);
        alert("Request Submitted. Please wait for the admin approval to take effect the changes.");
        clearSubmitRequestForm();
    } catch (error) {
        console.error("Error submitting request:", error);
        alert("Failed to submit request. Please check security rules and console.");
    }
}
    async function approveRequest(requestId) {
    if(!confirm("Are you sure you want to approve these changes?")) return;
    try {
        const requestRef = db.collection('updateRequests').doc(requestId);
        const requestDoc = await requestRef.get();
        if(!requestDoc.exists) {
            alert("Error: Request not found. It may have been processed already.");
            setupReviewApprovalsPage();
            return;
        }
        const requestData = requestDoc.data();
        const reportRef = db.collection('reports').doc(requestData.originalReportId);

        const finalReportData = {
            ...requestData.requestedChanges,
            publisherId: requestData.publisherToUpdateId,
            publisherFullName: requestData.publisherToUpdateName,
            serviceYear: requestData.serviceYear,
            month: requestData.month,
            privilege2AtTimeOfReport: publisherList.find(p => p.id === requestData.publisherToUpdateId)?.privilege2 || '',
            fieldServiceGroup: publisherList.find(p => p.id === requestData.publisherToUpdateId)?.fieldServiceGroup || '',
        };

        await reportRef.set(finalReportData, { merge: true });
        
        await requestRef.update({ status: 'approved', processedBy: currentUser.email });

        alert("Request approved and report has been saved/updated.");
        setupReviewApprovalsPage();
    } catch (error) {
        console.error("Error approving request:", error);
        alert("Failed to approve request.");
    }
}
    async function rejectRequest(requestId) {
        if (!confirm("Are you sure you want to reject this request?")) return;
        try {
            const requestRef = db.collection('updateRequests').doc(requestId);
            await requestRef.update({ status: 'rejected', processedBy: currentUser.email });
            alert("Request has been rejected.");
            setupReviewApprovalsPage();
        } catch (error) { console.error("Error rejecting request:", error); alert("Failed to reject request."); }
    }
        function setupUploadPage() {
        uploadStatus.innerHTML = '<p>No file selected.</p>';
        processUploadBtn.disabled = true;
        excelFileInput.value = ''; 
        parsedExcelData = [];
    }
    function setupUploadPublishersPage() {
        uploadStatusPublishers.innerHTML = '<p>No file selected.</p>';
        processUploadBtnPublishers.disabled = true;
        excelFileInputPublishers.value = ''; 
        parsedExcelData = [];
    }
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) { return; }
        uploadStatus.innerHTML = `<p>Reading file: ${file.name}...</p>`;
        processUploadBtn.disabled = true;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json_data = XLSX.utils.sheet_to_json(worksheet);
                if (json_data.length === 0) {
                    uploadStatus.innerHTML = '<p style="color:red;">Error: The file is empty or in an incorrect format.</p>';
                    return;
                }
                parsedExcelData = json_data;
                uploadStatus.innerHTML = `<p style="color:green;">Read ${parsedExcelData.length} records from ${file.name}.</p><p>Click "Upload and Process" to continue.</p>`;
                processUploadBtn.disabled = false;
            } catch (error) {
                console.error("Error reading Excel file:", error);
                uploadStatus.innerHTML = '<p style="color:red;">Error: Failed to read the file. Please ensure it is a valid Excel/CSV file.</p>';
                parsedExcelData = [];
            }
        };
        reader.readAsArrayBuffer(file);
    }
    async function processAndUploadRecords() {
        if (parsedExcelData.length === 0) { alert("No data to upload."); return; }
        processUploadBtn.disabled = true;
        uploadStatus.innerHTML = `<p>Processing ${parsedExcelData.length} records... Please wait.</p><pre></pre>`;
        const statusLog = uploadStatus.querySelector('pre');
        const batch = db.batch();
        let newRecordsCount = 0, skippedRecordsCount = 0, errorCount = 0;
        for (const record of parsedExcelData) {
            try {
                const publisherFullName = record["Publisher Name"]?.trim();
                const serviceYear = String(record["Service Year"])?.trim();
                const month = String(record["Month"])?.trim();
                if (!publisherFullName || !serviceYear || !month) {
                    statusLog.textContent += `Skipping row: Missing required data.\n`;
                    skippedRecordsCount++;
                    continue;
                }
                const publisher = publisherList.find(p => p.fullName === publisherFullName);
                if (!publisher) {
                    statusLog.textContent += `Skipping "${publisherFullName}": Publisher not found.\n`;
                    skippedRecordsCount++;
                    continue;
                }
                const reportId = `${publisher.id}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
                const reportRef = db.collection("reports").doc(reportId);
                const doc = await reportRef.get();
                if (doc.exists) {
                    statusLog.textContent += `Skipping "${publisherFullName}" (${month}): Already exists.\n`;
                    skippedRecordsCount++;
                    continue;
                }
                const reportData = {
                    publisherId: publisher.id, publisherFullName: publisher.fullName, serviceYear, month,
                    fieldServiceGroup: record["Field Service Group"] || publisher.fieldServiceGroup,
                    privilege2AtTimeOfReport: record["Privilege at Time of Report"] || publisher.privilege2,
                    hours: parseInt(record.Hours) || 0,
                    bibleStudies: parseInt(record["Bible Studies"]) || 0,
                    sharedInMinistry: String(record["Shared in Ministry"] || '').toLowerCase() === 'yes',
                    wasAuxiliaryPioneer: String(record["Was Auxiliary Pioneer"] || '').toLowerCase() === 'yes',
                    comments: record.Comments || '',
                    lastModifiedBy: currentUser.email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                batch.set(reportRef, reportData);
                newRecordsCount++;
            } catch (error) {
                 console.error("Error processing record:", record, error);
                 statusLog.textContent += `Error on row for "${record["Publisher Name"]}". Skipping.\n`;
                 errorCount++;
            }
        }
        try {
            await batch.commit();
            let summary = `Upload complete!\n\nNew Records Added: ${newRecordsCount}\nRecords Skipped: ${skippedRecordsCount}\nErrors: ${errorCount}`;
            statusLog.textContent += `\n${summary}`;
            alert(summary);
            processUploadBtn.disabled = true;
        } catch (error) {
            console.error("Error committing batch:", error);
            statusLog.textContent += "\nFATAL ERROR: Could not save records to the database.";
            alert("A fatal error occurred during the upload. Please check the status log.");
        }
    }
    function handlePublisherFileSelect(event) {
        const file = event.target.files[0];
        if (!file) { return; }
        uploadStatusPublishers.innerHTML = `<p>Reading file: ${file.name}...</p>`;
        processUploadBtnPublishers.disabled = true;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json_data = XLSX.utils.sheet_to_json(worksheet);
                if (json_data.length === 0) {
                    uploadStatusPublishers.innerHTML = '<p style="color:red;">Error: The file is empty.</p>';
                    return;
                }
                parsedExcelData = json_data;
                uploadStatusPublishers.innerHTML = `<p style="color:green;">Read ${parsedExcelData.length} records from ${file.name}.</p><p>Click "Upload and Process" to continue.</p>`;
                processUploadBtnPublishers.disabled = false;
            } catch (error) {
                console.error("Error reading publisher file:", error);
                uploadStatusPublishers.innerHTML = '<p style="color:red;">Error: Failed to read or parse the file.</p>';
                parsedExcelData = [];
            }
        };
        reader.readAsArrayBuffer(file);
    }
    async function processAndUploadPublishers() {
        if (parsedExcelData.length === 0) { alert("No data to upload."); return; }
        processUploadBtnPublishers.disabled = true;
        uploadStatusPublishers.innerHTML = `<p>Processing ${parsedExcelData.length} records... Please wait.</p><pre></pre>`;
        const statusLog = uploadStatusPublishers.querySelector('pre');
        const batch = db.batch();
        let newRecordsCount = 0, skippedRecordsCount = 0, errorCount = 0;
        const requiredFields = ["FirstName", "LastName", "Birthdate", "BaptismStatus", "Gender", "Hope", "Privilege", "Privilege2", "FieldServiceGroup"];
        for (const record of parsedExcelData) {
            try {
                const missingField = requiredFields.find(field => !record[field]);
                if (missingField) {
                    statusLog.textContent += `Skipping row: Missing required field "${missingField}".\n`;
                    skippedRecordsCount++;
                    continue;
                }
                const firstName = record.FirstName.trim();
                const lastName = record.LastName.trim();
                const birthdateRaw = record.Birthdate;
                if (!(birthdateRaw instanceof Date)) {
                     statusLog.textContent += `Skipping ${lastName}, ${firstName}: 'Birthdate' is not a valid date format.\n`;
                     skippedRecordsCount++;
                     continue;
                }
                const tzOffset = birthdateRaw.getTimezoneOffset() * 60000;
                const localDate = new Date(birthdateRaw.getTime() - tzOffset);
                const birthdate = localDate.toISOString().slice(0, 10);
                if (record.BaptismStatus === 'Baptized' && !(record.BaptismDate instanceof Date)) {
                    statusLog.textContent += `Skipping ${lastName}, ${firstName}: 'BaptismDate' is required and must be a valid date when status is 'Baptized'.\n`;
                    skippedRecordsCount++;
                    continue;
                }
                const baptismDate = record.BaptismDate instanceof Date ? new Date(record.BaptismDate.getTime() - (record.BaptismDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 10) : "";
                const docId = `${lastName}_${firstName}_${birthdate}`.replace(/\s+/g, "_");
                const publisherRef = db.collection("publishers").doc(docId);
                const docSnap = await publisherRef.get();
                if (docSnap.exists) {
                    statusLog.textContent += `Skipping "${lastName}, ${firstName}": Already exists.\n`;
                    skippedRecordsCount++;
                    continue;
                }
                const publisherData = {
                    firstName, lastName, birthdate, baptismDate,
                    fullName: `${lastName}, ${firstName}`,
                    baptismStatus: record.BaptismStatus,
                    gender: record.Gender,
                    hope: record.Hope,
                    privilege: record.Privilege,
                    privilege2: record.Privilege2,
                    fieldServiceGroup: record.FieldServiceGroup,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                batch.set(publisherRef, publisherData);
                newRecordsCount++;
            } catch (error) {
                 console.error("Error processing record:", record, error);
                 statusLog.textContent += `Error on row for "${record.LastName}, ${record.FirstName}". Skipping.\n`;
                 errorCount++;
            }
        }
        try {
            await batch.commit();
            let summary = `Upload complete!\n\nNew Publishers Added: ${newRecordsCount}\nPublishers Skipped: ${skippedRecordsCount}\nErrors: ${errorCount}`;
            statusLog.textContent += `\n${summary}`;
            alert(summary);
            await loadPublishers();
            processUploadBtnPublishers.disabled = true;
        } catch (error) {
            console.error("Error committing batch upload:", error);
            statusLog.textContent += "\nFATAL ERROR: Could not save records to the database.";
            alert("A fatal error occurred. Please check the status log.");
        }
    }
        async function saveReport() {
    const publisherId = publisherNameDropdown.value;
    const serviceYear = serviceYearDropdown.value;
    const month = monthYearDropdown.value;
    const consolidateTo = consolidateMonthReport.value;

    if (!publisherId || !serviceYear || !month) { alert("Please select publisher, year, and month."); return; }
    if (!consolidateTo) { alert("Validation Error: 'Consolidate Report to' is a mandatory field."); return; }

    let hoursVal = parseInt(fieldHoursInput.value) || 0;
    fieldHoursInput.value = hoursVal;
    let studiesVal = parseInt(bibleStudiesInput.value) || 0;
    bibleStudiesInput.value = studiesVal;
    const privilege = privilege2ReportInput.value;
    let isAuxThisMonth = false;
    if (privilege === 'Publisher/Auxi') {
        const docId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
        try {
            const docSnap = await db.collection("auxiliary_status").doc(docId).get();
            if (docSnap.exists && docSnap.data().isAuxiliary) {
                isAuxThisMonth = true;
            }
        } catch (e) { console.error("Error checking aux status on save", e); }
    } else if (["Regular Pioneer", "Special Pioneer", "Field Missionary", "Continuous Auxiliary Pioneer"].includes(privilege)) {
        isAuxThisMonth = true;
    }
    if ((isAuxThisMonth || auxiliaryPioneerCheckbox.checked) && hoursVal <= 0) {
        alert("Validation Error: Field Hours must be greater than zero for an Auxiliary Pioneer."); return;
    }
    if (privilege === 'Publisher/Auxi' && !isAuxThisMonth && !sharedMinistryCheckbox.checked) {
        alert("Validation Error: 'Shared in Ministry' must be checked for this report."); return;
    }
    const publisherFullName = publisherNameDropdown.options[publisherNameDropdown.selectedIndex].text;
    const reportId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
    const reportRef = db.collection("reports").doc(reportId);
    try {
        const doc = await reportRef.get();
        if (doc.exists) { alert("Error: A report for this publisher, service year, and month already exists."); return; }
        const reportData = {
            publisherId, publisherFullName, serviceYear, month, 
            consolidateToMonth: consolidateTo, 
            fieldServiceGroup: fieldGroupInput.value, 
            privilege2AtTimeOfReport: privilege2ReportInput.value, 
            hours: hoursVal, 
            bibleStudies: studiesVal, 
            sharedInMinistry: sharedMinistryCheckbox.checked, 
            wasAuxiliaryPioneer: auxiliaryPioneerCheckbox.checked, 
            comments: commentsAdd.value,
            lastModifiedBy: currentUser.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        await reportRef.set(reportData);
        alert("Report saved successfully!");
        clearAddReportForm();
    } catch (error) { console.error("Error saving report: ", error); alert("An error occurred while saving the report."); }
}
    function setupAddReportPage() {
    clearAddReportForm();
    publisherNameDropdown.innerHTML = '<option value="">-- Select Publisher --</option>';
    publisherList.forEach(pub => {
        const opt = document.createElement("option");
        opt.value = pub.id;
        opt.textContent = pub.fullName || `${pub.lastName}, ${pub.firstName}`;
        publisherNameDropdown.appendChild(opt);
    });

    populateServiceYears(serviceYearDropdown);
    populateMonths(monthYearDropdown, serviceYearDropdown.value);
    populateServiceYears(consolidateYearReport);
    populateMonths(consolidateMonthReport, consolidateYearReport.value);

    consolidateYearReport.addEventListener('change', () => populateMonths(consolidateMonthReport, consolidateYearReport.value));

    serviceYearDropdown.disabled = false;
    monthYearDropdown.disabled = false;
    publisherNameDropdown.disabled = false;
    searchPublisherReport.classList.remove('hidden');

    if (currentUser.role === 'user') {
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        const prevMonthDate = new Date();
        prevMonthDate.setMonth(today.getMonth() - 1);
        const prevMonthName = prevMonthDate.toLocaleString('en-US', { month: 'long' });
        const prevMonthYear = prevMonthDate.getFullYear();

        let mainServiceYear = (prevMonthDate.getMonth() >= 8) ? prevMonthDate.getFullYear() + 1 : prevMonthDate.getFullYear();

        serviceYearDropdown.value = mainServiceYear;
        serviceYearDropdown.disabled = true;
        populateMonths(monthYearDropdown, mainServiceYear);
        monthYearDropdown.value = `${prevMonthName} ${prevMonthYear}`;
        monthYearDropdown.disabled = true;

        let consolidateToServiceYear = (currentMonth >= 9) ? currentYear + 1 : currentYear;
        consolidateYearReport.value = consolidateToServiceYear;
        consolidateYearReport.disabled = true;
        populateMonths(consolidateMonthReport, consolidateToServiceYear);
        consolidateMonthReport.value = `${prevMonthName} ${prevMonthYear}`;
        consolidateMonthReport.disabled = true;

    } else {
        consolidateYearReport.disabled = false;
        consolidateMonthReport.disabled = false;
    }

    searchPublisherReportInput.addEventListener("input", function () {
        const query = this.value.toLowerCase();
        suggestionBoxReport.innerHTML = "";
        if (!query) return;
        const matches = publisherList.filter(pub => pub.fullName.toLowerCase().includes(query));
        matches.forEach(pub => {
            const div = document.createElement("div");
            div.textContent = pub.fullName;
            div.classList.add("suggestion-item");
            div.addEventListener("click", () => {
                this.value = pub.fullName;
                suggestionBoxReport.innerHTML = "";
                publisherNameDropdown.value = pub.id;
                autofillPublisherDetails(pub.id);
            });
            suggestionBoxReport.appendChild(div);
        });
    });
    publisherNameDropdown.addEventListener("change", async () => await autofillPublisherDetails(publisherNameDropdown.value));
    serviceYearDropdown.addEventListener("change", async () => {
        populateMonths(monthYearDropdown, serviceYearDropdown.value);
        await updateReportFieldsVisibility();
    });
    monthYearDropdown.addEventListener("change", async () => await updateReportFieldsVisibility());
}
    async function autofillPublisherDetails(publisherId) {
        const selectedPublisher = publisherList.find(pub => pub.id === publisherId);
        if (selectedPublisher) {
            fieldGroupInput.value = selectedPublisher.fieldServiceGroup || "";
            privilege2ReportInput.value = selectedPublisher.privilege2 || "";
        } else {
            fieldGroupInput.value = "";
            privilege2ReportInput.value = "";
        }
        await updateReportFieldsVisibility();
    }
    function clearAddReportForm() {
    suggestionBoxReport.innerHTML = "";
    fieldGroupInput.value = "";
    privilege2ReportInput.value = "";
    commentsAdd.value = "";
    lastModifiedByAdd.textContent = "";
    searchPublisherReportInput.value = "";
    publisherNameDropdown.value = "";
    if (currentUser.role === 'admin' || currentUser.role === 'assistant_admin') {
        serviceYearDropdown.value = "";
        monthYearDropdown.innerHTML = '<option value="">-- Select Month --</option>';
        consolidateYearReport.value = "";
        consolidateMonthReport.innerHTML = '<option value="">-- Select Month --</option>';
    }
    updateReportFieldsVisibility();
}
    async function updateReportFieldsVisibility() {
        const publisherId = publisherNameDropdown.value;
        const serviceYear = serviceYearDropdown.value;
        const month = monthYearDropdown.value;
        await handleReportFieldLogic({
            privilegeInput: privilege2ReportInput, fieldHoursContainer, fieldHoursInput, bibleStudiesContainer, bibleStudiesInput, sharedMinistryContainer, sharedMinistryCheckbox, auxiliaryPioneerCheckboxContainer, auxiliaryPioneerCheckbox
        }, publisherId, serviceYear, month);
    }
    async function updateReportFieldsVisibility_UpdatePage() {
        const publisherId = publisherNameDropdownUpdate.value;
        const serviceYear = serviceYearDropdownUpdate.value;
        const month = monthYearDropdownUpdate.value;
        await handleReportFieldLogic({
             privilegeInput: privilege2Update, fieldHoursContainer: fieldHoursContainerUpdate, fieldHoursInput: fieldHoursUpdate, bibleStudiesContainer: bibleStudiesContainerUpdate, bibleStudiesInput: bibleStudiesUpdate, sharedMinistryContainer: sharedMinistryContainerUpdate, sharedMinistryCheckbox: sharedMinistryUpdate, auxiliaryPioneerCheckboxContainer: auxiliaryPioneerCheckboxContainerUpdate, auxiliaryPioneerCheckbox: auxiliaryPioneerCheckboxUpdate
        }, publisherId, serviceYear, month);
    }
   function populateServiceYears(dropdownElement) {
        if (!dropdownElement) return;
        dropdownElement.innerHTML = '<option value="">-- Select Year --</option>';
        const startYear = 2015;
        const endYear = new Date().getFullYear() + 5;
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            dropdownElement.appendChild(option);
        }
    }
    function populateMonths(monthDropdown, serviceYear) {
        if (!monthDropdown || !serviceYear) { monthDropdown.innerHTML = '<option value="">-- Select Month --</option>'; return; };
        monthDropdown.innerHTML = '<option value="">-- Select Month --</option>';
        const selectedServiceYear = parseInt(serviceYear);
        const startMonthYear = new Date(selectedServiceYear - 1, 8);
        const endMonthYear = new Date(selectedServiceYear, 7);
        let currentMonth = new Date(startMonthYear);
        while (currentMonth <= endMonthYear) {
            const option = document.createElement("option");
            const monthName = currentMonth.toLocaleString('en-US', { month: 'long' });
            const year = currentMonth.getFullYear();
            option.value = `${monthName} ${year}`;
            option.textContent = `${monthName} ${year}`;
            monthDropdown.appendChild(option);
            currentMonth.setMonth(currentMonth.getMonth() + 1);
        }
    } 
    function setupSummaryReportPage() {
    populateServiceYears(serviceYearSummary);
    populateMonths(monthSummary, serviceYearSummary.value);
    serviceYearSummary.addEventListener('change', () => {
        populateMonths(monthSummary, serviceYearSummary.value);
    });
    summaryResults.innerHTML = "<p>No summary generated yet.</p>";
}
    function parseMonthString(monthStr) {
        if (!monthStr) return null;
        const parts = monthStr.split(' ');
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthIndex = monthNames.indexOf(parts[0]);
        const year = parseInt(parts[1], 10);
        if (monthIndex !== -1 && !isNaN(year)) {
            return new Date(year, monthIndex, 1);
        }
        return null;
    }
async function generateSummaryReport() {
    const selectedYear = serviceYearSummary.value;
    const selectedMonthStr = monthSummary.value;

    if (!selectedYear || !selectedMonthStr) {
        alert("Please select a service year and month.");
        return;
    }

    summaryResults.innerHTML = "<p>Generating summary... Please wait.</p>";

    try {
        const monthlyReportsSnap = await db.collection("reports").where("month", "==", selectedMonthStr).get();
        const allAuxStatusesSnap = await db.collection("auxiliary_status").get();
        
        const reportsToSummarize = monthlyReportsSnap.docs.map(doc => doc.data());
        const allAuxStatuses = allAuxStatusesSnap.docs.map(doc => ({id: `${doc.data().publisherId}_${doc.data().serviceYear}_${doc.data().month.replace(/\s+/g, '-')}`, ...doc.data()}));
        
        let summary = {
            activeInLast6Months: 0,
            publishersReported: 0,
            publishersStudies: 0,
            auxPioneersReported: 0,
            auxPioneersHours: 0,
            auxPioneersStudies: 0,
            fullTimePioneersReported: 0,
            fullTimePioneersHours: 0,
            fullTimePioneersStudies: 0,
        };

        const publishersReportedList = [];
        const auxPioneersReportedList = [];
        const fullTimePioneersReportedList = [];
        const fullTimePrivileges = ["Regular Pioneer", "Special Pioneer", "Field Missionary"];

        for (const report of reportsToSummarize) {
            const privilege = report.privilege2AtTimeOfReport;
            
            if (fullTimePrivileges.includes(privilege)) {
                if (report.hours > 0) {
                    summary.fullTimePioneersReported++;
                    summary.fullTimePioneersHours += report.hours;
                    summary.fullTimePioneersStudies += report.bibleStudies;
                    fullTimePioneersReportedList.push({ name: report.publisherFullName, hours: report.hours, studies: report.bibleStudies });
                }
            } else if (privilege === "Continuous Auxiliary Pioneer") {
                 if (report.hours > 0) {
                    summary.auxPioneersReported++;
                    summary.auxPioneersHours += report.hours;
                    summary.auxPioneersStudies += report.bibleStudies;
                    auxPioneersReportedList.push({ name: report.publisherFullName, hours: report.hours, studies: report.bibleStudies });
                }
            } else if (privilege === "Publisher/Auxi") {
                const auxStatusDocId = `${report.publisherId}_${report.serviceYear}_${report.month.replace(/\s+/g, '-')}`;
                const auxStatus = allAuxStatuses.find(s => s.id === auxStatusDocId);
                const isAux = auxStatus ? auxStatus.isAuxiliary : false;

                if (isAux) {
                    if (report.hours > 0) {
                        summary.auxPioneersReported++;
                        summary.auxPioneersHours += report.hours;
                        summary.auxPioneersStudies += report.bibleStudies;
                        auxPioneersReportedList.push({ name: report.publisherFullName, hours: report.hours, studies: report.bibleStudies });
                    }
                } else {
                    if (report.sharedInMinistry) {
                        summary.publishersReported++;
                        summary.publishersStudies += report.bibleStudies;
                        publishersReportedList.push({ name: report.publisherFullName, studies: report.bibleStudies });
                    }
                }
            }
        }
        
        const allReportsSnap_for6Months = await db.collection("reports").get();
        const allReports = allReportsSnap_for6Months.docs.map(doc => doc.data());
        const targetMonthDate = parseMonthString(selectedMonthStr);
        const sixMonthsAgo = new Date(targetMonthDate);
        sixMonthsAgo.setMonth(targetMonthDate.getMonth() - 5, 1);
        sixMonthsAgo.setHours(0,0,0,0);

        const windowEnd = new Date(targetMonthDate);
        windowEnd.setMonth(targetMonthDate.getMonth() + 1, 0);
        windowEnd.setHours(23,59,59,999);

        const activePublishersIds = new Set();
        allReports.forEach(report => {
            if (!report.month || !report.publisherId) return;
            const reportDate = parseMonthString(report.month);
            
            if (reportDate && reportDate >= sixMonthsAgo && reportDate <= windowEnd) {
                if (report.sharedInMinistry === true) {
                    const pub = publisherList.find(p => p.id === report.publisherId);
                    if (!pub) {
                        return; 
                    }
                    const status = pub.publisherStatus || "In the Congregation";
                    if (status === "In the Congregation") {
                        activePublishersIds.add(report.publisherId);
                    }
                }
            }
        });
        summary.activeInLast6Months = activePublishersIds.size;
        
        const activePublishersNames = Array.from(activePublishersIds).map(id => {
            const pub = publisherList.find(p => p.id === id);
            return pub ? pub.fullName : 'Unknown Publisher';
        }).sort();

        publishersReportedList.sort((a, b) => a.name.localeCompare(b.name));
        auxPioneersReportedList.sort((a, b) => a.name.localeCompare(b.name));
        fullTimePioneersReportedList.sort((a, b) => a.name.localeCompare(b.name));

        const resultsHTML = `
            <h3>Summary for ${selectedMonthStr}</h3>
            <table border="1" cellpadding="5" cellspacing="0" style="width:100%; border-collapse: collapse;">
                <tr><td style="width:80%;">1. Active publishers in the last 6 months:</td><td style="text-align:right;"><b>${summary.activeInLast6Months}</b></td></tr>
                <tr><td>2. Count of Publishers who shared in ministry:</td><td style="text-align:right;"><b>${summary.publishersReported}</b></td></tr>
                <tr><td>3. Total Bible Studies from Publishers:</td><td style="text-align:right;"><b>${summary.publishersStudies}</b></td></tr>
                <tr><td>4. Count of Auxiliary Pioneers reporting time:</td><td style="text-align:right;"><b>${summary.auxPioneersReported}</b></td></tr>
                <tr><td>5. Total Hours from Auxiliary Pioneers:</td><td style="text-align:right;"><b>${summary.auxPioneersHours}</b></td></tr>
                <tr><td>6. Total Bible Studies from Auxiliary Pioneers:</td><td style="text-align:right;"><b>${summary.auxPioneersStudies}</b></td></tr>
                <tr><td>7. Count of Regular/Special Pioneers & Missionaries reporting time:</td><td style="text-align:right;"><b>${summary.fullTimePioneersReported}</b></td></tr>
                <tr><td>8. Total Hours from Regular/Special Pioneers & Missionaries:</td><td style="text-align:right;"><b>${summary.fullTimePioneersHours}</b></td></tr>
                <tr><td>9. Total Bible Studies from Regular/Special Pioneers & Missionaries:</td><td style="text-align:right;"><b>${summary.fullTimePioneersStudies}</b></td></tr>
            </table>
            <hr>
            <h4>List of ${activePublishersNames.length} Active Publishers (Item #1):</h4>
            <pre>${activePublishersNames.join('\n')}</pre>
            <hr>
            <h4>List of ${publishersReportedList.length} Publishers (Item #2 & #3):</h4>
            <pre>${publishersReportedList.map(p => `${p.name} (BS: ${p.studies})`).join('\n')}</pre>
            <hr>
            <h4>List of ${auxPioneersReportedList.length} Auxiliary Pioneers (Item #4, #5, #6):</h4>
            <pre>${auxPioneersReportedList.map(p => `${p.name} (Hrs: ${p.hours}, BS: ${p.studies})`).join('\n')}</pre>
            <hr>
            <h4>List of ${fullTimePioneersReportedList.length} Pioneers/Missionaries (Item #7, #8, #9):</h4>
            <pre>${fullTimePioneersReportedList.map(p => `${p.name} (Hrs: ${p.hours}, BS: ${p.studies})`).join('\n')}</pre>
        `;
        summaryResults.innerHTML = resultsHTML;

    } catch (error) {
        console.error("Error generating summary:", error);
        summaryResults.innerHTML = `<p style="color:red;">An error occurred while generating the summary. Please check the console.</p>`;
    }
}   
function clearSummaryPage() {
    serviceYearSummary.value = "";
    monthSummary.innerHTML = '<option value="">-- Select Month --</option>';
    summaryResults.innerHTML = "<p>No summary generated yet.</p>";
}
</script>
</body>
</html>
