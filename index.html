<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher App</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f4f4f4; margin: 0; padding: 20px; box-sizing: border-box; }
        .page-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        input, select, textarea { display: block; width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 60px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .logout-btn, .delete-btn, .reject-btn { background-color: #dc3545; }
        .logout-btn:hover, .delete-btn:hover, .reject-btn:hover { background-color: #c82333; }
        .clear-btn { background-color: #ffc107; color: #333; }
        .clear-btn:hover { background-color: #e0a800; }
        .back-btn { background-color: #6c757d; }
        .back-btn:hover { background-color: #5a6268; }
        .approve-btn { background-color: #28a745; }
        .approve-btn:hover { background-color: #218838; }
        .hidden { display: none !important; }
        .suggestion-box { border: 1px solid #ddd; max-height: 150px; overflow-y: auto; background-color: white; position: absolute; width: calc(100% - 42px); z-index: 100; }
        .suggestion-item { padding: 8px; cursor: pointer; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        input[type="checkbox"] { width: auto; margin-right: 5px;}
        .checkbox-container { display: flex; align-items: center; margin-bottom: 10px; }
        .request-item { border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-bottom: 15px; }
        .request-item h4 { margin-top: 0; }
        .last-modified { font-style: italic; color: #888; font-size: 12px; margin-top: -5px; margin-bottom: 10px; }
        #uploadStatus, #uploadStatusPublishers { margin-top: 15px; font-weight: bold; }
        #uploadStatus pre, #uploadStatusPublishers pre { white-space: pre-wrap; word-wrap: break-word; background-color: #eee; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="loginPage" class="page-container">
        <h2>Login</h2>
        <input type="email" id="loginUsername" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button id="loginBtn">Login</button>
    </div>
    <div id="homePage" class="page-container hidden">
        <h2>Welcome, <span id="loggedInUser"></span>!</h2>
        <div id="adminButtons">
            <button id="managePublisherBtn">Manage Publisher</button>
            <button id="manageAuxiliaryPioneerBtn">Manage Auxiliary Pioneer</button>
            <button id="addReportBtnAdmin">Add Report</button>
            <button id="updateReportPageBtn">Update Report</button>
            <button id="reviewApprovalsBtn">Review Approvals</button>
            <button id="exportExcelBtn">Export to Excel</button>
            <button id="uploadReportsBtn">Upload Reports</button>
            <button id="uploadPublishersBtn">Upload Publishers</button>
        </div>
        <div id="userButtons">
            <button id="addReportBtnUser">Add Report</button>
            <button id="submitRequestPageBtn">Submit Request to Update</button>
        </div>
        <button id="logoutBtn" class="logout-btn">Logout</button>
        <div id="adminSection" style="margin-top: 20px;">
             <button id="clearAllDataBtn">Clear All Data</button>
             <p style="color: red; font-size: 12px; margin-top: 5px;">Warning: This will delete all publisher and report data.</p>
        </div>
    </div>
    <div id="manageAuxiliaryPage" class="page-container hidden">
        <h2>Manage Auxiliary Pioneer Status</h2>
        <p>Select a "Publisher/Auxi" and the month to set their pioneer status.</p>
        <label for="searchPublisherAux">Search Publisher (Publisher/Auxi only):</label>
        <input type="text" id="searchPublisherAux" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxAux" class="suggestion-box"></div>
        <label for="publisherNameDropdownAux">Publisher Name:</label>
        <select id="publisherNameDropdownAux"></select>
        <label for="fieldGroupAux">Field Service Group:</label>
        <input type="text" id="fieldGroupAux" disabled>
        <label for="privilege2Aux">Privilege 2:</label>
        <input type="text" id="privilege2Aux" disabled>
        <label for="serviceYearDropdownAux">Service Year:</label>
        <select id="serviceYearDropdownAux"></select>
        <label for="monthYearDropdownAux">Month:</label>
        <select id="monthYearDropdownAux"></select>
        <hr style="margin: 20px 0;">
        <label for="isAuxiliaryPioneerThisMonthAux">Is this publisher an Auxiliary Pioneer for the selected month?</label>
        <select id="isAuxiliaryPioneerThisMonthAux">
            <option value="">-- Select --</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
        </select>
        <div id="lastModifiedByAux" class="last-modified"></div>
        <button id="saveAuxStatusBtn">Save Status</button>
        <button id="clearAuxFormBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromAuxBtn" class="back-btn">Back to Home</button>
    </div>
    <div id="addReportPage" class="page-container hidden">
        <h2>Add Field Service Report</h2>
        <label for="searchPublisherReport">Search Publisher:</label>
        <input type="text" id="searchPublisherReport" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxReport" class="suggestion-box"></div>
        <label for="publisherNameDropdown">Publisher Name:</label>
        <select id="publisherNameDropdown"></select>
        <label for="fieldGroup">Field Service Group:</label>
        <input type="text" id="fieldGroup" disabled>
        <label for="privilege2Report">Privilege 2:</label>
        <input type="text" id="privilege2Report" disabled>
        <label for="serviceYearDropdown">Service Year:</label>
        <select id="serviceYearDropdown"></select>
        <label for="monthYearDropdown">Month:</label>
        <select id="monthYearDropdown"></select>
        <div id="fieldHoursContainer" class="hidden">
            <label for="fieldHours">Field Hours:</label>
            <input type="number" id="fieldHours" min="1">
        </div>
        <div id="bibleStudiesContainer" class="hidden">
            <label for="bibleStudies">Bible Studies:</label>
            <input type="number" id="bibleStudies" min="0">
        </div>
        <div id="sharedMinistryContainer" class="hidden">
            <div class="checkbox-container">
                <input type="checkbox" id="sharedMinistry">
                <label for="sharedMinistry">Shared in Ministry</label>
            </div>
        </div>
        <div id="auxiliaryPioneerCheckboxContainer" class="hidden">
            <div class="checkbox-container">
                <input type="checkbox" id="auxiliaryPioneerCheckbox">
                <label for="auxiliaryPioneerCheckbox">Auxiliary Pioneer</label>
            </div>
        </div>
        <label for="commentsAdd">Comments (Optional):</label>
        <textarea id="commentsAdd"></textarea>
        <div id="lastModifiedByAdd" class="last-modified"></div>
        <button id="saveReportBtn">Save Report</button>
        <button id="clearReportBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromReportBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromReport" class="logout-btn">Logout</button>
    </div>
    <div id="updateReportPage" class="page-container hidden">
        <h2>Update Field Service Report</h2>
        <label for="searchPublisherUpdate">Search Publisher:</label>
        <input type="text" id="searchPublisherUpdate" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxUpdate" class="suggestion-box"></div>
        <label for="publisherNameDropdownUpdate">Publisher Name:</label>
        <select id="publisherNameDropdownUpdate"></select>
        <label for="fieldGroupUpdate">Field Service Group:</label>
        <input type="text" id="fieldGroupUpdate" disabled>
        <label for="privilege2Update">Privilege 2:</label>
        <input type="text" id="privilege2Update" disabled>
        <label for="serviceYearDropdownUpdate">Service Year:</label>
        <select id="serviceYearDropdownUpdate"></select>
        <label for="monthYearDropdownUpdate">Month:</label>
        <select id="monthYearDropdownUpdate"></select>
        <hr style="margin: 20px 0;">
        <div id="updateReportFields" style="display: none;">
            <div id="fieldHoursContainerUpdate" class="hidden">
                <label for="fieldHoursUpdate">Field Hours:</label>
                <input type="number" id="fieldHoursUpdate" min="1">
            </div>
            <div id="bibleStudiesContainerUpdate" class="hidden">
                <label for="bibleStudiesUpdate">Bible Studies:</label>
                <input type="number" id="bibleStudiesUpdate" min="0">
            </div>
            <div id="sharedMinistryContainerUpdate" class="hidden">
                <div class="checkbox-container">
                    <input type="checkbox" id="sharedMinistryUpdate">
                    <label for="sharedMinistryUpdate">Shared in Ministry</label>
                </div>
            </div>
            <div id="auxiliaryPioneerCheckboxContainerUpdate" class="hidden">
                <div class="checkbox-container">
                    <input type="checkbox" id="auxiliaryPioneerCheckboxUpdate">
                    <label for="auxiliaryPioneerCheckboxUpdate">Auxiliary Pioneer</label>
                </div>
            </div>
            <label for="commentsUpdate">Comments (Optional):</label>
            <textarea id="commentsUpdate"></textarea>
            <div id="lastModifiedByUpdate" class="last-modified"></div>
        </div>
        <button id="updateReportBtn">Update</button>
        <button id="deleteReportBtn" class="delete-btn">Delete</button>
        <button id="clearUpdateFormBtn" class="clear-btn">Clear</button>
        <button id="backHomeFromUpdateBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromUpdate" class="logout-btn">Logout</button>
    </div>
    <div id="publisherPage" class="page-container hidden">
        <h2>Manage Publisher Records</h2>
        <input type="text" id="searchPublisher" placeholder="Search Publisher...">
        <div id="suggestionBox" class="suggestion-box"></div>
        <label for="firstName">First Name:</label>
        <input type="text" id="firstName">
        <label for="lastName">Last Name:</label>
        <input type="text" id="lastName">
        <label for="fullName">Full Name:</label>
        <input type="text" id="fullName" disabled>
        <label for="birthdate">Birthdate:</label>
        <input type="date" id="birthdate">
        <label for="baptismStatus">Baptism Status:</label>
        <select id="baptismStatus">
            <option value="">-- Select --</option>
            <option value="Baptized">Baptized</option>
            <option value="Baptized but can't remember the date">Baptized but can't remember the date</option>
            <option value="Unbaptized">Unbaptized</option>
        </select>
        <div id="baptismDateContainer" class="hidden">
            <label for="baptismDate">Baptism Date:</label>
            <input type="date" id="baptismDate">
        </div>
        <label for="gender">Gender:</label>
        <select id="gender">
            <option value="">-- Select --</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
        <label for="hope">Hope:</label>
        <select id="hope">
            <option value="">-- Select --</option>
            <option value="Anointed">Anointed</option>
            <option value="Other Sheep">Other Sheep</option>
        </select>
        <label for="privilege">Privilege:</label>
        <select id="privilege">
            <option value="">-- Select --</option>
            <option value="Not Applicable">Not Applicable</option>
            <option value="Ministerial Servant">Ministerial Servant</option>
            <option value="Elder">Elder</option>
        </select>
        <label for="privilege2">Privilege 2:</label>
        <select id="privilege2">
            <option value="">-- Select --</option>
            <option value="Regular Pioneer">Regular Pioneer</option>
            <option value="Special Pioneer">Special Pioneer</option>
            <option value="Field Missionary">Field Missionary</option>
            <option value="Continuous Auxiliary Pioneer">Continuous Auxiliary Pioneer</option>
            <option value="Publisher/Auxi">Publisher/Auxi</option>
        </select>
        <label for="fieldServiceGroup">Field Service Group:</label>
        <select id="fieldServiceGroup">
            <option value="">-- Select --</option>
            <option value="Field Service Group 1">Field Service Group 1</option>
            <option value="Field Service Group 2">Field Service Group 2</option>
            <option value="Field Service Group 3">Field Service Group 3</option>
            <option value="Field Service Group 4">Field Service Group 4</option>
            <option value="Field Service Group 5">Field Service Group 5</option>
            <option value="Field Service Group 6">Field Service Group 6</option>
            <option value="Field Service Group 7">Field Service Group 7</option>
            <option value="Field Service Group 8">Field Service Group 8</option>
        </select>
        <button id="addPublisherBtn">Add</button>
        <button id="updatePublisherBtn">Update</button>
        <button id="deletePublisherBtn" class="delete-btn">Delete</button>
        <button id="previousPublisherBtn">Previous</button>
        <button id="nextPublisherBtn">Next</button>
        <button id="clearPublisherFormBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromPublisherBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromPublisher" class="logout-btn">Logout</button>
    </div>
    <div id="submitRequestPage" class="page-container hidden">
        <h2>Submit Request to Update Report</h2>
        <h4>Who do you want to update?</h4>
        <label for="searchPublisherRequest">Search Publisher:</label>
        <input type="text" id="searchPublisherRequest" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxRequest" class="suggestion-box"></div>
        <label for="publisherNameDropdownRequest">Publisher Name:</label>
        <select id="publisherNameDropdownRequest"></select>
        <label for="fieldGroupRequest">Field Service Group:</label>
        <input type="text" id="fieldGroupRequest" disabled>
        <label for="privilege2Request">Privilege 2:</label>
        <input type="text" id="privilege2Request" disabled>
        <hr style="margin: 20px 0;">
        <h4>What Service Year and Month do you want to update?</h4>
        <label for="serviceYearRequest">Service Year:</label>
        <select id="serviceYearRequest"></select>
        <label for="monthYearRequest">Month:</label>
        <select id="monthYearRequest"></select>
        <div id="requestFields" style="display: none;">
            </div>
        <button id="submitRequestApprovalBtn">Submit Request for Admin Approval</button>
        <button id="clearRequestFormBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromRequestBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromRequest" class="logout-btn">Logout</button>
    </div>
    <div id="reviewApprovalsPage" class="page-container hidden">
        <h2>Review Approvals</h2>
        <div id="pendingRequestsList">
            <p id="noPendingRequestsLabel" class="hidden">Walang naka-pending na request sa ngayon.</p>
        </div>
        <button id="backHomeFromReviewBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromReview" class="logout-btn">Logout</button>
    </div>
    <div id="uploadPage" class="page-container hidden">
        <h2>Upload Field Service Reports</h2>
        <p>Please select an Excel (.xlsx, .xls) or .csv file. The format must match the one from "Export to Excel".</p>
        <input type="file" id="excelFileInput" class="hidden" accept=".xlsx, .xls, .csv">
        <button id="selectFileBtn">Select File</button>
        <div id="uploadStatus">
            <p>No file selected.</p>
        </div>
        <button id="processUploadBtn" disabled>Upload and Process Records</button>
        <hr>
        <button id="backHomeFromUploadBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromUpload" class="logout-btn">Logout</button>
    </div>
    <div id="uploadPublishersPage" class="page-container hidden">
        <h2>Upload Publishers</h2>
        <p>Please select an Excel (.xlsx, .xls) or .csv file. All columns are required.</p>
        <input type="file" id="excelFileInputPublishers" class="hidden" accept=".xlsx, .xls, .csv">
        <button id="selectFileBtnPublishers">Select File</button>
        <div id="uploadStatusPublishers">
            <p>No file selected.</p>
        </div>
        <button id="processUploadBtnPublishers" disabled>Upload and Process Publishers</button>
        <hr>
        <button id="backHomeFromUploadPublishersBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromUploadPublishers" class="logout-btn">Logout</button>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyDbKyWaYclW4jZ2eQ0qrK_PIfrh-7sahwY",
        authDomain: "field-service-reporter.firebaseapp.com",
        projectId: "field-service-reporter",
        storageBucket: "field-service-reporter.appspot.com",
        messagingSenderId: "434729902657",
        appId: "1:434729902657:web:c1b06d2695a47924f89cc0",
        measurementId: "G-9N52K2CGDD"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    const auth = firebase.auth(); 
    let publisherList = [];
    let currentIndex = -1;
    let currentDocId = null;
    let currentUser = null;
    let currentReportId = null; 
    let parsedExcelData = [];
    let adminPassword = null;
    let loginPage, homePage, addReportPage, publisherPage, updateReportPage, submitRequestPage, reviewApprovalsPage, uploadPage, uploadPublishersPage, manageAuxiliaryPage;
    let loggedInUser, adminButtons, userButtons, adminSection;
    let loginUsername, loginPassword;
    let serviceYearDropdown, monthYearDropdown;
    let fieldHoursContainer, fieldHoursInput, bibleStudiesContainer, bibleStudiesInput;
    let sharedMinistryContainer, sharedMinistryCheckbox, auxiliaryPioneerCheckboxContainer, auxiliaryPioneerCheckbox;
    let privilege2ReportInput, logoutBtnFromReport, searchPublisherReportInput, suggestionBoxReport, publisherNameDropdown, fieldGroupInput;
    let firstNameInput, lastNameInput, fullNameInput, birthdateInput, baptismStatusDropdown;
    let baptismDateContainer, baptismDateInput, genderDropdown, hopeDropdown, privilegeDropdown;
    let privilege2Dropdown, fieldServiceGroupDropdown;
    let addPublisherBtn, updatePublisherBtn, deletePublisherBtn, previousPublisherBtn, nextPublisherBtn;
    let clearPublisherFormBtn, backHomeFromPublisherBtn, logoutBtnFromPublisher, searchInputManage, suggestionBoxManage;
    let publisherNameDropdownUpdate, serviceYearDropdownUpdate, monthYearDropdownUpdate, searchPublisherUpdate, suggestionBoxUpdate;
    let fieldGroupUpdate, privilege2Update;
    let fieldHoursUpdate, bibleStudiesUpdate, sharedMinistryUpdate, auxiliaryPioneerCheckboxUpdate;
    let updateReportFieldsDiv;
    let fieldHoursContainerUpdate, bibleStudiesContainerUpdate, sharedMinistryContainerUpdate, auxiliaryPioneerCheckboxContainerUpdate;
    let updateReportBtn, deleteReportBtn, clearUpdateFormBtn, backHomeFromUpdateBtn, logoutBtnFromUpdate;
    let commentsAdd, lastModifiedByAdd, commentsUpdate, lastModifiedByUpdate;
    let searchPublisherRequest, suggestionBoxRequest, publisherNameDropdownRequest, fieldGroupRequest, privilege2Request;
    let serviceYearRequest, monthYearRequest, requestFields, submitRequestApprovalBtn, clearRequestFormBtn, backHomeFromRequestBtn, logoutBtnFromRequest;
    let pendingRequestsList, noPendingRequestsLabel;
    let selectFileBtn, excelFileInput, uploadStatus, processUploadBtn, backHomeFromUploadBtn, logoutBtnFromUpload;
    let selectFileBtnPublishers, excelFileInputPublishers, uploadStatusPublishers, processUploadBtnPublishers, backHomeFromUploadPublishersBtn, logoutBtnFromUploadPublishers;
    let searchPublisherAux, suggestionBoxAux, publisherNameDropdownAux, fieldGroupAux, privilege2Aux, serviceYearDropdownAux, monthYearDropdownAux, isAuxiliaryPioneerThisMonthAux, saveAuxStatusBtn, clearAuxFormBtn, backHomeFromAuxBtn, lastModifiedByAux;
        document.addEventListener("DOMContentLoaded", initializeApp);
    async function initializeApp() {
        getAllElements();
        attachAllListeners();
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDoc = await db.collection("users").doc(user.uid).get();
                if (userDoc.exists) {
                    currentUser = { uid: user.uid, email: user.email, role: userDoc.data().role };
                } else {
                    console.error("User document not found in Firestore. Signing out.");
                    await auth.signOut();
                    return;
                }
                await loadPublishers();
                handleRouteChange();
            } else {
                currentUser = null;
                publisherList = [];
                handleRouteChange();
            }
        });
    }
    function getAllElements() {
        loginPage = document.getElementById('loginPage');
        homePage = document.getElementById('homePage');
        addReportPage = document.getElementById('addReportPage');
        publisherPage = document.getElementById('publisherPage');
        updateReportPage = document.getElementById('updateReportPage');
        submitRequestPage = document.getElementById('submitRequestPage');
        reviewApprovalsPage = document.getElementById('reviewApprovalsPage');
        uploadPage = document.getElementById('uploadPage');
        uploadPublishersPage = document.getElementById('uploadPublishersPage');
        manageAuxiliaryPage = document.getElementById('manageAuxiliaryPage');
        loggedInUser = document.getElementById('loggedInUser');
        adminButtons = document.getElementById('adminButtons');
        userButtons = document.getElementById('userButtons');
        adminSection = document.getElementById('adminSection');
        loginUsername = document.getElementById('loginUsername');
        loginPassword = document.getElementById('loginPassword');
        serviceYearDropdown = document.getElementById("serviceYearDropdown");
        monthYearDropdown = document.getElementById("monthYearDropdown");
        fieldHoursContainer = document.getElementById("fieldHoursContainer");
        fieldHoursInput = document.getElementById("fieldHours");
        bibleStudiesContainer = document.getElementById("bibleStudiesContainer");
        bibleStudiesInput = document.getElementById("bibleStudies");
        sharedMinistryContainer = document.getElementById("sharedMinistryContainer");
        sharedMinistryCheckbox = document.getElementById("sharedMinistry");
        auxiliaryPioneerCheckboxContainer = document.getElementById("auxiliaryPioneerCheckboxContainer");
        auxiliaryPioneerCheckbox = document.getElementById("auxiliaryPioneerCheckbox");
        privilege2ReportInput = document.getElementById("privilege2Report");
        searchPublisherReportInput = document.getElementById("searchPublisherReport");
        suggestionBoxReport = document.getElementById("suggestionBoxReport");
        publisherNameDropdown = document.getElementById("publisherNameDropdown");
        fieldGroupInput = document.getElementById("fieldGroup");
        logoutBtnFromReport = document.getElementById("logoutBtnFromReport");
        commentsAdd = document.getElementById('commentsAdd');
        lastModifiedByAdd = document.getElementById('lastModifiedByAdd');
        firstNameInput = document.getElementById("firstName");
        lastNameInput = document.getElementById("lastName");
        fullNameInput = document.getElementById("fullName");
        birthdateInput = document.getElementById("birthdate");
        baptismStatusDropdown = document.getElementById("baptismStatus");
        baptismDateContainer = document.getElementById("baptismDateContainer");
        baptismDateInput = document.getElementById("baptismDate");
        genderDropdown = document.getElementById("gender");
        hopeDropdown = document.getElementById("hope");
        privilegeDropdown = document.getElementById("privilege");
        privilege2Dropdown = document.getElementById("privilege2");
        fieldServiceGroupDropdown = document.getElementById("fieldServiceGroup");
        addPublisherBtn = document.getElementById("addPublisherBtn");
        updatePublisherBtn = document.getElementById("updatePublisherBtn");
        deletePublisherBtn = document.getElementById("deletePublisherBtn");
        previousPublisherBtn = document.getElementById("previousPublisherBtn");
        nextPublisherBtn = document.getElementById("nextPublisherBtn");
        clearPublisherFormBtn = document.getElementById("clearPublisherFormBtn");
        backHomeFromPublisherBtn = document.getElementById("backHomeFromPublisherBtn");
        logoutBtnFromPublisher = document.getElementById("logoutBtnFromPublisher");
        searchInputManage = document.getElementById("searchPublisher");
        suggestionBoxManage = document.getElementById("suggestionBox");
        publisherNameDropdownUpdate = document.getElementById('publisherNameDropdownUpdate');
        serviceYearDropdownUpdate = document.getElementById('serviceYearDropdownUpdate');
        monthYearDropdownUpdate = document.getElementById('monthYearDropdownUpdate');
        searchPublisherUpdate = document.getElementById('searchPublisherUpdate');
        suggestionBoxUpdate = document.getElementById('suggestionBoxUpdate');
        fieldGroupUpdate = document.getElementById('fieldGroupUpdate');
        privilege2Update = document.getElementById('privilege2Update');
        updateReportFieldsDiv = document.getElementById('updateReportFields');
        fieldHoursUpdate = document.getElementById('fieldHoursUpdate');
        bibleStudiesUpdate = document.getElementById('bibleStudiesUpdate');
        sharedMinistryUpdate = document.getElementById('sharedMinistryUpdate');
        auxiliaryPioneerCheckboxUpdate = document.getElementById('auxiliaryPioneerCheckboxUpdate');
        fieldHoursContainerUpdate = document.getElementById('fieldHoursContainerUpdate');
        bibleStudiesContainerUpdate = document.getElementById('bibleStudiesContainerUpdate');
        sharedMinistryContainerUpdate = document.getElementById('sharedMinistryContainerUpdate');
        auxiliaryPioneerCheckboxContainerUpdate = document.getElementById('auxiliaryPioneerCheckboxContainerUpdate');
        updateReportBtn = document.getElementById('updateReportBtn');
        deleteReportBtn = document.getElementById('deleteReportBtn');
        clearUpdateFormBtn = document.getElementById('clearUpdateFormBtn');
        backHomeFromUpdateBtn = document.getElementById('backHomeFromUpdateBtn');
        logoutBtnFromUpdate = document.getElementById('logoutBtnFromUpdate');
        commentsUpdate = document.getElementById('commentsUpdate');
        lastModifiedByUpdate = document.getElementById('lastModifiedByUpdate');
        searchPublisherRequest = document.getElementById('searchPublisherRequest');
        suggestionBoxRequest = document.getElementById('suggestionBoxRequest');
        publisherNameDropdownRequest = document.getElementById('publisherNameDropdownRequest');
        fieldGroupRequest = document.getElementById('fieldGroupRequest');
        privilege2Request = document.getElementById('privilege2Request');
        serviceYearRequest = document.getElementById('serviceYearRequest');
        monthYearRequest = document.getElementById('monthYearRequest');
        requestFields = document.getElementById('requestFields');
        submitRequestApprovalBtn = document.getElementById('submitRequestApprovalBtn');
        clearRequestFormBtn = document.getElementById('clearRequestFormBtn');
        backHomeFromRequestBtn = document.getElementById('backHomeFromRequestBtn');
        logoutBtnFromRequest = document.getElementById('logoutBtnFromRequest');
        pendingRequestsList = document.getElementById('pendingRequestsList');
        noPendingRequestsLabel = document.getElementById('noPendingRequestsLabel');
        selectFileBtn = document.getElementById('selectFileBtn');
        excelFileInput = document.getElementById('excelFileInput');
        uploadStatus = document.getElementById('uploadStatus');
        processUploadBtn = document.getElementById('processUploadBtn');
        backHomeFromUploadBtn = document.getElementById('backHomeFromUploadBtn');
        logoutBtnFromUpload = document.getElementById('logoutBtnFromUpload');
        selectFileBtnPublishers = document.getElementById('selectFileBtnPublishers');
        excelFileInputPublishers = document.getElementById('excelFileInputPublishers');
        uploadStatusPublishers = document.getElementById('uploadStatusPublishers');
        processUploadBtnPublishers = document.getElementById('processUploadBtnPublishers');
        backHomeFromUploadPublishersBtn = document.getElementById('backHomeFromUploadPublishersBtn');
        logoutBtnFromUploadPublishers = document.getElementById('logoutBtnFromUploadPublishers');
        searchPublisherAux = document.getElementById('searchPublisherAux');
        suggestionBoxAux = document.getElementById('suggestionBoxAux');
        publisherNameDropdownAux = document.getElementById('publisherNameDropdownAux');
        fieldGroupAux = document.getElementById('fieldGroupAux');
        privilege2Aux = document.getElementById('privilege2Aux');
        serviceYearDropdownAux = document.getElementById('serviceYearDropdownAux');
        monthYearDropdownAux = document.getElementById('monthYearDropdownAux');
        isAuxiliaryPioneerThisMonthAux = document.getElementById('isAuxiliaryPioneerThisMonthAux');
        saveAuxStatusBtn = document.getElementById('saveAuxStatusBtn');
        clearAuxFormBtn = document.getElementById('clearAuxFormBtn');
        backHomeFromAuxBtn = document.getElementById('backHomeFromAuxBtn');
        lastModifiedByAux = document.getElementById('lastModifiedByAux');
    }
        function attachAllListeners() {
        document.getElementById("loginBtn")?.addEventListener("click", login);
        document.getElementById("logoutBtn")?.addEventListener("click", logout);
        document.getElementById("managePublisherBtn")?.addEventListener("click", () => showPage('publisherPage'));
        document.getElementById("manageAuxiliaryPioneerBtn")?.addEventListener("click", () => showPage('manageAuxiliaryPage'));
        document.getElementById("addReportBtnAdmin")?.addEventListener("click", () => showPage('addReportPage'));
        document.getElementById("updateReportPageBtn")?.addEventListener("click", () => showPage('updateReportPage'));
        document.getElementById("reviewApprovalsBtn")?.addEventListener("click", () => showPage('reviewApprovalsPage'));
        document.getElementById("exportExcelBtn")?.addEventListener("click", exportToExcel);
        document.getElementById("uploadReportsBtn")?.addEventListener("click", () => promptForAdminPassword(() => showPage('uploadPage')));
        document.getElementById("uploadPublishersBtn")?.addEventListener("click", () => promptForAdminPassword(() => showPage('uploadPublishersPage')));
        document.getElementById("clearAllDataBtn")?.addEventListener("click", () => promptForAdminPassword(clearAllData));
        document.getElementById("addReportBtnUser")?.addEventListener("click", () => showPage('addReportPage'));
        document.getElementById("submitRequestPageBtn")?.addEventListener("click", () => showPage('submitRequestPage'));
        document.getElementById("backHomeFromReportBtn")?.addEventListener("click", () => showPage('homePage'));
        document.getElementById("backHomeFromPublisherBtn")?.addEventListener("click", () => showPage('homePage'));
        document.getElementById("backHomeFromUpdateBtn")?.addEventListener("click", () => showPage('homePage'));
        document.getElementById("backHomeFromRequestBtn")?.addEventListener("click", () => showPage('homePage'));
        document.getElementById("backHomeFromReviewBtn")?.addEventListener('click', () => showPage('homePage'));
        document.getElementById("backHomeFromUploadBtn")?.addEventListener('click', () => showPage('homePage'));
        document.getElementById("backHomeFromUploadPublishersBtn")?.addEventListener('click', () => showPage('homePage'));
        backHomeFromAuxBtn?.addEventListener("click", () => showPage('homePage'));
        document.getElementById("saveReportBtn")?.addEventListener("click", saveReport);
        document.getElementById("clearReportBtn")?.addEventListener("click", clearAddReportForm);
        logoutBtnFromReport?.addEventListener("click", logout);
        addPublisherBtn?.addEventListener("click", addPublisher);
        updatePublisherBtn?.addEventListener("click", updatePublisher);
        deletePublisherBtn?.addEventListener("click", deletePublisher);
        previousPublisherBtn?.addEventListener("click", previousPublisher);
        nextPublisherBtn?.addEventListener("click", nextPublisher);
        clearPublisherFormBtn?.addEventListener("click", clearPublisherForm);
        logoutBtnFromPublisher?.addEventListener("click", logout);
        firstNameInput?.addEventListener("input", updateFullName);
        lastNameInput?.addEventListener("input", updateFullName);
        baptismStatusDropdown?.addEventListener("change", toggleBaptismDate);
        updateReportBtn?.addEventListener("click", updateReport);
        deleteReportBtn?.addEventListener("click", deleteReport);
        clearUpdateFormBtn?.addEventListener("click", clearUpdateFormBtn);
        logoutBtnFromUpdate?.addEventListener("click", logout);
        submitRequestApprovalBtn?.addEventListener('click', submitRequestForApproval);
        clearRequestFormBtn?.addEventListener('click', clearSubmitRequestForm);
        logoutBtnFromRequest?.addEventListener('click', logout);
        document.getElementById("logoutBtnFromReview")?.addEventListener("click", logout);
        selectFileBtn?.addEventListener('click', () => excelFileInput.click());
        excelFileInput?.addEventListener('change', handleFileSelect);
        processUploadBtn?.addEventListener('click', processAndUploadRecords);
        logoutBtnFromUpload?.addEventListener('click', logout);
        selectFileBtnPublishers?.addEventListener('click', () => excelFileInputPublishers.click());
        excelFileInputPublishers?.addEventListener('change', handlePublisherFileSelect);
        processUploadBtnPublishers?.addEventListener('click', processAndUploadPublishers);
        logoutBtnFromUploadPublishers?.addEventListener('click', logout);
        saveAuxStatusBtn?.addEventListener("click", saveAuxiliaryStatus);
        clearAuxFormBtn?.addEventListener("click", clearManageAuxiliaryForm);
    }
    function showPage(pageId) {
        document.querySelectorAll('.page-container').forEach(page => page.classList.add('hidden'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.remove('hidden');
        }
        if (pageId === 'homePage') { updateHomePage(); } 
        else if (pageId === 'addReportPage') { setupAddReportPage(); } 
        else if (pageId === 'publisherPage') { setupManagePublisherPage(); } 
        else if (pageId === 'updateReportPage') { setupUpdateReportPage(); }
        else if (pageId === 'submitRequestPage') { setupSubmitRequestPage(); }
        else if (pageId === 'reviewApprovalsPage') { setupReviewApprovalsPage(); }
        else if (pageId === 'uploadPage') { setupUploadPage(); }
        else if (pageId === 'uploadPublishersPage') { setupUploadPublishersPage(); }
        else if (pageId === 'manageAuxiliaryPage') { setupManageAuxiliaryPage(); }
    }
    function handleRouteChange() {
        if (currentUser) {
            showPage('homePage');
        } else {
            showPage('loginPage');
        }
    }
        async function login() {
        const email = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) {
            alert("Please enter both email and password.");
            return;
        }
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error("Login failed:", error);
            alert("Invalid email or password.");
        }
    }
    async function logout() {
        try {
            await auth.signOut();
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showPage('loginPage');
        } catch (error) {
            console.error("Logout failed:", error);
        }
    }
    async function fetchAdminPassword() {
        if (adminPassword) return;
        try {
            const doc = await db.collection("config").doc("admin_settings").get();
            if (doc.exists) {
                adminPassword = doc.data().adminPassword;
            } else {
                console.warn("Admin password not set in Firestore.");
            }
        } catch (error) {
            console.error("Error fetching admin password:", error);
        }
    }
    async function promptForAdminPassword(callbackFunction) {
        if (currentUser?.role !== 'admin') {
            alert("This action is for admins only.");
            return;
        }
        await fetchAdminPassword();
        if (!adminPassword) {
            alert("Admin password configuration is missing. Please set it up in Firebase Firestore.");
            return;
        }
        const input = prompt("This is a sensitive action. Please enter the admin password to proceed:");
        if (input === null) return;
        if (input === adminPassword) {
            callbackFunction();
        } else {
            alert("Incorrect password. Action cancelled.");
        }
    }
    async function clearAllData() {
        if (confirm("Are you sure you want to delete ALL data? This cannot be undone.")) {
            try {
                const publishers = await db.collection("publishers").get();
                const reports = await db.collection("reports").get();
                const batch = db.batch();
                publishers.forEach(doc => batch.delete(doc.ref));
                reports.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                alert("All publisher and report records deleted.");
                publisherList = [];
                clearPublisherForm();
                clearAddReportForm();
                clearUpdateReportForm();
            } catch (error) { console.error("Error clearing data:", error); alert("Failed to clear data."); }
        }
    }
        async function exportToExcel() {
        try {
            const snapshot = await db.collection("reports").orderBy("publisherFullName", "asc").get();
            if (snapshot.empty) {
                alert("No reports found to export.");
                return;
            }
            const reports = snapshot.docs.map(doc => doc.data());
            const headers = [ "Publisher Name", "Service Year", "Month", "Field Service Group", "Privilege at Time of Report", "Hours", "Bible Studies", "Shared in Ministry", "Was Auxiliary Pioneer", "Comments", "Last Modified By" ];
            let csvContent = headers.join(",") + "\n";
            reports.forEach(report => {
                const comments = report.comments ? report.comments.replace(/"/g, '""') : '';
                const row = [ 
                    `"\u200B${report.publisherFullName || ''}"`, 
                    `"\u200B${report.serviceYear || ''}"`, 
                    `"\u200B${report.month || ''}"`, 
                    `"\u200B${report.fieldServiceGroup || ''}"`, 
                    `"\u200B${report.privilege2AtTimeOfReport || ''}"`, 
                    report.hours || 0, 
                    report.bibleStudies || 0, 
                    report.sharedInMinistry ? 'Yes' : 'No', 
                    report.wasAuxiliaryPioneer ? 'Yes' : 'No',
                    `"${comments}"`,
                    `"\u200B${report.lastModifiedBy || ''}"`
                ];
                csvContent += row.join(",") + "\n";
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const dateStr = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `Field_Service_Reports_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("Error exporting to Excel:", error);
            alert("An error occurred during export. Please check the console.");
        }
    }
    async function updateHomePage() {
        if (currentUser) {
            document.getElementById('loggedInUser').textContent = currentUser.email;
            const reviewApprovalsBtn = document.getElementById('reviewApprovalsBtn');
            if (currentUser.role === 'admin') {
                document.getElementById('adminButtons').classList.remove('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
                document.getElementById('userButtons').classList.add('hidden');
                fetchAdminPassword();
                try {
                    const snapshot = await db.collection('updateRequests').where('status', '==', 'pending').get();
                    reviewApprovalsBtn.textContent = `Review Approvals ${snapshot.size > 0 ? `(${snapshot.size})` : ''}`;
                } catch(e) {
                    console.error("Could not fetch request count", e);
                    reviewApprovalsBtn.textContent = "Review Approvals";
                }
            } else { 
                document.getElementById('adminButtons').classList.add('hidden');
                document.getElementById('adminSection').classList.add('hidden');
                document.getElementById('userButtons').classList.remove('hidden');
            }
        }
    }
    async function loadPublishers() {
        try {
            const snapshot = await db.collection("publishers").orderBy("fullName", "asc").get();
            publisherList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) { console.error("Error loading publishers:", error); }
    }
        function setupManageAuxiliaryPage() {
        clearManageAuxiliaryForm();
        publisherNameDropdownAux.innerHTML = '<option value="">-- Select Publisher --</option>';
        const auxiPublishers = publisherList.filter(p => p.privilege2 === 'Publisher/Auxi');
        auxiPublishers.forEach(pub => {
            const opt = document.createElement("option");
            opt.value = pub.id;
            opt.textContent = pub.fullName;
            publisherNameDropdownAux.appendChild(opt);
        });
        populateServiceYears(serviceYearDropdownAux);
        const fetchAndDisplayCurrentStatus = async () => {
            const publisherId = publisherNameDropdownAux.value;
            const serviceYear = serviceYearDropdownAux.value;
            const month = monthYearDropdownAux.value;
            isAuxiliaryPioneerThisMonthAux.value = "";
            lastModifiedByAux.textContent = "";
            if (!publisherId || !serviceYear || !month) return;
            const docId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
            try {
                const docSnap = await db.collection("auxiliary_status").doc(docId).get();
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    isAuxiliaryPioneerThisMonthAux.value = data.isAuxiliary ? "Yes" : "No";
                    lastModifiedByAux.textContent = data.lastModifiedBy ? `Last set by: ${data.lastModifiedBy}` : '';
                }
            } catch (e) { console.error("Error fetching status", e); }
        };
        const handlePublisherSelection = () => {
            const selected = publisherList.find(p => p.id === publisherNameDropdownAux.value);
            if(selected) {
                fieldGroupAux.value = selected.fieldServiceGroup || '';
                privilege2Aux.value = selected.privilege2 || '';
            } else {
                fieldGroupAux.value = '';
                privilege2Aux.value = '';
            }
            fetchAndDisplayCurrentStatus();
        };
        publisherNameDropdownAux.addEventListener('change', handlePublisherSelection);
        serviceYearDropdownAux.addEventListener('change', () => {
            populateMonths(monthYearDropdownAux, serviceYearDropdownAux.value);
            fetchAndDisplayCurrentStatus();
        });
        monthYearDropdownAux.addEventListener('change', fetchAndDisplayCurrentStatus);
        searchPublisherAux.addEventListener("input", function () {
            const query = this.value.toLowerCase();
            suggestionBoxAux.innerHTML = "";
            if (!query) return;
            const matches = auxiPublishers.filter(pub => pub.fullName.toLowerCase().includes(query));
            matches.forEach(pub => {
                const div = document.createElement("div");
                div.textContent = pub.fullName;
                div.classList.add("suggestion-item");
                div.addEventListener("click", () => {
                    this.value = pub.fullName;
                    suggestionBoxAux.innerHTML = "";
                    publisherNameDropdownAux.value = pub.id;
                    publisherNameDropdownAux.dispatchEvent(new Event('change'));
                });
                suggestionBoxAux.appendChild(div);
            });
        });
    }
    function clearManageAuxiliaryForm() {
        publisherNameDropdownAux.value = "";
        serviceYearDropdownAux.value = "";
        monthYearDropdownAux.innerHTML = '<option value="">-- Select Month --</option>';
        searchPublisherAux.value = "";
        fieldGroupAux.value = "";
        privilege2Aux.value = "";
        isAuxiliaryPioneerThisMonthAux.value = "";
        lastModifiedByAux.textContent = "";
        suggestionBoxAux.innerHTML = "";
    }
    async function saveAuxiliaryStatus() {
        const publisherId = publisherNameDropdownAux.value;
        const serviceYear = serviceYearDropdownAux.value;
        const month = monthYearDropdownAux.value;
        const status = isAuxiliaryPioneerThisMonthAux.value;
        if (!publisherId || !serviceYear || !month || !status) {
            alert("Please complete all fields before saving.");
            return;
        }
        const docId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
        const publisherFullName = publisherNameDropdownAux.options[publisherNameDropdownAux.selectedIndex].text;
        const statusData = {
            publisherId: publisherId,
            publisherFullName: publisherFullName,
            serviceYear: serviceYear,
            month: month,
            isAuxiliary: status === "Yes",
            lastModifiedBy: currentUser.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection("auxiliary_status").doc(docId).set(statusData, { merge: true });
            alert(`Status for ${publisherFullName} for ${month} has been saved as '${status}'.`);
            lastModifiedByAux.textContent = `Last set by: ${currentUser.email}`;
        } catch (error) {
            console.error("Error saving auxiliary status: ", error);
            alert("An error occurred while saving the status.");
        }
    }
        async function handleReportFieldLogic(elements, publisherId, serviceYear, month) {
        elements.fieldHoursContainer.classList.add("hidden");
        elements.bibleStudiesContainer.classList.add("hidden");
        elements.sharedMinistryContainer.classList.add("hidden");
        elements.auxiliaryPioneerCheckboxContainer.classList.add("hidden");
        elements.fieldHoursInput.value = "";
        elements.bibleStudiesInput.value = "";
        elements.sharedMinistryCheckbox.checked = false;
        elements.auxiliaryPioneerCheckbox.checked = false;
        elements.sharedMinistryCheckbox.disabled = false;
        elements.auxiliaryPioneerCheckbox.disabled = false;
        const handleHoursInput_Standard = () => {
            let value = elements.fieldHoursInput.value.replace(/\D/g, '');
            if (value && parseInt(value, 10) === 0) { value = ''; }
            elements.fieldHoursInput.value = value;
            elements.sharedMinistryCheckbox.checked = parseInt(value, 10) > 0;
        };
        const handleHoursInput_WithAux = () => {
            let value = elements.fieldHoursInput.value.replace(/\D/g, '');
            if (value && parseInt(value, 10) === 0) { value = ''; }
            elements.fieldHoursInput.value = value;
            const hasHours = parseInt(value, 10) > 0;
            elements.sharedMinistryCheckbox.checked = hasHours;
            elements.auxiliaryPioneerCheckbox.checked = hasHours;
        };
        const handleStudiesInput = () => { elements.bibleStudiesInput.value = elements.bibleStudiesInput.value.replace(/\D/g, ''); };
        elements.fieldHoursInput.oninput = null;
        elements.bibleStudiesInput.oninput = null;
        const privilege2 = elements.privilegeInput.value;
        switch (privilege2) {
            case "Regular Pioneer": case "Special Pioneer": case "Field Missionary":
                elements.fieldHoursContainer.classList.remove("hidden");
                elements.bibleStudiesContainer.classList.remove("hidden");
                elements.sharedMinistryContainer.classList.remove("hidden");
                elements.sharedMinistryCheckbox.disabled = true;
                elements.fieldHoursInput.oninput = handleHoursInput_Standard;
                elements.bibleStudiesInput.oninput = handleStudiesInput;
                break;
            case "Continuous Auxiliary Pioneer":
                elements.fieldHoursContainer.classList.remove("hidden");
                elements.bibleStudiesContainer.classList.remove("hidden");
                elements.sharedMinistryContainer.classList.remove("hidden");
                elements.auxiliaryPioneerCheckboxContainer.classList.remove("hidden");
                elements.sharedMinistryCheckbox.disabled = true;
                elements.auxiliaryPioneerCheckbox.disabled = true;
                elements.fieldHoursInput.oninput = handleHoursInput_WithAux;
                elements.bibleStudiesInput.oninput = handleStudiesInput;
                break;
            case "Publisher/Auxi":
                if (!publisherId || !serviceYear || !month) break;
                const docId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
                const auxStatusRef = db.collection("auxiliary_status").doc(docId);
                let isAux = false;
                try {
                    const docSnap = await auxStatusRef.get();
                    if (docSnap.exists() && docSnap.data().isAuxiliary) {
                        isAux = true;
                    }
                } catch (e) { console.error("Error fetching aux status", e); }
                if (isAux) {
                    elements.fieldHoursContainer.classList.remove("hidden");
                    elements.bibleStudiesContainer.classList.remove("hidden");
                    elements.sharedMinistryContainer.classList.remove("hidden");
                    elements.auxiliaryPioneerCheckboxContainer.classList.remove("hidden");
                    elements.sharedMinistryCheckbox.disabled = true;
                    elements.auxiliaryPioneerCheckbox.disabled = true;
                    elements.fieldHoursInput.oninput = handleHoursInput_WithAux;
                    elements.bibleStudiesInput.oninput = handleStudiesInput;
                } else {
                    elements.bibleStudiesContainer.classList.remove("hidden");
                    elements.sharedMinistryContainer.classList.remove("hidden");
                    elements.sharedMinistryCheckbox.disabled = false;
                    elements.bibleStudiesInput.oninput = handleStudiesInput;
                }
                break;
        }
    }
        function setupAddReportPage() {
        clearAddReportForm();
        serviceYearDropdown.disabled = false;
        monthYearDropdown.disabled = false;
        publisherNameDropdown.disabled = false;
        searchPublisherReport.classList.remove('hidden');
        publisherNameDropdown.innerHTML = '<option value="">-- Select Publisher --</option>';
        publisherList.forEach(pub => {
            const opt = document.createElement("option");
            opt.value = pub.id;
            opt.textContent = pub.fullName || `${pub.lastName}, ${pub.firstName}`;
            publisherNameDropdown.appendChild(opt);
        });
        populateServiceYears(serviceYearDropdown);
        if (currentUser.role === 'user') {
            publisherNameDropdown.disabled = false;
            searchPublisherReport.classList.remove('hidden');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            let serviceYear = (currentMonth >= 8) ? currentYear + 1 : currentYear;
            serviceYearDropdown.value = serviceYear;
            serviceYearDropdown.disabled = true;
            populateMonths(monthYearDropdown, serviceYear);
            const prevMonthDate = new Date();
            prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
            const prevMonthName = prevMonthDate.toLocaleString('en-US', { month: 'long' });
            const prevMonthYear = prevMonthDate.getFullYear();
            monthYearDropdown.value = `${prevMonthName} ${prevMonthYear}`;
            monthYearDropdown.disabled = true;
            autofillPublisherDetails(publisherNameDropdown.value);
        } 
        searchPublisherReportInput.addEventListener("input", function () {
            const query = this.value.toLowerCase();
            suggestionBoxReport.innerHTML = "";
            if (!query) return;
            const matches = publisherList.filter(pub => pub.fullName.toLowerCase().includes(query));
            matches.forEach(pub => {
                const div = document.createElement("div");
                div.textContent = pub.fullName;
                div.classList.add("suggestion-item");
                div.addEventListener("click", () => {
                    this.value = pub.fullName;
                    suggestionBoxReport.innerHTML = "";
                    publisherNameDropdown.value = pub.id;
                    autofillPublisherDetails(pub.id);
                });
                suggestionBoxReport.appendChild(div);
            });
        });
        publisherNameDropdown.addEventListener("change", async () => await autofillPublisherDetails(publisherNameDropdown.value));
        serviceYearDropdown.addEventListener("change", async () => {
            populateMonths(monthYearDropdown, serviceYearDropdown.value);
            await updateReportFieldsVisibility();
        });
        monthYearDropdown.addEventListener("change", async () => await updateReportFieldsVisibility());
    }
    async function autofillPublisherDetails(publisherId) {
        const selectedPublisher = publisherList.find(pub => pub.id === publisherId);
        if (selectedPublisher) {
            fieldGroupInput.value = selectedPublisher.fieldServiceGroup || "";
            privilege2ReportInput.value = selectedPublisher.privilege2 || "";
        } else {
            fieldGroupInput.value = "";
            privilege2ReportInput.value = "";
        }
        await updateReportFieldsVisibility();
    }
    function clearAddReportForm() {
        suggestionBoxReport.innerHTML = "";
        fieldGroupInput.value = "";
        privilege2ReportInput.value = "";
        commentsAdd.value = "";
        lastModifiedByAdd.textContent = "";
        searchPublisherReportInput.value = "";
        publisherNameDropdown.value = "";
        if (currentUser.role === 'admin') {
            serviceYearDropdown.value = "";
            monthYearDropdown.innerHTML = '<option value="">-- Select Month --</option>';
        }
        updateReportFieldsVisibility();
    }
    async function updateReportFieldsVisibility() {
        const publisherId = publisherNameDropdown.value;
        const serviceYear = serviceYearDropdown.value;
        const month = monthYearDropdown.value;
        await handleReportFieldLogic({
            privilegeInput: privilege2ReportInput, fieldHoursContainer, fieldHoursInput, bibleStudiesContainer, bibleStudiesInput, sharedMinistryContainer, sharedMinistryCheckbox, auxiliaryPioneerCheckboxContainer, auxiliaryPioneerCheckbox
        }, publisherId, serviceYear, month);
    }
    async function updateReportFieldsVisibility_UpdatePage() {
        const publisherId = publisherNameDropdownUpdate.value;
        const serviceYear = serviceYearDropdownUpdate.value;
        const month = monthYearDropdownUpdate.value;
        await handleReportFieldLogic({
             privilegeInput: privilege2Update, fieldHoursContainer: fieldHoursContainerUpdate, fieldHoursInput: fieldHoursUpdate, bibleStudiesContainer: bibleStudiesContainerUpdate, bibleStudiesInput: bibleStudiesUpdate, sharedMinistryContainer: sharedMinistryContainerUpdate, sharedMinistryCheckbox: sharedMinistryUpdate, auxiliaryPioneerCheckboxContainer: auxiliaryPioneerCheckboxContainerUpdate, auxiliaryPioneerCheckbox: auxiliaryPioneerCheckboxUpdate
        }, publisherId, serviceYear, month);
    }
        async function saveReport() {
        if (!publisherNameDropdown.value) { alert("Validation Error: Please select a publisher."); return; }
        if (!serviceYearDropdown.value) { alert("Validation Error: Please select a service year."); return; }
        if (!monthYearDropdown.value) { alert("Validation Error: Please select a month."); return; }
        const privilege = privilege2ReportInput.value;
        const isPioneerType = ["Regular Pioneer", "Special Pioneer", "Field Missionary", "Continuous Auxiliary Pioneer"].includes(privilege);
        const isAuxiThisMonth = auxiliaryPioneerCheckbox.checked;
        if ((isPioneerType || isAuxiThisMonth) && !fieldHoursInput.value) {
            alert("Validation Error: Please enter the number of hours."); return;
        }
        if (!bibleStudiesContainer.classList.contains('hidden') && !bibleStudiesInput.value) {
             alert("Validation Error: Please enter the number of bible studies."); return;
        }
        const publisherId = publisherNameDropdown.value;
        const serviceYear = serviceYearDropdown.value;
        const month = monthYearDropdown.value;
        const publisherFullName = publisherNameDropdown.options[publisherNameDropdown.selectedIndex].text;
        const reportId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
        const reportRef = db.collection("reports").doc(reportId);
        try {
            const doc = await reportRef.get();
            if (doc.exists) { alert("Error: A report for this publisher, service year, and month already exists."); return; }
            const reportData = {
                publisherId: publisherId, publisherFullName: publisherFullName, serviceYear: serviceYear, month: month, fieldServiceGroup: fieldGroupInput.value, privilege2AtTimeOfReport: privilege2ReportInput.value, hours: fieldHoursInput.value ? parseInt(fieldHoursInput.value) : 0, bibleStudies: bibleStudiesInput.value ? parseInt(bibleStudiesInput.value) : 0, sharedInMinistry: sharedMinistryCheckbox.checked, wasAuxiliaryPioneer: auxiliaryPioneerCheckbox.checked, 
                comments: commentsAdd.value,
                lastModifiedBy: currentUser.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await reportRef.set(reportData);
            alert("Report saved successfully!");
            clearAddReportForm();
        } catch (error) { console.error("Error saving report: ", error); alert("An error occurred while saving the report."); }
    }
    function setupUpdateReportPage() {
        clearUpdateReportForm(); 
        publisherNameDropdownUpdate.innerHTML = '<option value="">-- Select Publisher --</option>';
        publisherList.forEach(pub => {
            const opt = document.createElement("option");
            opt.value = pub.id;
            opt.textContent = pub.fullName;
            publisherNameDropdownUpdate.appendChild(opt);
        });
        populateServiceYears(serviceYearDropdownUpdate);
        searchPublisherUpdate.addEventListener("input", function () {
            const query = this.value.toLowerCase();
            suggestionBoxUpdate.innerHTML = "";
            if (!query) return;
            const matches = publisherList.filter(pub => pub.fullName.toLowerCase().includes(query));
            matches.forEach(pub => {
                const div = document.createElement("div");
                div.textContent = pub.fullName;
                div.classList.add("suggestion-item");
                div.addEventListener("click", () => {
                    this.value = pub.fullName;
                    suggestionBoxUpdate.innerHTML = "";
                    publisherNameDropdownUpdate.value = pub.id;
                    publisherNameDropdownUpdate.dispatchEvent(new Event('change'));
                });
                suggestionBoxUpdate.appendChild(div);
            });
        });
        const handlePublisherSelection = async () => {
            const selectedPublisher = publisherList.find(p => p.id === publisherNameDropdownUpdate.value);
            if(selectedPublisher) {
                fieldGroupUpdate.value = selectedPublisher.fieldServiceGroup || '';
                privilege2Update.value = selectedPublisher.privilege2 || '';
            } else {
                fieldGroupUpdate.value = '';
                privilege2Update.value = '';
            }
            await fetchReportData();
        }
        publisherNameDropdownUpdate.addEventListener('change', handlePublisherSelection);
        serviceYearDropdownUpdate.addEventListener('change', async () => {
            populateMonths(monthYearDropdownUpdate, serviceYearDropdownUpdate.value);
            await fetchReportData();
        });
        monthYearDropdownUpdate.addEventListener('change', fetchReportData);
    }
    async function fetchReportData() {
        const publisherId = publisherNameDropdownUpdate.value;
        const serviceYear = serviceYearDropdownUpdate.value;
        const month = monthYearDropdownUpdate.value;
        if (!publisherId || !serviceYear || !month) {
             clearUpdateReportForm(false);
             return;
        }
        const reportId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
        const reportRef = db.collection("reports").doc(reportId);
        try {
            const doc = await reportRef.get();
            if (doc.exists) {
                const data = doc.data();
                currentReportId = doc.id;
                await updateReportFieldsVisibility_UpdatePage();
                updateReportFieldsDiv.style.display = 'block';
                fieldHoursUpdate.value = data.hours || '';
                bibleStudiesUpdate.value = data.bibleStudies || '';
                sharedMinistryUpdate.checked = data.sharedInMinistry || false;
                auxiliaryPioneerCheckboxUpdate.checked = data.wasAuxiliaryPioneer || false;
                commentsUpdate.value = data.comments || '';
                lastModifiedByUpdate.textContent = data.lastModifiedBy ? `Last modified by: ${data.lastModifiedBy}` : '';
            } else {
                alert("No report found for the selected publisher and period.");
                clearUpdateReportForm(false);
                currentReportId = null;
            }
        } catch (error) {
            console.error("Error fetching report data:", error);
            alert("An error occurred while fetching the report.");
            currentReportId = null;
        }
    }
    // DITO NA PO NAGATATAPOS ANG BUONG SCRIPT
    </script>
</body>
</html>
