<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher App</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f4f4f4; margin: 0; padding: 20px; box-sizing: border-box; }
        .page-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        input, select { display: block; width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background-color: #0056b3; }
        .logout-btn, .delete-btn { background-color: #dc3545; }
        .logout-btn:hover, .delete-btn:hover { background-color: #c82333; }
        .clear-btn { background-color: #ffc107; color: #333; }
        .clear-btn:hover { background-color: #e0a800; }
        .back-btn { background-color: #6c757d; }
        .back-btn:hover { background-color: #5a6268; }
        
        .hidden { display: none !important; }

        .suggestion-box { border: 1px solid #ddd; max-height: 150px; overflow-y: auto; background-color: white; position: absolute; width: calc(100% - 42px); z-index: 100; }
        .suggestion-item { padding: 8px; cursor: pointer; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        input[type="checkbox"] { width: auto; margin-right: 5px;}
        .checkbox-container { display: flex; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="loginPage" class="page-container">
        <h2>Login</h2>
        <input type="text" id="loginUsername" placeholder="Username">
        <input type="password" id="loginPassword" placeholder="Password">
        <button id="loginBtn">Login</button>
    </div>

    <div id="homePage" class="page-container hidden">
        <h2>Welcome, <span id="loggedInUser"></span>!</h2>
        <button id="addReportBtn">Add Report</button>
        <button id="managePublisherBtn">Manage Publisher</button>
        <button id="clearAllDataBtn">Clear All Data</button>
        <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>

    <div id="addReportPage" class="page-container hidden">
        <h2>Add Field Service Report</h2>

        <label for="searchPublisherReport">Search Publisher:</label>
        <input type="text" id="searchPublisherReport" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxReport" class="suggestion-box"></div>

        <label for="publisherNameDropdown">Publisher Name:</label>
        <select id="publisherNameDropdown"></select>
        
        <label for="fieldGroup">Field Service Group:</label>
        <input type="text" id="fieldGroup" disabled>
        
        <label for="privilege2Report">Privilege 2:</label>
        <input type="text" id="privilege2Report" disabled>

        <label for="serviceYearDropdown">Service Year:</label>
        <select id="serviceYearDropdown"></select>

        <label for="monthYearDropdown">Month:</label>
        <select id="monthYearDropdown"></select>

        <div id="auxPioneerQuestionContainer" class="hidden">
            <label for="isAuxiliaryPioneerThisMonth">Is Auxiliary Pioneer this Month?</label>
            <select id="isAuxiliaryPioneerThisMonth">
                <option value="">-- Select --</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
            </select>
        </div>

        <div id="fieldHoursContainer" class="hidden">
            <label for="fieldHours">Field Hours:</label>
            <input type="number" id="fieldHours" min="1">
        </div>

        <div id="bibleStudiesContainer" class="hidden">
            <label for="bibleStudies">Bible Studies:</label>
            <input type="number" id="bibleStudies" min="0">
        </div>

        <div id="sharedMinistryContainer" class="hidden">
            <div class="checkbox-container">
                <input type="checkbox" id="sharedMinistry">
                <label for="sharedMinistry">Shared in Ministry</label>
            </div>
        </div>

        <div id="auxiliaryPioneerCheckboxContainer" class="hidden">
            <div class="checkbox-container">
                <input type="checkbox" id="auxiliaryPioneerCheckbox">
                <label for="auxiliaryPioneerCheckbox">Auxiliary Pioneer</label>
            </div>
        </div>

        <button id="saveReportBtn">Save Report</button>
        <button id="clearReportBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromReportBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromReport" class="logout-btn">Logout</button>
    </div>

    <div id="publisherPage" class="page-container hidden">
        <h2>Manage Publisher Records</h2>
        </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
    // --- script.js ---

    // --- Firebase Config and Initialization (GLOBAL) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDbKyWaYclW4jZ2eQ0qrK_PIfrh-7sahwY",
        authDomain: "field-service-reporter.firebaseapp.com",
        projectId: "field-service-reporter",
        storageBucket: "field-service-reporter.firebasestorage.app",
        messagingSenderId: "434729902657",
        appId: "1:434729902657:web:c1b06d2695a47924f89cc0",
        measurementId: "G-9N52K2CGDD"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // --- Global App State Variables ---
    let publisherList = [];
    let currentIndex = -1;
    let currentDocId = null;
    let loggedInUser = null;

    // --- References to Page Containers (GLOBAL) ---
    let loginPage, homePage, addReportPage, publisherPage;

    // --- References for Add Report page elements (GLOBAL) ---
    let serviceYearDropdown, monthYearDropdown, auxPioneerQuestionContainer, isAuxiliaryPioneerThisMonth;
    let fieldHoursContainer, fieldHoursInput, bibleStudiesContainer, bibleStudiesInput;
    let sharedMinistryContainer, sharedMinistryCheckbox, auxiliaryPioneerCheckboxContainer, auxiliaryPioneerCheckbox;
    let privilege2ReportInput, logoutBtnFromReport; // Added logoutBtnFromReport
    let searchPublisherReportInput, suggestionBoxReport, publisherNameDropdown, fieldGroupInput;

    // --- References for Manage Publisher page elements (GLOBAL) ---
    // ... existing references ...

    // --- CORE APPLICATION LOGIC (Combined) ---
    document.addEventListener("DOMContentLoaded", function () {
        // ... existing element selections ...
        logoutBtnFromReport = document.getElementById("logoutBtnFromReport");

        // --- Event Listeners ---
        document.getElementById("loginBtn")?.addEventListener("click", login);
        document.getElementById("addReportBtn")?.addEventListener("click", () => showPage('addReportPage', '/add-report'));
        document.getElementById("managePublisherBtn")?.addEventListener("click", () => showPage('publisherPage', '/manage-publisher'));
        document.getElementById("clearAllDataBtn")?.addEventListener("click", clearAllData);
        document.getElementById("logoutBtn")?.addEventListener("click", logout);
        
        // MODIFIED: saveReportBtn now calls the main saveReport function
        document.getElementById("saveReportBtn")?.addEventListener("click", saveReport);
        document.getElementById("clearReportBtn")?.addEventListener("click", clearAddReportForm);
        document.getElementById("backHomeFromReportBtn")?.addEventListener("click", () => showPage('homePage', '/home'));
        
        // ADDED: Listener for the new logout button
        logoutBtnFromReport?.addEventListener("click", logout);

        // ... other existing listeners ...

        handleRouteChange();
    });
    
    // --- Login/Logout & Data Management ---
    function login() { /* ... existing function ... */ }
    function logout() { /* ... existing function ... */ }
    function clearAllData() { /* ... existing function ... */ }
    
    // --- Page Setups ---
    function updateHomePage() { /* ... existing function ... */ }
    function setupAddReportPage() { /* ... existing function ... */ }
    function setupManagePublisherPage() { /* ... existing function ... */ }
    
    // --- Publisher Management ---
    async function loadPublishers() { /* ... existing function ... */ }
    // ... other existing publisher functions ...
    
    // --- Report Management ---
    function populatePublisherDropdown() { /* ... existing function ... */ }
    function autofillPublisherDetails(publisherId) { /* ... existing function ... */ }
    function populateServiceYears() { /* ... existing function ... */ }
    function populateMonths() { /* ... existing function ... */ }
    function updateReportFieldsVisibility() { /* ... existing function ... */ }
    function clearAddReportForm() { /* ... existing function ... */ }

    // --- NEW and REBUILT Save Report Function ---
    async function saveReport() {
        // 1. --- VALIDATION ---
        // Check for required fields that are always visible
        if (!publisherNameDropdown.value) {
            alert("Validation Error: Please select a publisher.");
            return; // Stop execution, do not clear form
        }
        if (!serviceYearDropdown.value) {
            alert("Validation Error: Please select a service year.");
            return;
        }
        if (!monthYearDropdown.value) {
            alert("Validation Error: Please select a month.");
            return;
        }

        // Check for conditionally visible fields
        if (!auxPioneerQuestionContainer.classList.contains('hidden') && !isAuxiliaryPioneerThisMonth.value) {
            alert("Validation Error: Please answer 'Is Auxiliary Pioneer this Month?'.");
            return;
        }
        if (!fieldHoursContainer.classList.contains('hidden') && !fieldHoursInput.value) {
            alert("Validation Error: Please enter the number of hours.");
            return;
        }
        if (!bibleStudiesContainer.classList.contains('hidden') && !bibleStudiesInput.value) {
            alert("Validation Error: Please enter the number of bible studies.");
            return;
        }
        
        // --- If validation passes, proceed ---
        
        const publisherId = publisherNameDropdown.value;
        const serviceYear = serviceYearDropdown.value;
        const month = monthYearDropdown.value;
        const publisherFullName = publisherNameDropdown.options[publisherNameDropdown.selectedIndex].text;

        // 2. --- DUPLICATE CHECK ---
        // Create a unique ID for the report to easily check for existence
        const reportId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
        const reportRef = db.collection("reports").doc(reportId);

        try {
            const doc = await reportRef.get();
            if (doc.exists) {
                alert("Error: A report for this publisher, service year, and month already exists. You cannot add a duplicate report.");
                return; // Stop execution
            }

            // 3. --- PREPARE and SAVE DATA ---
            const reportData = {
                publisherId: publisherId,
                publisherFullName: publisherFullName,
                serviceYear: serviceYear,
                month: month,
                fieldServiceGroup: fieldGroupInput.value,
                privilege2AtTimeOfReport: privilege2ReportInput.value,
                hours: fieldHoursInput.value ? parseInt(fieldHoursInput.value) : 0,
                bibleStudies: bibleStudiesInput.value ? parseInt(bibleStudiesInput.value) : 0,
                sharedInMinistry: sharedMinistryCheckbox.checked,
                wasAuxiliaryPioneer: auxiliaryPioneerCheckbox.checked,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await reportRef.set(reportData);
            alert("Report saved successfully!");
            clearAddReportForm(); // Clear form only after successful save

        } catch (error) {
            console.error("Error saving report: ", error);
            alert("An error occurred while saving the report. Please check the console and try again.");
        }
    }
    
    // NOTE: Make sure the other functions (login, logout, setup pages, etc.) are present from the previous code.
    // The placeholder /* ... existing function ... */ indicates where your previous code should be.
    
    </script>
</body>
</html>
