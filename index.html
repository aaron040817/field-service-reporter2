<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher App</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f4f4f4; margin: 0; padding: 20px; box-sizing: border-box; }
        .page-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        input, select, textarea { display: block; width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background-color: #0056b3; }
        .logout-btn, .delete-btn { background-color: #dc3545; }
        .logout-btn:hover, .delete-btn:hover { background-color: #c82333; }
        .clear-btn { background-color: #ffc107; color: #333; }
        .clear-btn:hover { background-color: #e0a800; }
        .back-btn { background-color: #6c757d; }
        .back-btn:hover { background-color: #5a6268; }
        .hidden { display: none !important; }
        .suggestion-box { border: 1px solid #ddd; max-height: 150px; overflow-y: auto; background-color: white; position: absolute; width: calc(100% - 42px); z-index: 100; }
        .suggestion-item { padding: 8px; cursor: pointer; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        input[type="checkbox"] { width: auto; margin-right: 5px;}
        .checkbox-container { display: flex; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="loginPage" class="page-container">
        <h2>Login</h2>
        <input type="email" id="loginUsername" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button id="loginBtn">Login</button>
    </div>

    <div id="homePage" class="page-container hidden">
        <h2>Welcome, <span id="loggedInUser"></span>!</h2>
        
        <div id="adminButtons">
            <button id="managePublisherBtn">Manage Publisher</button>
            <button id="addReportBtnAdmin">Add Report</button>
            <button id="updateReportPageBtn">Update Report</button>
            <button id="reviewApprovalsBtn">Review Approvals</button>
            <button id="exportExcelBtn">Export to Excel</button>
        </div>

        <div id="userButtons">
            <button id="addReportBtnUser">Add Report</button>
            <button id="submitRequestPageBtn">Submit Request to Update</button>
        </div>
        
        <button id="logoutBtn" class="logout-btn">Logout</button>

        <div id="adminSection" style="margin-top: 20px;">
             <button id="clearAllDataBtn">Clear All Data</button>
             <p style="color: red; font-size: 12px; margin-top: 5px;">Warning: This will delete all publisher and report data.</p>
        </div>
    </div>

    <div id="addReportPage" class="page-container hidden">
        </div>

    <div id="updateReportPage" class="page-container hidden">
        </div>

    <div id="publisherPage" class="page-container hidden">
        </div>

    <div id="submitRequestPage" class="page-container hidden">
        <h2>Submit Request to Update Report</h2>
        
        <h4>Who do you want to update?</h4>
        <label for="searchPublisherRequest">Search Publisher:</label>
        <input type="text" id="searchPublisherRequest" placeholder="Search by Last Name, First Name...">
        <div id="suggestionBoxRequest" class="suggestion-box"></div>
        <label for="publisherNameDropdownRequest">Publisher Name:</label>
        <select id="publisherNameDropdownRequest"></select>
        <label for="fieldGroupRequest">Field Service Group:</label>
        <input type="text" id="fieldGroupRequest" disabled>
        <label for="privilege2Request">Privilege 2:</label>
        <input type="text" id="privilege2Request" disabled>

        <hr style="margin: 20px 0;">

        <h4>What Service Year and Month do you want to update?</h4>
        <label for="serviceYearRequest">Service Year:</label>
        <select id="serviceYearRequest"></select>
        <label for="monthYearRequest">Month:</label>
        <select id="monthYearRequest"></select>

        <div id="requestFields" style="display: none;">
            </div>

        <button id="submitRequestApprovalBtn">Submit Request for Admin Approval</button>
        <button id="clearRequestFormBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromRequestBtn" class="back-btn">Back to Home</button>
        <button id="logoutBtnFromRequest" class="logout-btn">Logout</button>
    </div>

    <div id="reviewApprovalsPage" class="page-container hidden">
        <h2>Review Approvals</h2>
        <p>This feature is under construction.</p>
        <div id="pendingRequestsList"></div>
        <button id="backHomeFromReviewBtn" class="back-btn">Back to Home</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
</body>
</html>

<script>
    // --- script.js ---

    // --- Firebase Config and Initialization ---
    const firebaseConfig = {
        apiKey: "AIzaSyDbKyWaYclW4jZ2eQ0qrK_PIfrh-7sahwY",
        authDomain: "field-service-reporter.firebaseapp.com",
        projectId: "field-service-reporter",
        storageBucket: "field-service-reporter.firebasestorage.app",
        messagingSenderId: "434729902657",
        appId: "1:434729902657:web:c1b06d2695a47924f89cc0",
        measurementId: "G-9N52K2CGDD"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    const auth = firebase.auth(); 

    // --- Global State Variables ---
    let publisherList = [];
    let userList = [];
    let currentIndex = -1;
    let currentUserIndex = -1;
    let currentDocId = null;
    let currentUser = null;
    let currentReportId = null; 
    let currentUserDocId = null;

    // --- Global Element References ---
    let loginPage, homePage, addReportPage, publisherPage, updateReportPage, manageUsersPage, submitRequestPage, reviewApprovalsPage;
    let serviceYearDropdown, monthYearDropdown, auxPioneerQuestionContainer, isAuxiliaryPioneerThisMonth;
    let fieldHoursContainer, fieldHoursInput, bibleStudiesContainer, bibleStudiesInput;
    let sharedMinistryContainer, sharedMinistryCheckbox, auxiliaryPioneerCheckboxContainer, auxiliaryPioneerCheckbox;
    let privilege2ReportInput, logoutBtnFromReport, searchPublisherReportInput, suggestionBoxReport, publisherNameDropdown, fieldGroupInput;
    let firstNameInput, lastNameInput, fullNameInput, birthdateInput, baptismStatusDropdown;
    let baptismDateContainer, baptismDateInput, genderDropdown, hopeDropdown, privilegeDropdown;
    let privilege2Dropdown, fieldServiceGroupDropdown;
    let addPublisherBtn, updatePublisherBtn, deletePublisherBtn, previousPublisherBtn, nextPublisherBtn;
    let clearPublisherFormBtn, backHomeFromPublisherBtn, logoutBtnFromPublisher, searchInputManage, suggestionBoxManage;
    let publisherNameDropdownUpdate, serviceYearDropdownUpdate, monthYearDropdownUpdate, searchPublisherUpdate, suggestionBoxUpdate;
    let fieldGroupUpdate, privilege2Update;
    let fieldHoursUpdate, bibleStudiesUpdate, sharedMinistryUpdate, auxiliaryPioneerCheckboxUpdate;
    let auxPioneerQuestionContainerUpdate, isAuxiliaryPioneerThisMonthUpdate, updateReportFieldsDiv;
    let fieldHoursContainerUpdate, bibleStudiesContainerUpdate, sharedMinistryContainerUpdate, auxiliaryPioneerCheckboxContainerUpdate;
    let updateReportBtn, deleteReportBtn, clearUpdateFormBtn, backHomeFromUpdateBtn, logoutBtnFromUpdate;
    let manageUsersBtn, adminSection, adminButtons, userButtons;
    let userEmail, userPassword, showPassword, userFirstName, userLastName, userRole;
    let addUserBtn, updateUserBtn, deleteUserBtn, previousUserBtn, nextUserBtn, clearUserFormBtn, backHomeFromUserBtn, logoutBtnFromUser;
    let searchPublisherRequest, suggestionBoxRequest, publisherNameDropdownRequest, fieldGroupRequest, privilege2Request;
    let serviceYearRequest, monthYearRequest, requestFields, submitRequestApprovalBtn, clearRequestFormBtn, backHomeFromRequestBtn, logoutBtnFromRequest;
    
    // --- CORE APPLICATION LIFECYCLE ---
    document.addEventListener("DOMContentLoaded", initializeApp);

    async function initializeApp() {
        getAllElements();
        attachAllListeners();
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDoc = await db.collection("users").doc(user.uid).get();
                if (userDoc.exists) {
                    currentUser = { uid: user.uid, email: user.email, role: userDoc.data().role };
                    localStorage.setItem('userRole', currentUser.role); 
                } else {
                    console.error("User document not found in Firestore. Signing out.");
                    await auth.signOut();
                    return;
                }
                await loadPublishers();
                handleRouteChange();
            } else {
                currentUser = null;
                localStorage.removeItem('userRole');
                publisherList = [];
                userList = [];
                handleRouteChange();
            }
        });
    }

    function getAllElements() {
        // Page Containers
        loginPage = document.getElementById('loginPage');
        homePage = document.getElementById('homePage');
        addReportPage = document.getElementById('addReportPage');
        publisherPage = document.getElementById('publisherPage');
        updateReportPage = document.getElementById('updateReportPage');
        submitRequestPage = document.getElementById('submitRequestPage');
        reviewApprovalsPage = document.getElementById('reviewApprovalsPage');
        
        // Home Page
        adminButtons = document.getElementById('adminButtons');
        userButtons = document.getElementById('userButtons');
        adminSection = document.getElementById('adminSection');
        
        // Add Report Page
        serviceYearDropdown = document.getElementById("serviceYearDropdown");
        monthYearDropdown = document.getElementById("monthYearDropdown");
        auxPioneerQuestionContainer = document.getElementById("auxPioneerQuestionContainer");
        isAuxiliaryPioneerThisMonth = document.getElementById("isAuxiliaryPioneerThisMonth");
        fieldHoursContainer = document.getElementById("fieldHoursContainer");
        fieldHoursInput = document.getElementById("fieldHours");
        bibleStudiesContainer = document.getElementById("bibleStudiesContainer");
        bibleStudiesInput = document.getElementById("bibleStudies");
        sharedMinistryContainer = document.getElementById("sharedMinistryContainer");
        sharedMinistryCheckbox = document.getElementById("sharedMinistry");
        auxiliaryPioneerCheckboxContainer = document.getElementById("auxiliaryPioneerCheckboxContainer");
        auxiliaryPioneerCheckbox = document.getElementById("auxiliaryPioneerCheckbox");
        privilege2ReportInput = document.getElementById("privilege2Report");
        searchPublisherReportInput = document.getElementById("searchPublisherReport");
        suggestionBoxReport = document.getElementById("suggestionBoxReport");
        publisherNameDropdown = document.getElementById("publisherNameDropdown");
        fieldGroupInput = document.getElementById("fieldGroup");
        logoutBtnFromReport = document.getElementById("logoutBtnFromReport");
        
        // Publisher Page
        firstNameInput = document.getElementById("firstName");
        lastNameInput = document.getElementById("lastName");
        // ... (and all other publisher fields)
        
        // Update Report Page
        publisherNameDropdownUpdate = document.getElementById('publisherNameDropdownUpdate');
        // ... (and all other update report fields)
        
        // Submit Request Page
        searchPublisherRequest = document.getElementById('searchPublisherRequest');
        suggestionBoxRequest = document.getElementById('suggestionBoxRequest');
        publisherNameDropdownRequest = document.getElementById('publisherNameDropdownRequest');
        fieldGroupRequest = document.getElementById('fieldGroupRequest');
        privilege2Request = document.getElementById('privilege2Request');
        serviceYearRequest = document.getElementById('serviceYearRequest');
        monthYearRequest = document.getElementById('monthYearRequest');
        requestFields = document.getElementById('requestFields');
        submitRequestApprovalBtn = document.getElementById('submitRequestApprovalBtn');
        clearRequestFormBtn = document.getElementById('clearRequestFormBtn');
        backHomeFromRequestBtn = document.getElementById('backHomeFromRequestBtn');
        logoutBtnFromRequest = document.getElementById('logoutBtnFromRequest');
    }

    function attachAllListeners() {
        document.getElementById("loginBtn")?.addEventListener("click", login);
        document.getElementById("logoutBtn")?.addEventListener("click", logout);
        
        // Home Page Buttons
        document.getElementById("managePublisherBtn")?.addEventListener("click", () => showPage('publisherPage', '/manage-publisher'));
        document.getElementById("addReportBtnAdmin")?.addEventListener("click", () => showPage('addReportPage', '/add-report'));
        document.getElementById("updateReportPageBtn")?.addEventListener("click", () => showPage('updateReportPage', '/update-report'));
        document.getElementById("reviewApprovalsBtn")?.addEventListener("click", () => showPage('reviewApprovalsPage', '/review-approvals'));
        document.getElementById("exportExcelBtn")?.addEventListener("click", exportToExcel);
        document.getElementById("addReportBtnUser")?.addEventListener("click", () => showPage('addReportPage', '/add-report'));
        document.getElementById("submitRequestPageBtn")?.addEventListener("click", () => showPage('submitRequestPage', '/submit-request'));
        document.getElementById("clearAllDataBtn")?.addEventListener("click", clearAllData);

        // Add Report Page Buttons
        document.getElementById("saveReportBtn")?.addEventListener("click", saveReport);
        document.getElementById("clearReportBtn")?.addEventListener("click", clearAddReportForm);
        document.getElementById("backHomeFromReportBtn")?.addEventListener("click", () => showPage('homePage', '/home'));
        logoutBtnFromReport?.addEventListener("click", logout);
        
        // Submit Request Page Buttons
        submitRequestApprovalBtn?.addEventListener('click', submitRequestForApproval);
        clearRequestFormBtn?.addEventListener('click', clearSubmitRequestForm);
        backHomeFromRequestBtn?.addEventListener('click', () => showPage('homePage', '/home'));
        logoutBtnFromRequest?.addEventListener('click', logout);
        document.getElementById("backHomeFromReviewBtn")?.addEventListener('click', () => showPage('homePage', '/home'));

        window.addEventListener('popstate', handleRouteChange);
    }

    // --- Routing ---
    function showPage(pageId, path) {
        document.querySelectorAll('.page-container').forEach(page => page.classList.add('hidden'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) { targetPage.classList.remove('hidden'); }
        if (path && window.location.pathname !== path) { history.pushState({ page: pageId }, '', path); }
        if (pageId === 'homePage') { updateHomePage(); } 
        else if (pageId === 'addReportPage') { setupAddReportPage(); } 
        else if (pageId === 'publisherPage') { setupManagePublisherPage(); } 
        else if (pageId === 'updateReportPage') { setupUpdateReportPage(); }
        else if (pageId === 'submitRequestPage') { setupSubmitRequestPage(); }
        else if (pageId === 'reviewApprovalsPage') { setupReviewApprovalsPage(); }
    }
    function handleRouteChange() {
        const path = window.location.pathname;
        if (!currentUser && path !== '/') {
            showPage('loginPage', '/');
            return;
        }
        switch (path) {
            case '/': showPage(currentUser ? 'homePage' : 'loginPage', currentUser ? '/home' : '/'); break;
            case '/home': showPage('homePage', '/home'); break;
            case '/add-report': showPage('addReportPage', '/add-report'); break;
            case '/manage-publisher': showPage('publisherPage', '/manage-publisher'); break;
            case '/update-report': showPage('updateReportPage', '/update-report'); break;
            case '/submit-request': showPage('submitRequestPage', '/submit-request'); break;
            case '/review-approvals':
                if (currentUser?.role === 'admin') {
                    showPage('reviewApprovalsPage', '/review-approvals');
                } else {
                    alert("Access denied. Admin only.");
                    showPage('homePage', '/home');
                }
                break;
            default: showPage(currentUser ? 'homePage' : 'loginPage', currentUser ? '/home' : '/'); break;
        }
    }

    // --- Login/Logout & Data Management ---
    async function login() {
        const email = document.getElementById("loginUsername").value;
        const password = document.getElementById("loginPassword").value;
        if (!email || !password) { alert("Please enter both email and password."); return; }
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error("Login failed:", error);
            alert("Invalid email or password.");
        }
    }
    async function logout() {
        try {
            await auth.signOut();
        } catch (error) {
            console.error("Logout failed:", error);
        }
    }
    async function clearAllData() {
        if (confirm("Are you sure you want to delete ALL data? This cannot be undone.")) {
            // ... (code for clearing data remains the same)
        }
    }

    // --- Export to Excel ---
    async function exportToExcel() {
        // ... (code for export remains the same)
    }
    
    // --- Page Setups ---
    function updateHomePage() {
        if (currentUser) {
            document.getElementById("loggedInUser").textContent = currentUser.email;
            if (currentUser.role === 'admin') {
                adminButtons.classList.remove('hidden');
                adminSection.classList.remove('hidden');
                userButtons.classList.add('hidden');
            } else { // For 'user' role
                adminButtons.classList.add('hidden');
                adminSection.classList.add('hidden');
                userButtons.classList.remove('hidden');
            }
        }
    }
    function setupAddReportPage() {
        // ... (code remains the same)
    }
    function setupManagePublisherPage() {
        // ... (code remains the same)
    }
    function setupUpdateReportPage() {
        // ... (code remains the same)
    }
    function setupSubmitRequestPage() {
        clearSubmitRequestForm();
        publisherNameDropdownRequest.innerHTML = '<option value="">-- Select Publisher --</option>';
        publisherList.forEach(pub => {
            const opt = document.createElement("option");
            opt.value = pub.id;
            opt.textContent = pub.fullName;
            publisherNameDropdownRequest.appendChild(opt);
        });
        populateServiceYears(serviceYearRequest);

        const handlePublisherSelection = () => {
            const selectedPublisher = publisherList.find(p => p.id === publisherNameDropdownRequest.value);
            if(selectedPublisher) {
                fieldGroupRequest.value = selectedPublisher.fieldServiceGroup || '';
                privilege2Request.value = selectedPublisher.privilege2 || '';
            } else {
                fieldGroupRequest.value = '';
                privilege2Request.value = '';
            }
            // Logic to fetch existing report will be added here
        }

        publisherNameDropdownRequest.addEventListener('change', handlePublisherSelection);
        serviceYearRequest.addEventListener('change', () => populateMonths(monthYearRequest, serviceYearRequest.value));
    }
    function setupReviewApprovalsPage() {
        // Logic to fetch and display pending requests will go here in the future
    }

    // --- Publisher Management ---
    async function loadPublishers() {
        try {
            const snapshot = await db.collection("publishers").orderBy("fullName", "asc").get();
            publisherList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) { console.error("Error loading publishers:", error); }
    }
    function updateFullName() { fullNameInput.value = (lastNameInput.value.trim() && firstNameInput.value.trim()) ? `${lastNameInput.value.trim()}, ${firstNameInput.value.trim()}` : ""; }
    function toggleBaptismDate() { baptismDateContainer.classList.toggle("hidden", baptismStatusDropdown.value !== "Baptized"); if (baptismStatusDropdown.value !== "Baptized") baptismDateInput.value = ""; }
    async function addPublisher() {
        if (!firstNameInput.value.trim() || !lastNameInput.value.trim() || !birthdateInput.value || !baptismStatusDropdown.value || !genderDropdown.value || !hopeDropdown.value || !privilegeDropdown.value || !privilege2Dropdown.value || !fieldServiceGroupDropdown.value || (baptismStatusDropdown.value === "Baptized" && !baptismDateInput.value)) {
            alert("Please complete all fields before adding."); return;
        }
        const docId = `${lastNameInput.value.trim()}_${firstNameInput.value.trim()}_${birthdateInput.value}`.replace(/\s+/g, "_");
        try {
            const existingDoc = await db.collection("publishers").doc(docId).get();
            if (existingDoc.exists) { alert("A publisher with the same last name, first name, and birthdate already exists."); return; }
            const baptismDateValue = baptismStatusDropdown.value === "Baptized" ? baptismDateInput.value : "";
            await db.collection("publishers").doc(docId).set({
                firstName: firstNameInput.value.trim(), lastName: lastNameInput.value.trim(), birthdate: birthdateInput.value, baptismStatus: baptismStatusDropdown.value, baptismDate: baptismDateValue, gender: genderDropdown.value, hope: hopeDropdown.value, privilege: privilegeDropdown.value, privilege2: privilege2Dropdown.value, fieldServiceGroup: fieldServiceGroupDropdown.value, fullName: `${lastNameInput.value.trim()}, ${firstNameInput.value.trim()}`, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Publisher record successfully added!");
            await loadPublishers();
            clearPublisherForm();
        } catch (error) { console.error("Error adding publisher:", error); alert("Failed to add publisher record."); }
    }
    async function updatePublisher() {
        if (!currentDocId) { alert("Please select a publisher to update."); return; }
        if (!firstNameInput.value.trim() || !lastNameInput.value.trim() || !birthdateInput.value || !baptismStatusDropdown.value || !genderDropdown.value || !hopeDropdown.value || !privilegeDropdown.value || !privilege2Dropdown.value || !fieldServiceGroupDropdown.value || (baptismStatusDropdown.value === "Baptized" && !baptismDateInput.value)) {
            alert("Please complete all fields before updating."); return;
        }
        const baptismDateValue = baptismStatusDropdown.value === "Baptized" ? baptismDateInput.value : "";
        const updatedData = {
            firstName: firstNameInput.value.trim(), lastName: lastNameInput.value.trim(), birthdate: birthdateInput.value, baptismStatus: baptismStatusDropdown.value, baptismDate: baptismDateValue, gender: genderDropdown.value, hope: hopeDropdown.value, privilege: privilegeDropdown.value, privilege2: privilege2Dropdown.value, fieldServiceGroup: fieldServiceGroupDropdown.value, fullName: `${lastNameInput.value.trim()}, ${firstNameInput.value.trim()}`, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection("publishers").doc(currentDocId).update(updatedData);
            alert("Publisher record updated successfully!");
            await loadPublishers();
            clearPublisherForm();
        } catch (error) { console.error("Error updating publisher:", error); alert("Failed to update publisher record."); }
    }
    async function deletePublisher() {
        if (!currentDocId) { alert("Please select a publisher to delete."); return; }
        if (!confirm("Are you sure you want to permanently delete this publisher record? This action cannot be undone.")) return;
        try {
            await db.collection("publishers").doc(currentDocId).delete();
            alert("Publisher record deleted successfully!");
            await loadPublishers();
            clearPublisherForm();
        } catch (error) { console.error("Error deleting publisher:", error); alert("Failed to delete publisher record."); }
    }
    function previousPublisher() { if (currentIndex > 0) { currentIndex--; displayPublisher(currentIndex); } else { alert("This is the first record."); } }
    function nextPublisher() { if (currentIndex < publisherList.length - 1) { currentIndex++; displayPublisher(currentIndex); } else { alert("This is the last record."); } }
    function clearPublisherForm() {
        // ... (This function remains complete from previous versions)
    }
    function displayPublisher(index) {
        // ... (This function remains complete from previous versions)
    }

    // --- Report Management ---
    function autofillPublisherDetails(publisherId) {
        const selectedPublisher = publisherList.find(pub => pub.id === publisherId);
        if (selectedPublisher) {
            fieldGroupInput.value = selectedPublisher.fieldServiceGroup || "";
            privilege2ReportInput.value = selectedPublisher.privilege2 || "";
        } else {
            fieldGroupInput.value = "";
            privilege2ReportInput.value = "";
        }
        updateReportFieldsVisibility();
    }
    function populateServiceYears(dropdownElement) {
        // ... (This function remains complete from previous versions)
    }
    function populateMonths(monthDropdown, serviceYear) {
        // ... (This function remains complete from previous versions)
    }
    function clearAddReportForm() {
        // ... (This function remains complete from previous versions)
    }
    function handleReportFieldLogic(elements) {
        // ... (This function remains complete from previous versions)
    }
    function updateReportFieldsVisibility() {
        // ... (This function remains complete from previous versions)
    }
    function updateReportFieldsVisibility_UpdatePage() {
        // ... (This function remains complete from previous versions)
    }
    async function saveReport() {
        // ... (This function remains complete from previous versions)
    }

    // --- Update/Delete Report Logic ---
    async function fetchReportData() {
        // ... (This function remains complete from previous versions)
    }
    async function updateReport() {
        // ... (This function remains complete from previous versions)
    }
    async function deleteReport() {
        // ... (This function remains complete from previous versions)
    }
    function clearUpdateReportForm(clearAll = true) {
        // ... (This function remains complete from previous versions)
    }
    
    // --- NEW: Submit Request Logic ---
    function clearSubmitRequestForm() {
        publisherNameDropdownRequest.value = "";
        serviceYearRequest.value = "";
        monthYearRequest.innerHTML = '<option value="">-- Select Month --</option>';
        searchPublisherRequest.value = "";
        fieldGroupRequest.value = "";
        privilege2Request.value = "";
        requestFields.innerHTML = ""; // Clear the dynamically added fields
        requestFields.style.display = 'none';
    }

    async function fetchReportDataForRequest() {
        const publisherId = publisherNameDropdownRequest.value;
        const serviceYear = serviceYearRequest.value;
        const month = monthYearRequest.value;

        // Clear previous results first
        requestFields.innerHTML = "";
        requestFields.style.display = 'none';

        if (!publisherId || !serviceYear || !month) {
            return;
        }

        const reportId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;
        const reportRef = db.collection("reports").doc(reportId);

        try {
            const doc = await reportRef.get();
            if (doc.exists) {
                const data = doc.data();
                // Dynamically create the report fields inside the 'requestFields' div
                // This is a simplified version of the main report form
                let fieldsHTML = `
                    <div id="fieldHoursContainerRequest">
                        <label for="fieldHoursRequest">Field Hours:</label>
                        <input type="number" id="fieldHoursRequest" min="1" value="${data.hours || ''}">
                    </div>
                    <div id="bibleStudiesContainerRequest">
                        <label for="bibleStudiesRequest">Bible Studies:</label>
                        <input type="number" id="bibleStudiesRequest" min="0" value="${data.bibleStudies || ''}">
                    </div>
                    <div id="sharedMinistryContainerRequest" class="checkbox-container">
                        <input type="checkbox" id="sharedMinistryRequest" ${data.sharedInMinistry ? 'checked' : ''}>
                        <label for="sharedMinistryRequest">Shared in Ministry</label>
                    </div>
                `;
                if(data.wasAuxiliaryPioneer) {
                    fieldsHTML += `
                        <div id="auxiliaryPioneerCheckboxContainerRequest" class="checkbox-container">
                            <input type="checkbox" id="auxiliaryPioneerRequest" ${data.wasAuxiliaryPioneer ? 'checked' : ''}>
                            <label for="auxiliaryPioneerRequest">Auxiliary Pioneer</label>
                        </div>
                    `;
                }
                requestFields.innerHTML = fieldsHTML;
                requestFields.style.display = 'block';

            } else {
                alert("No existing report found for this period to update.");
            }
        } catch (error) {
            console.error("Error fetching report for request:", error);
        }
    }
    
    async function submitRequestForApproval() {
        const publisherId = publisherNameDropdownRequest.value;
        const serviceYear = serviceYearRequest.value;
        const month = monthYearRequest.value;

        // Validation
        if (!publisherId || !serviceYear || !month) {
            alert("Please select the publisher, service year, and month of the report you want to update.");
            return;
        }

        const originalReportId = `${publisherId}_${serviceYear}_${month.replace(/\s+/g, '-')}`;

        // Get new values from the dynamically created fields
        const hoursInput = document.getElementById('fieldHoursRequest');
        const studiesInput = document.getElementById('bibleStudiesRequest');
        const sharedMinistryInput = document.getElementById('sharedMinistryRequest');
        const auxPioneerInput = document.getElementById('auxiliaryPioneerRequest');

        if (!hoursInput || !studiesInput || !sharedMinistryInput) {
            alert("No report data loaded. Please select a valid period with an existing report.");
            return;
        }
        
        const requestedChanges = {
            hours: parseInt(hoursInput.value) || 0,
            bibleStudies: parseInt(studiesInput.value) || 0,
            sharedInMinistry: sharedMinistryInput.checked,
            wasAuxiliaryPioneer: auxPioneerInput ? auxPioneerInput.checked : false
        };

        const requestData = {
            requestingUserUid: currentUser.uid,
            requestingUserEmail: currentUser.email,
            publisherToUpdateId: publisherId,
            publisherToUpdateName: publisherNameDropdownRequest.options[publisherNameDropdownRequest.selectedIndex].text,
            originalReportId: originalReportId,
            serviceYear: serviceYear,
            month: month,
            requestedChanges: requestedChanges,
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection('updateRequests').add(requestData);
            alert("Request Submitted. Please wait for the admin approval to take effect the changes.");
            clearSubmitRequestForm();
        } catch (error) {
            console.error("Error submitting request:", error);
            alert("Failed to submit request. Please check security rules and console.");
        }
    }
</script>
</body>
</html>
