<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Publisher App with Login</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial; padding: 30px; }
        .hidden { display: none; }
        input, button { margin: 10px 0; padding: 8px; width: 300px; }
        .box { border: 1px solid #ccc; padding: 20px; border-radius: 8px; width: 400px; }
        button { width: auto; display: inline-block; margin-right: 10px; }
        .danger { color: red; font-size: 12px; }
        .suggestions {
            max-height: 150px;
            overflow-y: auto;
            background: white;
            position: absolute;
            z-index: 100;
            width: 100%;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        input[disabled] {
            background-color: #f9f9f9;
            color: #333;
        }
    </style>
</head>
<body>

    <div id="loginPage" class="box">
        <h2>Login</h2>
        <label>Username:<br><input type="text" id="loginUsername"></label><br>
        <label>Password:<br><input type="password" id="loginPassword"></label><br>
        <button onclick="login()">Login</button>
    </div>

    <div id="homePage" class="box hidden">
        <h2>Welcome, <span id="loggedInUser"></span>!</h2>
        <button onclick="goToManagePublisher()">Manage Publisher Record</button>
        <button>Review Approvals</button>
        <button id="addReportBtn">Add Report</button>
        <button>Update Report</button>
        <button>Export to Excel</button>
        <button onclick="logout()">Logout</button>
        <button>Manage Users</button>
        <div style="margin-top: 30px;">
            <button onclick="clearAllData()">Clear All Data</button><br>
            <span class="danger">Warning: This will delete all publisher and report data.</span>
        </div>
    </div>

    <div id="publisherPage" class="box hidden" style="width: 600px;">
        <h2>Manage Publisher Record</h2>
        <label>Search Publisher:<br><input type="text" id="searchPublisher" autocomplete="off" placeholder="Type to search..." /><div id="suggestionBox" class="suggestions"></div></label><br>
        <label>First Name:<br><input id="firstName" type="text" /></label><br>
        <label>Last Name:<br><input id="lastName" type="text" /></label><br>
        <label>Full Name:<br><input id="fullName" disabled type="text"/></label><br>
        <label>Birthdate:<br><input id="birthdate" type="date" /></label><br>

        <label>Baptism Status:<br>
            <select id="baptismStatus" onchange="toggleBaptismDate()">
                <option>-- Select --</option>
                <option>Unbaptized Publisher</option>
                <option>Baptized</option>
                <option>Baptized but cannot remember the date</option>
            </select>
        </label><br>

        <div id="baptismDateContainer" class="hidden">
            <label>Baptism Date:<br><input id="baptismDate" type="date" /></label><br>
        </div>

        <label>Gender:<br>
            <select id="gender">
                <option>-- Select --</option>
                <option>Male</option>
                <option>Female</option>
            </select>
        </label><br>

        <label>Hope:<br>
            <select id="hope">
                <option>-- Select --</option>
                <option>Other Sheep</option>
                <option>Anointed</option>
            </select>
        </label><br>

        <label>Privilege:<br>
            <select id="privilege">
                <option>-- Select --</option>
                <option>Not Applicable</option>
                <option>Ministerial Servant</option>
                <option>Elder</option>
            </select>
        </label><br>

        <label>Privilege2:<br>
            <select id="privilege2">
                <option>-- Select --</option>
                <option>Regular Pioneer</option>
                <option>Special Pioneer</option>
                <option>Field Missionary</option>
                <option>Continuous Auxiliary Pioneer</option>
                <option>Publisher/Auxi</option>
            </select>
        </label><br>

        <label>Field Service Group:<br>
            <select id="fieldServiceGroup">
                <option>-- Select --</option>
                <option>Field Service Group 1</option>
                <option>Field Service Group 2</option>
                <option>Field Service Group 3</option>
                <option>Field Service Group 4</option>
                <option>Field Service Group 5</option>
                <option>Field Service Group 6</option>
                <option>Field Service Group 7</option>
                <option>Field Service Group 8</option>
            </select>
        </label><br><br>

        <button onclick="addPublisher()">Add</button>
        <button onclick="updatePublisher()">Update</button>
        <button onclick="deletePublisher()">Delete</button>
        <button onclick="previousPublisher()">←</button>
        <button onclick="nextPublisher()">→</button>
        <button onclick="clearPublisherForm()">Clear</button>
        <button onclick="backToHome()">Back to HomePage</button>
        <button onclick="logout()">Logout</button>
    </div>

    <div id="addReportPage" class="box hidden">
    <h2>Add Report</h2>

    <label>Search Publisher:<br>
        <input type="text" id="searchPublisherReport" placeholder="Search Publisher..." autocomplete="off">
        <div id="suggestionBoxReport" class="suggestions"></div>
    </label><br>

    <label>Publisher Name:<br>
        <select id="publisherNameDropdown">
            <option value="">-- Select --</option>
        </select>
    </label><br>

    <label>Field Service Group:<br>
        <input type="text" id="fieldGroup" disabled>
    </label><br>

    <label>Privilege2:<br>
        <input type="text" id="privilege2Report" disabled>
    </label><br>

    <label>Service Year:<br>
        <select id="serviceYearDropdown">
            <option value="">-- Select --</option>
        </select>
    </label><br>

    <label>Month and Year:<br>
        <select id="monthYearDropdown">
            <option value="">-- Select --</option>
        </select>
    </label><br>

    <div id="auxPioneerQuestionContainer" class="hidden">
        <label>Is The Publisher an Auxiliary Pioneer This Month?:<br>
            <select id="isAuxiliaryPioneerThisMonth">
                <option value="">-- Select --</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
            </select>
        </label><br>
    </div>

    <div id="fieldHoursContainer" class="hidden">
        <label>Field Hours:<br>
            <input type="number" id="fieldHours">
        </label><br>
    </div>

    <div id="bibleStudiesContainer" class="hidden">
        <label>Bible Studies:<br>
            <input type="number" id="bibleStudies">
        </label><br>
    </div>

    <div id="sharedMinistryContainer" class="hidden">
        <label><input type="checkbox" id="sharedMinistry"> Shared in Ministry</label><br>
    </div>

    <div id="auxiliaryPioneerCheckboxContainer" class="hidden">
        <label><input type="checkbox" id="auxiliaryPioneerCheckbox"> Auxiliary Pioneer</label><br>
    </div>

    <br>
    <button id="saveReportBtn">Save Report</button>
    <button id="clearReportBtn">Clear</button>
    <button id="backHomeFromReportBtn">Back to HomePage</button>
    <button onclick="logout()">Logout</button>
</div>
    
    <script>
        // Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDbKyWaYclW4jZ2eQ0qrK_PIfrh-7sahwY",
            authDomain: "field-service-reporter.firebaseapp.com",
            projectId: "field-service-reporter",
            storageBucket: "field-service-reporter.firebasestorage.app",
            messagingSenderId: "434729902657",
            appId: "1:434729902657:web:c1b06d2695a47924f89cc0",
            measurementId: "G-9N52K2CGDD"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let publisherList = []; // All publishers from Firebase
        let currentIndex = -1;  // Index of current displayed record
        let currentDocId = null;

        document.addEventListener("DOMContentLoaded", function () {
            // Setup for the initial page load
            document.getElementById("addReportBtn").addEventListener("click", goToAddReport);
            document.getElementById("backHomeFromReportBtn").addEventListener("click", backToHomeFromReport);
            document.getElementById("clearReportBtn").addEventListener("click", clearAddReportForm);
            
            // Setup for publisher form
            document.getElementById("firstName").addEventListener("input", updateFullName);
            document.getElementById("lastName").addEventListener("input", updateFullName);
        
        // --- Ito na ang bagong code na ilalagay mo ---

    // References to the search input and suggestion box
    const searchInput = document.getElementById("searchPublisher");
    const suggestionBox = document.getElementById("suggestionBox");

    // Add this EventListener for search suggestions
    searchInput.addEventListener("input", function () {
        const query = searchInput.value.toLowerCase();
        suggestionBox.innerHTML = ""; // Clear previous suggestions

        if (!query) return; // Don't show suggestions if input is empty

        const matches = publisherList.filter(pub =>
            pub.fullName && pub.fullName.toLowerCase().includes(query)
        );

        matches.forEach((pub) => {
            const div = document.createElement("div");
            div.textContent = pub.fullName;
            div.classList.add("suggestion-item");
            div.addEventListener("click", () => {
                // When a suggestion is clicked
                searchInput.value = pub.fullName; // Fill search box
                suggestionBox.innerHTML = ""; // Hide suggestions

                // Find the original index of the selected publisher
                const originalIndex = publisherList.findIndex(p => p.id === pub.id); // Use ID for precise matching
                if (originalIndex !== -1) {
                    currentIndex = originalIndex; // Set the current index
                    displayPublisher(currentIndex); // Display the selected publisher's data
                }
            });
            suggestionBox.appendChild(div);
        });
    });

    // --- Hanggang dito ang bagong code ---

}); // End of DOMContentLoaded

const serviceYearDropdown = document.getElementById("serviceYearDropdown");
const monthYearDropdown = document.getElementById("monthYearDropdown");

        // --- Core Functions ---
        
        // 🔐 Simple Login
        function login() {
            const user = document.getElementById("loginUsername").value;
            const pass = document.getElementById("loginPassword").value;

            if (user === "admin" && pass === "admin123") {
                document.getElementById("loginPage").classList.add("hidden");
                document.getElementById("homePage").classList.remove("hidden");
                document.getElementById("loggedInUser").textContent = user;
            } else {
                alert("Invalid credentials.");
            }
        }

        function logout() {
            document.getElementById("loginPage").classList.remove("hidden");
            document.getElementById("homePage").classList.add("hidden");
            document.getElementById("publisherPage").classList.add("hidden");
            document.getElementById("addReportPage").classList.add("hidden");

            document.getElementById("loginUsername").value = "";
            document.getElementById("loginPassword").value = "";

            clearPublisherForm();
            clearAddReportForm();

            currentIndex = -1;
            currentDocId = null;
            publisherList = [];
        }

        async function clearAllData() {
            if (confirm("Are you sure you want to delete all publisher data? This cannot be undone.")) {
                const snapshot = await db.collection("publishers").get();
                const batch = db.batch();

                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                alert("All publisher records deleted.");
                loadPublishers();
            }
        }

        // --- Publisher Management Functions ---
        
        function goToManagePublisher() {
            document.getElementById("homePage").classList.add("hidden");
            document.getElementById("publisherPage").classList.remove("hidden");
            loadPublishers();
            clearPublisherForm();
        }

        function backToHome() {
            document.getElementById("publisherPage").classList.add("hidden");
            document.getElementById("homePage").classList.remove("hidden");
        }

        async function loadPublishers() {
    const snapshot = await db.collection("publishers").orderBy("fullName", "asc").get();
    publisherList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Ensure 'id' is included
}
        // --- Report Management Functions ---

        function goToAddReport() {
            document.getElementById("homePage").classList.add("hidden");
            document.getElementById("addReportPage").classList.remove("hidden");
            setupAddReportPage();
        }

        function backToHomeFromReport() {
            document.getElementById("addReportPage").classList.add("hidden");
            document.getElementById("homePage").classList.remove("hidden");
        }

        // Use this updated selectPublisherOption for both search and direct dropdown selection
function selectPublisherOption(publisherId, dropdown) {
    Array.from(dropdown.options).forEach(opt => {
        if (opt.value === publisherId) {
            opt.selected = true;
        } else {
            opt.selected = false; // Deselect others
        }
    });
}
        
        // --- Other Functions ---

        function updateFullName() {
            const fn = document.getElementById("firstName").value.trim();
            const ln = document.getElementById("lastName").value.trim();
            document.getElementById("fullName").value = ln && fn ? `${ln}, ${fn}` : "";
        }
        
        // Placeholder save function for report
        document.getElementById("saveReportBtn").addEventListener("click", () => {
            alert("Report saved!");
        });
        
        // Placeholder for missing functions (you can add your logic here)
        function toggleBaptismDate() {
    const status = document.getElementById("baptismStatus").value;
    const baptismDateContainer = document.getElementById("baptismDateContainer");
    const baptismDateInput = document.getElementById("baptismDate");

    if (status === "Baptized") {
        baptismDateContainer.classList.remove("hidden"); // Show the container
    } else {
        baptismDateContainer.classList.add("hidden"); // Hide the container
        baptismDateInput.value = ""; // Clear the date when hidden
    }
}
        async function addPublisher() {
    const fn = document.getElementById("firstName").value.trim();
    const ln = document.getElementById("lastName").value.trim();
    const bd = document.getElementById("birthdate").value;
    const bs = document.getElementById("baptismStatus").value;
    const bDate = document.getElementById("baptismDate").value;
    const gender = document.getElementById("gender").value;
    const hope = document.getElementById("hope").value;
    const privilege = document.getElementById("privilege").value;
    const privilege2 = document.getElementById("privilege2").value;
    const group = document.getElementById("fieldServiceGroup").value;

    // Validation: Check if all required fields are filled and select options are chosen
    if (!fn || !ln || !bd || bs === "-- Select --" || gender === "-- Select --" || hope === "-- Select --" || privilege === "-- Select --" || privilege2 === "-- Select --" || group === "-- Select --" ||
        (bs === "Baptized" && !bDate)) {
        alert("Please complete all fields before adding a publisher.");
        return;
    }

    const docId = `${ln}_${fn}_${bd}`.replace(/\s+/g, "_"); // Simplified docId for Firebase

    // Check if publisher already exists
    const existingDoc = await db.collection("publishers").doc(docId).get();
    if (existingDoc.exists) {
        alert("A publisher with the same last name, first name, and birthdate already exists.");
        return;
    }

    // Add to Firebase
    await db.collection("publishers").doc(docId).set({
        firstName: fn,
        lastName: ln,
        birthdate: bd,
        baptismStatus: bs,
        baptismDate: bs === "Baptized" ? bDate : "", // Save baptism date only if status is "Baptized"
        gender: gender,
        hope: hope,
        privilege: privilege,
        privilege2: privilege2,
        fieldServiceGroup: group,
        fullName: `${ln}, ${fn}`, // Stored for easier search/display
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // For ordering
    });

    alert("Publisher record successfully added!");
    await loadPublishers(); // Reload to update list for navigation
    clearPublisherForm();
}
        async function updatePublisher() {
    if (!currentDocId) {
        alert("Please select a publisher record to update first.");
        return;
    }

    const fn = document.getElementById("firstName").value.trim();
    const ln = document.getElementById("lastName").value.trim();
    const bd = document.getElementById("birthdate").value;
    const bs = document.getElementById("baptismStatus").value;
    const bdate = document.getElementById("baptismDate").value;
    const gender = document.getElementById("gender").value;
    const hope = document.getElementById("hope").value;
    const priv = document.getElementById("privilege").value;
    const priv2 = document.getElementById("privilege2").value;
    const group = document.getElementById("fieldServiceGroup").value;

    // Validation: Check if all required fields are filled and select options are chosen
    if (!fn || !ln || !bd || bs === "-- Select --" || gender === "-- Select --" || hope === "-- Select --" || priv === "-- Select --" || priv2 === "-- Select --" || group === "-- Select --" ||
        (bs === "Baptized" && !bdate)) {
        alert("Please complete all fields before updating.");
        return;
    }

    const updatedData = {
        firstName: fn,
        lastName: ln,
        birthdate: bd,
        baptismStatus: bs,
        baptismDate: bs === "Baptized" ? bdate : "",
        gender: gender,
        hope: hope,
        privilege: priv,
        privilege2: priv2,
        fieldServiceGroup: group,
        fullName: `${ln}, ${fn}`, // Update full name in case of name change
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // Update timestamp if needed
    };

    try {
        await db.collection("publishers").doc(currentDocId).update(updatedData);
        alert("Publisher record updated successfully!");
        await loadPublishers(); // Reload to update list for navigation
        clearPublisherForm();
    } catch (error) {
        console.error("Error updating publisher:", error);
        alert("Failed to update publisher record. Please try again.");
    }
}
        async function deletePublisher() {
    if (!currentDocId) {
        alert("Please select a publisher record to delete first.");
        return;
    }

    const confirmed = confirm("Are you sure you want to delete this publisher record? This action cannot be undone.");
    if (!confirmed) {
        return;
    }

    try {
        await db.collection("publishers").doc(currentDocId).delete();
        alert("Publisher record deleted successfully!");
        await loadPublishers(); // Reload to update list and display next/previous record if available
        clearPublisherForm();
    } catch (error) {
        console.error("Error deleting publisher:", error);
        alert("Failed to delete publisher record. Please try again.");
    }
}
        function previousPublisher() {
    if (publisherList.length === 0) {
        alert("No records to display.");
        return;
    }
    if (currentIndex > 0) {
        currentIndex--;
        displayPublisher(currentIndex);
    } else {
        alert("This is the first record.");
    }
}

function nextPublisher() {
    if (publisherList.length === 0) {
        alert("No records to display.");
        return;
    }
    if (currentIndex < publisherList.length - 1) {
        currentIndex++;
        displayPublisher(currentIndex);
    } else {
        alert("This is the last record.");
    }
}
        function clearPublisherForm() {
    document.getElementById("firstName").value = "";
    document.getElementById("lastName").value = "";
    document.getElementById("birthdate").value = "";
    document.getElementById("baptismStatus").value = "-- Select --";
    document.getElementById("baptismDate").value = "";
    document.getElementById("baptismDateContainer").classList.add("hidden");
    document.getElementById("gender").value = "-- Select --";
    document.getElementById("hope").value = "-- Select --";
    document.getElementById("privilege").value = "-- Select --";
    document.getElementById("privilege2").value = "-- Select --";
    document.getElementById("fieldServiceGroup").value = "-- Select --";
    document.getElementById("fullName").value = "";

    // ✅ Ito ang mga idinagdag para sa search fields
    document.getElementById("searchPublisher").value = "";
    document.getElementById("suggestionBox").innerHTML = "";

    // Reset current selected record and index
    currentIndex = -1;
    currentDocId = null;
}
        function displayPublisher(index) {
    const pub = publisherList[index];
    if (!pub) {
        clearPublisherForm(); // Clear the form if no publisher is found at this index
        currentDocId = null;
        return;
    }

    document.getElementById("firstName").value = pub.firstName || "";
    document.getElementById("lastName").value = pub.lastName || "";
    document.getElementById("birthdate").value = pub.birthdate || "";
    document.getElementById("baptismStatus").value = pub.baptismStatus || "";

    // Toggle baptism date container
    const baptismDateContainer = document.getElementById("baptismDateContainer");
    const baptismDateInput = document.getElementById("baptismDate");
    if (pub.baptismStatus === "Baptized") {
        baptismDateContainer.classList.remove("hidden");
        baptismDateInput.value = pub.baptismDate || "";
    } else {
        baptismDateContainer.classList.add("hidden");
        baptismDateInput.value = ""; // Clear if not baptized
    }

    document.getElementById("gender").value = pub.gender || "";
    document.getElementById("hope").value = pub.hope || "";
    document.getElementById("privilege").value = pub.privilege || "";
    document.getElementById("privilege2").value = pub.privilege2 || "";
    document.getElementById("fieldServiceGroup").value = pub.fieldServiceGroup || "";

    // Update Full Name field based on current data
    document.getElementById("fullName").value = `${pub.lastName || ''}, ${pub.firstName || ''}`;

    // ✅ Crucial: Update currentDocId
    currentDocId = pub.id; // Use the actual document ID from Firebase
}
function populateServiceYears() {
    // Clear existing options first
    serviceYearDropdown.innerHTML = '<option value="">-- Select --</option>';
    const currentYear = new Date().getFullYear();
    // Assuming service year 2015 starts in Sep 2014, so current year should be valid
    const startYear = 2015;
    const endYear = 2200; // As per your requirement

    for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        serviceYearDropdown.appendChild(option);
    }
}

function populateMonths() {
    monthYearDropdown.innerHTML = '<option value="">-- Select --</option>';
    const selectedServiceYear = parseInt(serviceYearDropdown.value);

    if (isNaN(selectedServiceYear)) {
        return; // No service year selected
    }

    // Service Year Y runs from September of (Y-1) to August of Y
    const startMonthYear = new Date(selectedServiceYear - 1, 8, 1); // September of (Service Year - 1)
    const endMonthYear = new Date(selectedServiceYear, 7, 1);     // August of Service Year

    let currentMonth = startMonthYear;
    while (currentMonth <= endMonthYear) {
        const option = document.createElement("option");
        const monthName = currentMonth.toLocaleString('en-US', { month: 'long' });
        const year = currentMonth.getFullYear();
        option.value = `${monthName} ${year}`;
        option.textContent = `${monthName} ${year}`;
        monthYearDropdown.appendChild(option);

        // Move to the next month
        currentMonth.setMonth(currentMonth.getMonth() + 1);
    }
}
// Get references to all conditional fields and their containers
const auxPioneerQuestionContainer = document.getElementById("auxPioneerQuestionContainer");
const isAuxiliaryPioneerThisMonth = document.getElementById("isAuxiliaryPioneerThisMonth");
const fieldHoursContainer = document.getElementById("fieldHoursContainer");
const fieldHoursInput = document.getElementById("fieldHours");
const bibleStudiesContainer = document.getElementById("bibleStudiesContainer");
const bibleStudiesInput = document.getElementById("bibleStudies");
const sharedMinistryContainer = document.getElementById("sharedMinistryContainer");
const sharedMinistryCheckbox = document.getElementById("sharedMinistry");
const auxiliaryPioneerCheckboxContainer = document.getElementById("auxiliaryPioneerCheckboxContainer");
const auxiliaryPioneerCheckbox = document.getElementById("auxiliaryPioneerCheckbox");
const privilege2ReportInput = document.getElementById("privilege2Report"); // Get this element

function updateReportFieldsVisibility() {
    const privilege2 = privilege2ReportInput.value;
    const isAuxPioneerSelected = isAuxiliaryPioneerThisMonth.value;

    // Reset all to hidden/default states first
    auxPioneerQuestionContainer.classList.add("hidden");
    fieldHoursContainer.classList.add("hidden");
    bibleStudiesContainer.classList.add("hidden");
    sharedMinistryContainer.classList.add("hidden");
    auxiliaryPioneerCheckboxContainer.classList.add("hidden");

    fieldHoursInput.disabled = false;
    bibleStudiesInput.disabled = false;
    sharedMinistryCheckbox.disabled = false;
    auxiliaryPioneerCheckbox.disabled = false;

    sharedMinistryCheckbox.checked = false;
    auxiliaryPioneerCheckbox.checked = false;
    fieldHoursInput.value = "";
    bibleStudiesInput.value = "";

    switch (privilege2) {
        case "Regular Pioneer":
        case "Special Pioneer":
        case "Field Missionary":
            fieldHoursContainer.classList.remove("hidden");
            bibleStudiesContainer.classList.remove("hidden");
            sharedMinistryContainer.classList.remove("hidden");

            fieldHoursInput.oninput = () => { // Validate field hours input
                fieldHoursInput.value = fieldHoursInput.value.replace(/[^0-9]/g, ''); // Allow only digits
                const hours = parseInt(fieldHoursInput.value);
                if (hours > 0) {
                    sharedMinistryCheckbox.checked = true;
                    sharedMinistryCheckbox.disabled = true; // Disable if checked automatically
                } else {
                    sharedMinistryCheckbox.checked = false;
                    sharedMinistryCheckbox.disabled = false; // Enable if not checked automatically
                }
            };
            bibleStudiesInput.oninput = () => { // Validate bible studies input
                bibleStudiesInput.value = bibleStudiesInput.value.replace(/[^0-9]/g, ''); // Allow only digits
            };
            sharedMinistryCheckbox.disabled = true; // Initially disabled, controlled by Field Hours
            break;

        case "Continuous Auxiliary Pioneer":
            fieldHoursContainer.classList.remove("hidden");
            bibleStudiesContainer.classList.remove("hidden");
            sharedMinistryContainer.classList.remove("hidden");
            auxiliaryPioneerCheckboxContainer.classList.remove("hidden");

            fieldHoursInput.oninput = () => {
                fieldHoursInput.value = fieldHoursInput.value.replace(/[^0-9]/g, '');
                const hours = parseInt(fieldHoursInput.value);
                if (hours > 0) {
                    sharedMinistryCheckbox.checked = true;
                    sharedMinistryCheckbox.disabled = true;
                    auxiliaryPioneerCheckbox.checked = true;
                    auxiliaryPioneerCheckbox.disabled = true;
                } else {
                    sharedMinistryCheckbox.checked = false;
                    sharedMinistryCheckbox.disabled = false;
                    auxiliaryPioneerCheckbox.checked = false;
                    auxiliaryPioneerCheckbox.disabled = false;
                }
            };
            bibleStudiesInput.oninput = () => {
                bibleStudiesInput.value = bibleStudiesInput.value.replace(/[^0-9]/g, '');
            };
            sharedMinistryCheckbox.disabled = true; // Initially disabled
            auxiliaryPioneerCheckbox.disabled = true; // Initially disabled
            break;

        case "Publisher/Auxi":
            auxPioneerQuestionContainer.classList.remove("hidden");

            // Listen for changes on "Is The Publisher an Auxiliary Pioneer This Month?"
            isAuxiliaryPioneerThisMonth.onchange = () => {
                const currentAuxStatus = isAuxiliaryPioneerThisMonth.value;
                // Reset states for "Publisher/Auxi" first
                fieldHoursContainer.classList.add("hidden");
                bibleStudiesContainer.classList.add("hidden");
                sharedMinistryContainer.classList.add("hidden");
                auxiliaryPioneerCheckboxContainer.classList.add("hidden");

                fieldHoursInput.disabled = false;
                bibleStudiesInput.disabled = false;
                sharedMinistryCheckbox.disabled = false;
                auxiliaryPioneerCheckbox.disabled = false;

                sharedMinistryCheckbox.checked = false;
                auxiliaryPioneerCheckbox.checked = false;
                fieldHoursInput.value = "";
                bibleStudiesInput.value = "";


                if (currentAuxStatus === "Yes") {
                    fieldHoursContainer.classList.remove("hidden");
                    bibleStudiesContainer.classList.remove("hidden");
                    sharedMinistryContainer.classList.remove("hidden");
                    auxiliaryPioneerCheckboxContainer.classList.remove("hidden");

                    fieldHoursInput.oninput = () => {
                        fieldHoursInput.value = fieldHoursInput.value.replace(/[^0-9]/g, '');
                        const hours = parseInt(fieldHoursInput.value);
                        if (hours > 0) {
                            sharedMinistryCheckbox.checked = true;
                            sharedMinistryCheckbox.disabled = true;
                            auxiliaryPioneerCheckbox.checked = true;
                            auxiliaryPioneerCheckbox.disabled = true;
                        } else {
                            sharedMinistryCheckbox.checked = false;
                            sharedMinistryCheckbox.disabled = false;
                            auxiliaryPioneerCheckbox.checked = false;
                            auxiliaryPioneerCheckbox.disabled = false;
                        }
                    };
                    bibleStudiesInput.oninput = () => {
                        bibleStudiesInput.value = bibleStudiesInput.value.replace(/[^0-9]/g, '');
                    };
                    sharedMinistryCheckbox.disabled = true; // Initially disabled
                    auxiliaryPioneerCheckbox.disabled = true; // Initially disabled

                } else if (currentAuxStatus === "No") {
                    // Field Hours should be hidden
                    bibleStudiesContainer.classList.remove("hidden");
                    sharedMinistryContainer.classList.remove("hidden");

                    bibleStudiesInput.oninput = () => {
                        bibleStudiesInput.value = bibleStudiesInput.value.replace(/[^0-9]/g, '');
                    };
                    sharedMinistryCheckbox.disabled = false; // Enabled for user to check
                    auxiliaryPioneerCheckboxContainer.classList.add("hidden"); // Ensure hidden
                }
            };
            // Trigger the onchange initially if a value is already set (e.g., from loading data)
            isAuxiliaryPioneerThisMonth.onchange();
            break;

        default:
            // All hidden as default
            break;
    }
}

// Validation function for numeric inputs (Field Hours, Bible Studies)
function validateNumericInput(inputElement) {
    // Only allow non-negative integers
    inputElement.value = inputElement.value.replace(/[^0-9]/g, '');
}

// Function to attach validation and auto-check logic
function attachInputListeners() {
    // These listeners will be dynamically attached/re-attached inside updateReportFieldsVisibility
    // to ensure they follow the conditional logic precisely.
}
function clearAddReportForm() {
    // ... (Your existing clear logic) ...

    document.getElementById("searchPublisherReport").value = "";
    document.getElementById("suggestionBoxReport").innerHTML = ""; // Clear suggestions

    // Clear and reset values for autofilled fields
    document.getElementById("publisherNameDropdown").value = ""; // Reset dropdown
    document.getElementById("fieldGroup").value = "";
    document.getElementById("privilege2Report").value = "";

    // Clear and reset conditional fields
    document.getElementById("serviceYearDropdown").value = "";
    document.getElementById("monthYearDropdown").value = "";
    document.getElementById("fieldHours").value = "";
    document.getElementById("bibleStudies").value = "";
    document.getElementById("sharedMinistry").checked = false;
    document.getElementById("isAuxiliaryPioneerThisMonth").value = "";
    document.getElementById("auxiliaryPioneerCheckbox").checked = false;

    // Hide all conditional containers after clearing
    auxPioneerQuestionContainer.classList.add("hidden");
    fieldHoursContainer.classList.add("hidden");
    bibleStudiesContainer.classList.add("hidden");
    sharedMinistryContainer.classList.add("hidden");
    auxiliaryPioneerCheckboxContainer.classList.add("hidden");

    // Remove any specific oninput listeners attached dynamically to avoid stale closures
    fieldHoursInput.oninput = null;
    bibleStudiesInput.oninput = null;
    isAuxiliaryPioneerThisMonth.onchange = null;
}

function populatePublisherDropdown() {
    const publisherNameDropdown = document.getElementById("publisherNameDropdown");
    publisherNameDropdown.innerHTML = '<option value="">-- Select --</option>'; // Clear previous options

    // Make sure publisherList is populated (e.g., from loadPublishers() on login/page load)
    if (publisherList && publisherList.length > 0) {
        publisherList.forEach(pub => {
            const opt = document.createElement("option");
            opt.value = pub.id; // Store Firebase document ID as value
            opt.textContent = pub.fullName;
            publisherNameDropdown.appendChild(opt);
        });
    }
}
function autofillPublisherDetails(publisherId) {
    const selectedPublisher = publisherList.find(pub => pub.id === publisherId);
    const fieldGroupInput = document.getElementById("fieldGroup");
    const privilege2ReportInput = document.getElementById("privilege2Report"); // Use correct ID

    if (selectedPublisher) {
        fieldGroupInput.value = selectedPublisher.fieldServiceGroup || "";
        privilege2ReportInput.value = selectedPublisher.privilege2 || "";
    } else {
        fieldGroupInput.value = "";
        privilege2ReportInput.value = "";
    }

    // Trigger visibility update based on the newly autofilled privilege2
    updateReportFieldsVisibility();
}
// Get references for Add Report's search fields
const searchPublisherReportInput = document.getElementById("searchPublisherReport");
const suggestionBoxReport = document.getElementById("suggestionBoxReport");

searchPublisherReportInput.addEventListener("input", function () {
    const query = searchPublisherReportInput.value.toLowerCase();
    suggestionBoxReport.innerHTML = ""; // Clear previous suggestions

    if (!query) return;

    const matches = publisherList.filter(pub =>
        pub.fullName && pub.fullName.toLowerCase().includes(query)
    );

    matches.forEach((pub) => {
        const div = document.createElement("div");
        div.textContent = pub.fullName;
        div.classList.add("suggestion-item");
        div.addEventListener("click", () => {
            // When a suggestion is clicked
            searchPublisherReportInput.value = pub.fullName; // Fill search box
            suggestionBoxReport.innerHTML = ""; // Hide suggestions

            // ✅ Select the corresponding option in the Publisher Name dropdown
            const publisherNameDropdown = document.getElementById("publisherNameDropdown");
            selectPublisherOption(pub.id, publisherNameDropdown); // Function to select dropdown option

            // ✅ Autofill Field Service Group and Privilege2
            autofillPublisherDetails(pub.id);
        });
        suggestionBoxReport.appendChild(div);
    });
});
function setupAddReportPage() {
    // 1. Get references to elements (moved inside the function for better scope management)
    const searchInput = document.getElementById("searchPublisherReport");
    const suggestionBox = document.getElementById("suggestionBoxReport");
    const publisherNameDropdown = document.getElementById("publisherNameDropdown");
    const fieldGroupInput = document.getElementById("fieldGroup");
    const privilege2Input = document.getElementById("privilege2Report"); // This is the same as privilege2ReportInput from previous explanation

    // 2. Clear fields (from your first setupAddReportPage)
    searchInput.value = "";
    publisherNameDropdown.innerHTML = '<option value="">-- Select --</option>'; // Added value=""
    fieldGroupInput.value = "";
    privilege2Input.value = "";

    // 3. Populate Publisher Name dropdown (from previous response, using populatePublisherDropdown)
    populatePublisherDropdown(); // This function will fill publisherNameDropdown

    // 4. Autocomplete search logic (from your first setupAddReportPage, slightly modified)
    searchInput.addEventListener("input", function () {
        const query = searchInput.value.toLowerCase();
        suggestionBox.innerHTML = "";

        if (!query) return;

        const matches = publisherList.filter(pub =>
            pub.fullName && pub.fullName.toLowerCase().includes(query)
        );

        matches.forEach(pub => {
            const div = document.createElement("div");
            div.textContent = pub.fullName;
            div.classList.add("suggestion-item");
            div.addEventListener("click", () => {
                searchInput.value = pub.fullName;
                suggestionBox.innerHTML = "";
                // Instead of directly setting value, use selectPublisherOption and then autofill
                selectPublisherOption(pub.id, publisherNameDropdown); // Select in dropdown
                autofillPublisherDetails(pub.id); // Autofill fields and trigger visibility update
            });
            suggestionBox.appendChild(div);
        });
    });

    // 5. Handle Publisher Name dropdown change (from your first setupAddReportPage, modified to use autofillPublisherDetails)
    publisherNameDropdown.addEventListener("change", function () {
        autofillPublisherDetails(this.value); // Use the new autofill function
    });

    // 6. Populate service years and months (from previous response)
    populateServiceYears();
    populateMonths(); // Call initially in case a service year is pre-selected

    // 7. Event Listener for Service Year dropdown change (from previous response)
    serviceYearDropdown.addEventListener("change", populateMonths);

    // 8. Event Listener for "Is Auxiliary Pioneer This Month?" dropdown (from previous response)
    isAuxiliaryPioneerThisMonth.addEventListener("change", updateReportFieldsVisibility);

    // 9. Initial call to set up the fields based on initial state
    // This will be triggered by autofillPublisherDetails when a publisher is selected
    // If no publisher is selected initially, it will use the empty privilege2Input value
    updateReportFieldsVisibility();
}    
    </script>
</body>
</html>
