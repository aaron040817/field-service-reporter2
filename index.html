<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Publisher App with Login</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 30px; }
    .hidden { display: none; }
    input, button { margin: 10px 0; padding: 8px; width: 300px; }
    .box { border: 1px solid #ccc; padding: 20px; border-radius: 8px; width: 400px; }
    button { width: auto; display: inline-block; margin-right: 10px; }
    .danger { color: red; font-size: 12px; }
    .suggestions {
  max-height: 150px;
  overflow-y: auto;
  background: white;
  position: absolute;
  z-index: 100;
  width: 100%;
}

.suggestion-item {
  padding: 8px;
  cursor: pointer;
}

.suggestion-item:hover {
  background-color: #f0f0f0;
}  
  </style>
</head>
<body>

<!-- üîê LOGIN PAGE -->
<div id="loginPage" class="box">
  <h2>Login</h2>
  <label>Username:<br><input type="text" id="loginUsername"></label><br>
  <label>Password:<br><input type="password" id="loginPassword"></label><br>
  <button onclick="login()">Login</button>
</div>

<!-- üè† HOME PAGE -->
<div id="homePage" class="box hidden">
  <h2>Welcome, <span id="loggedInUser"></span>!</h2>
  <button onclick="goToManagePublisher()">Manage Publisher Record</button>
  <button>Review Approvals</button>
  <button>Add Report</button>
  <button>Update Report</button>
  <button>Export to Excel</button>
  <button>Logout</button>
  <button>Manage Users</button>
  <div style="margin-top: 30px;">
    <button onclick="clearAllData()">Clear All Data</button><br>
    <span class="danger">Warning: This will delete all publisher and report data.</span>
  </div>
</div>

<!-- üìã MANAGE PUBLISHER PAGE -->
<div id="publisherPage" class="box hidden" style="width: 600px;">
  <h2>Manage Publisher Record</h2>
  <label>Search Publisher:<br><input type="text" id="searchPublisher" autocomplete="off" placeholder="Type to search..." /><div id="suggestionBox" class="suggestions"></div></label><br>
  <label>First Name:<br><input id="firstName" type="text" /></label><br>
  <label>Last Name:<br><input id="lastName" type="text" /></label><br>
  <label>Full Name:<br><input id="fullName" disabled type="text"/></label><br>
  <label>Birthdate:<br><input id="birthdate" type="date" /></label><br>

  <label>Baptism Status:<br>
    <select id="baptismStatus" onchange="toggleBaptismDate()">
      <option>-- Select --</option>
      <option>Unbaptized Publisher</option>
      <option>Baptized</option>
      <option>Baptized but cannot remember the date</option>
    </select>
  </label><br>

  <div id="baptismDateContainer" class="hidden">
    <label>Baptism Date:<br><input id="baptismDate" type="date" /></label><br>
  </div>

  <label>Gender:<br>
    <select id="gender">
      <option>-- Select --</option>
      <option>Male</option>
      <option>Female</option>
    </select>
  </label><br>

  <label>Hope:<br>
    <select id="hope">
      <option>-- Select --</option>
      <option>Other Sheep</option>
      <option>Anointed</option>
    </select>
  </label><br>

  <label>Privilege:<br>
    <select id="privilege">
      <option>-- Select --</option>
      <option>Not Applicable</option>
      <option>Ministerial Servant</option>
      <option>Elder</option>
    </select>
  </label><br>

  <label>Privilege2:<br>
    <select id="privilege2">
      <option>-- Select --</option>
      <option>Regular Pioneer</option>
      <option>Special Pioneer</option>
      <option>Field Missionary</option>
      <option>Continuous Auxiliary Pioneer</option>
      <option>Publisher/Auxi</option>
    </select>
  </label><br>

  <label>Field Service Group:<br>
    <select id="fieldServiceGroup">
      <option>-- Select --</option>
      <option>Field Service Group 1</option>
      <option>Field Service Group 2</option>
      <option>Field Service Group 3</option>
      <option>Field Service Group 4</option>
      <option>Field Service Group 5</option>
      <option>Field Service Group 6</option>
      <option>Field Service Group 7</option>
      <option>Field Service Group 8</option>
    </select>
  </label><br><br>

  <!-- Action Buttons -->
  <button onclick="addPublisher()">Add</button>
  <button onclick="updatePublisher()">Update</button>
  <button onclick="deletePublisher()">Delete</button>
  <button onclick="previousPublisher()">‚Üê</button>
  <button onclick="nextPublisher()">‚Üí</button>
  <button onclick="clearPublisherForm()">Clear</button>
  <button onclick="backToHome()">Back to HomePage</button>
  <button onclick="logout()">Logout</button>
</div>

<script>
  // Replace with your Firebase config
  const firebaseConfig = {
  apiKey: "AIzaSyDbKyWaYclW4jZ2eQ0qrK_PIfrh-7sahwY",
  authDomain: "field-service-reporter.firebaseapp.com",
  projectId: "field-service-reporter",
  storageBucket: "field-service-reporter.firebasestorage.app",
  messagingSenderId: "434729902657",
  appId: "1:434729902657:web:c1b06d2695a47924f89cc0",
  measurementId: "G-9N52K2CGDD"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

let publisherList = []; // All publishers from Firebase
let currentIndex = -1;  // Index of current displayed record
let currentDocId = null;
  
  // üîê Simple Login
  function login() {
    const user = document.getElementById("loginUsername").value;
    const pass = document.getElementById("loginPassword").value;

    if (user === "admin" && pass === "admin123") {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("homePage").classList.remove("hidden");
      document.getElementById("loggedInUser").textContent = user;
    } else {
      alert("Invalid credentials.");
    }
  }

  function logout() {
    document.getElementById("homePage").classList.add("hidden");
    document.getElementById("loginPage").classList.remove("hidden");
  }

  function clearAllData() {
    if (confirm("Are you sure you want to delete all publisher data?")) {
      db.collection("publishers").get().then(snapshot => {
        snapshot.forEach(doc => doc.ref.delete());
        alert("All publisher records deleted.");
        loadPublishers();
      });
    }
  }

  // üîÅ Page Navigation
  function goToManagePublisher() {
  document.getElementById("homePage").classList.add("hidden");
  document.getElementById("publisherPage").classList.remove("hidden");

  clearPublisherForm(); // ‚úÖ clear muna agad
  loadPublishers();     // ‚úÖ tapos load ang list for navigation
}

  function backToHome() {
    document.getElementById("publisherPage").classList.add("hidden");
    document.getElementById("homePage").classList.remove("hidden");
  }

  // üîÑ Firebase Save/Load
  async function savePublisher() {
    const fn = document.getElementById("firstName").value.trim();
    const ln = document.getElementById("lastName").value.trim();
    const bd = document.getElementById("birthdate").value;

    if (!fn || !ln || !bd) return alert("Fill all fields.");

    const docId = `${ln}_${fn}_${bd}`.replace(/\s+/g, "_");
    await db.collection("publishers").doc(docId).set({
      firstName: fn,
      lastName: ln,
      birthdate: bd,
      fullName: `${ln}, ${fn}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("Saved!");
    loadPublishers();
  }

  function loadPublishers() {
  db.collection("publishers").orderBy("timestamp", "desc").get().then(snapshot => {
    publisherList = [];
    snapshot.forEach(doc => {
      publisherList.push({ id: doc.id, ...doc.data() });  // store document ID
    });

    // ‚úÖ Show only if something is selected (e.g., via navigation)
    if (currentIndex >= 0 && currentIndex < publisherList.length) {
      displayPublisher(currentIndex);
    }
  });
}
const searchInput = document.getElementById("searchPublisher");
const suggestionBox = document.getElementById("suggestionBox");

searchInput.addEventListener("input", function () {
  const query = searchInput.value.toLowerCase();
  suggestionBox.innerHTML = "";

  if (!query) return;

  const matches = publisherList.filter(pub =>
    pub.fullName && pub.fullName.toLowerCase().includes(query)
  );

  matches.forEach((pub, index) => {
    const div = document.createElement("div");
    div.textContent = pub.fullName;
    div.classList.add("suggestion-item");
    div.addEventListener("click", () => {
      // Show selected
      searchInput.value = pub.fullName;
      suggestionBox.innerHTML = "";

      // Show record in form
      const originalIndex = publisherList.findIndex(p => p.fullName === pub.fullName);
if (originalIndex !== -1) {
  currentIndex = originalIndex;
  displayPublisher(currentIndex);
}
    });
    suggestionBox.appendChild(div);
  });
});

function toggleBaptismDate() {
  const status = document.getElementById("baptismStatus").value;
  const baptismDateContainer = document.getElementById("baptismDateContainer");

  if (status === "Baptized") {
    baptismDateContainer.classList.remove("hidden");
  } else {
    baptismDateContainer.classList.add("hidden");
    document.getElementById("baptismDate").value = "";
  }
}
async function addPublisher() {
  const fn = document.getElementById("firstName").value.trim();
  const ln = document.getElementById("lastName").value.trim();
  const bd = document.getElementById("birthdate").value;
  const bs = document.getElementById("baptismStatus").value;
  const bDate = document.getElementById("baptismDate").value;
  const gender = document.getElementById("gender").value;
  const hope = document.getElementById("hope").value;
  const privilege = document.getElementById("privilege").value;
  const privilege2 = document.getElementById("privilege2").value;
  const group = document.getElementById("fieldServiceGroup").value;

  // Validate fields
  if (!fn || !ln || !bd || !bs || !gender || !hope || !privilege || !privilege2 || !group ||
      (bs === "Baptized" && !bDate)) {
    alert("Please complete all fields before submitting.");
    return;
  }

  const docId = `${ln}_${fn}_${bd}`.replace(/\s+/g, "_");

  // üîé Check if publisher already exists
  const existingDoc = await db.collection("publishers").doc(docId).get();
  if (existingDoc.exists) {
    alert("A publisher with the same name and birthdate already exists.");
    return;
  }

  // ‚úÖ Add to Firebase
  await db.collection("publishers").doc(docId).set({
    firstName: fn,
    lastName: ln,
    birthdate: bd,
    baptismStatus: bs,
    baptismDate: bs === "Baptized" ? bDate : "",
    gender: gender,
    hope: hope,
    privilege: privilege,
    privilege2: privilege2,
    fieldServiceGroup: group,
    fullName: `${ln}, ${fn}`,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Publisher successfully added!");
  clearPublisherForm();
  loadPublishers();
}

function clearPublisherForm() {
  document.getElementById("firstName").value = "";
  document.getElementById("lastName").value = "";
  document.getElementById("birthdate").value = "";
  document.getElementById("baptismStatus").value = "";
  document.getElementById("baptismDate").value = "";
  document.getElementById("gender").value = "";
  document.getElementById("hope").value = "";
  document.getElementById("privilege").value = "";
  document.getElementById("privilege2").value = "";
  document.getElementById("fieldServiceGroup").value = "";
  document.getElementById("fullName").value = ""; // ‚úÖ Clear Full Name
  document.getElementById("searchPublisher").value = "";

  currentIndex = -1;
  currentDocId = "";
}

function displayPublisher(index) {
  const pub = publisherList[index];
  if (!pub) return;

  document.getElementById("firstName").value = pub.firstName || "";
  document.getElementById("lastName").value = pub.lastName || "";
  document.getElementById("birthdate").value = pub.birthdate || "";
  document.getElementById("baptismStatus").value = pub.baptismStatus || "";
  document.getElementById("baptismDate").value = pub.baptismDate || "";

  if (pub.baptismStatus === "Baptized") {
    document.getElementById("baptismDateContainer").classList.remove("hidden");
  } else {
    document.getElementById("baptismDateContainer").classList.add("hidden");
  }

  document.getElementById("gender").value = pub.gender || "";
  document.getElementById("hope").value = pub.hope || "";
  document.getElementById("privilege").value = pub.privilege || "";
  document.getElementById("privilege2").value = pub.privilege2 || "";
  document.getElementById("fieldServiceGroup").value = pub.fieldServiceGroup || "";

  // ‚úÖ Fill in the full name textbox
  document.getElementById("fullName").value = `${pub.lastName}, ${pub.firstName}`;

  currentDocId = `${pub.lastName}_${pub.firstName}_${pub.birthdate}`.replace(/\s+/g, "_");
}

function previousPublisher() {
  if (publisherList.length === 0) return;
  if (currentIndex > 0) {
    currentIndex--;
    displayPublisher(currentIndex);
  } else {
    alert("This is the first record.");
  }
}
function nextPublisher() {
  if (publisherList.length === 0) return;
  if (currentIndex < publisherList.length - 1) {
    currentIndex++;
    displayPublisher(currentIndex);
  } else {
    alert("This is the last record.");
  }
}
function updatePublisher() {
  if (!currentDocId) {
    alert("Please select a publisher to update.");
    return;
  }

  const fn = document.getElementById("firstName").value.trim();
  const ln = document.getElementById("lastName").value.trim();
  const bd = document.getElementById("birthdate").value;
  const bs = document.getElementById("baptismStatus").value;
  const bdate = document.getElementById("baptismDate").value;
  const gender = document.getElementById("gender").value;
  const hope = document.getElementById("hope").value;
  const priv = document.getElementById("privilege").value;
  const priv2 = document.getElementById("privilege2").value;
  const group = document.getElementById("fieldServiceGroup").value;

  if (!fn || !ln || !bd || !bs || !gender || !hope || !priv || !priv2 || !group ||
      (bs === "Baptized" && !bdate)) {
    alert("Please complete all fields.");
    return;
  }

  const updatedData = {
    firstName: fn,
    lastName: ln,
    birthdate: bd,
    baptismStatus: bs,
    baptismDate: bs === "Baptized" ? bdate : "",
    gender: gender,
    hope: hope,
    privilege: priv,
    privilege2: priv2,
    fieldServiceGroup: group,
    fullName: `${ln}, ${fn}`,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  db.collection("publishers").doc(currentDocId).update(updatedData).then(() => {
    alert("Publisher updated successfully.");
    clearPublisherForm();     // ‚úÖ clear fields
    loadPublishers();         // ‚úÖ reload list (but won't re-display unless selected)
  });
}
function deletePublisher() {
  if (!currentDocId) {
    alert("Please select a publisher to delete.");
    return;
  }

  const confirmed = confirm("Are you sure you want to delete this publisher?");
  if (!confirmed) return;

  db.collection("publishers").doc(currentDocId).delete()
    .then(() => {
      alert("Publisher deleted successfully.");
      clearPublisherForm();
      loadPublishers();
    })
    .catch((error) => {
      console.error("Error deleting publisher:", error);
      alert("Error deleting publisher. See console for details.");
    });
}
function logout() {
  // Hide all pages
  document.getElementById("homePage").classList.add("hidden");
  document.getElementById("publisherPage").classList.add("hidden");

  // Show login page
  document.getElementById("loginPage").classList.remove("hidden");

  // Clear login inputs
  document.getElementById("loginUsername").value = "";
  document.getElementById("loginPassword").value = "";

  // Clear publisher form (in case opened before logout)
  clearPublisherForm();

  // Reset state variables
  currentIndex = -1;
  currentDocId = null;
  publisherList = [];
}
document.getElementById("firstName").addEventListener("input", updateFullName);
document.getElementById("lastName").addEventListener("input", updateFullName);

function updateFullName() {
  const fn = document.getElementById("firstName").value.trim();
  const ln = document.getElementById("lastName").value.trim();
  document.getElementById("fullName").value = ln && fn ? `${ln}, ${fn}` : "";
}

</script>
</body>
</html>
