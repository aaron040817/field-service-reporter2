<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Publisher App with Login</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 30px; }
    .hidden { display: none; }
    input, button { margin: 10px 0; padding: 8px; width: 300px; }
    .box { border: 1px solid #ccc; padding: 20px; border-radius: 8px; width: 400px; }
    button { width: auto; display: inline-block; margin-right: 10px; }
    .danger { color: red; font-size: 12px; }
  </style>
</head>
<body>

<!-- üîê LOGIN PAGE -->
<div id="loginPage" class="box">
  <h2>Login</h2>
  <label>Username:<br><input type="text" id="loginUsername"></label><br>
  <label>Password:<br><input type="password" id="loginPassword"></label><br>
  <button onclick="login()">Login</button>
</div>

<!-- üè† HOME PAGE -->
<div id="homePage" class="box hidden">
  <h2>Welcome, <span id="loggedInUser"></span>!</h2>
  <button onclick="goToManagePublisher()">Manage Publisher Record</button>
  <button>Review Approvals</button>
  <button>Add Report</button>
  <button>Update Report</button>
  <button>Export to Excel</button>
  <button>Logout</button>
  <button>Manage Users</button>
  <div style="margin-top: 30px;">
    <button onclick="clearAllData()">Clear All Data</button><br>
    <span class="danger">Warning: This will delete all publisher and report data.</span>
  </div>
</div>

<!-- üìã MANAGE PUBLISHER PAGE -->
<div id="publisherPage" class="box hidden" style="width: 600px;">
  <h2>Manage Publisher Record</h2>

  <label>First Name:<br><input id="firstName" type="text" /></label><br>
  <label>Last Name:<br><input id="lastName" type="text" /></label><br>
  <label>Birthdate:<br><input id="birthdate" type="date" /></label><br>

  <label>Baptism Status:<br>
    <select id="baptismStatus" onchange="toggleBaptismDate()">
      <option>-- Select --</option>
      <option>Unbaptized Publisher</option>
      <option>Baptized</option>
      <option>Baptized but cannot remember the date</option>
    </select>
  </label><br>

  <div id="baptismDateContainer" class="hidden">
    <label>Baptism Date:<br><input id="baptismDate" type="date" /></label><br>
  </div>

  <label>Gender:<br>
    <select id="gender">
      <option>-- Select --</option>
      <option>Male</option>
      <option>Female</option>
    </select>
  </label><br>

  <label>Hope:<br>
    <select id="hope">
      <option>-- Select --</option>
      <option>Other Sheep</option>
      <option>Anointed</option>
    </select>
  </label><br>

  <label>Privilege:<br>
    <select id="privilege">
      <option>-- Select --</option>
      <option>Not Applicable</option>
      <option>Ministerial Servant</option>
      <option>Elder</option>
    </select>
  </label><br>

  <label>Privilege2:<br>
    <select id="privilege2">
      <option>-- Select --</option>
      <option>Regular Pioneer</option>
      <option>Special Pioneer</option>
      <option>Field Missionary</option>
      <option>Continuous Auxiliary Pioneer</option>
      <option>Publisher/Auxi</option>
    </select>
  </label><br>

  <label>Field Service Group:<br>
    <select id="fieldServiceGroup">
      <option>-- Select --</option>
      <option>Field Service Group 1</option>
      <option>Field Service Group 2</option>
      <option>Field Service Group 3</option>
      <option>Field Service Group 4</option>
      <option>Field Service Group 5</option>
      <option>Field Service Group 6</option>
      <option>Field Service Group 7</option>
      <option>Field Service Group 8</option>
    </select>
  </label><br><br>

  <!-- Action Buttons -->
  <button onclick="addPublisher()">Add</button>
  <button onclick="updatePublisher()">Update</button>
  <button onclick="deletePublisher()">Delete</button>
  <button onclick="previousPublisher()">‚Üê</button>
  <button onclick="nextPublisher()">‚Üí</button>
  <button onclick="clearPublisherForm()">Clear</button>
  <button onclick="backToHome()">Back to HomePage</button>
  <button onclick="logout()">Logout</button>
</div>

<script>
  // Replace with your Firebase config
  const firebaseConfig = {
  apiKey: "AIzaSyDbKyWaYclW4jZ2eQ0qrK_PIfrh-7sahwY",
  authDomain: "field-service-reporter.firebaseapp.com",
  projectId: "field-service-reporter",
  storageBucket: "field-service-reporter.firebasestorage.app",
  messagingSenderId: "434729902657",
  appId: "1:434729902657:web:c1b06d2695a47924f89cc0",
  measurementId: "G-9N52K2CGDD"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

let publisherList = []; // All publishers from Firebase
let currentIndex = -1;  // Index of current displayed record
let currentDocId = null;
  
  // üîê Simple Login
  function login() {
    const user = document.getElementById("loginUsername").value;
    const pass = document.getElementById("loginPassword").value;

    if (user === "admin" && pass === "admin123") {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("homePage").classList.remove("hidden");
      document.getElementById("loggedInUser").textContent = user;
    } else {
      alert("Invalid credentials.");
    }
  }

  function logout() {
    document.getElementById("homePage").classList.add("hidden");
    document.getElementById("loginPage").classList.remove("hidden");
  }

  function clearAllData() {
    if (confirm("Are you sure you want to delete all publisher data?")) {
      db.collection("publishers").get().then(snapshot => {
        snapshot.forEach(doc => doc.ref.delete());
        alert("All publisher records deleted.");
        loadPublishers();
      });
    }
  }

  // üîÅ Page Navigation
  function goToManagePublisher() {
  clearPublisherForm(); // Clear all form fields
  document.getElementById("homePage").classList.add("hidden");
  document.getElementById("publisherPage").classList.remove("hidden");
  loadPublishers(); // Load records for navigation
}

  function backToHome() {
    document.getElementById("publisherPage").classList.add("hidden");
    document.getElementById("homePage").classList.remove("hidden");
  }

  // üîÑ Firebase Save/Load
  async function savePublisher() {
    const fn = document.getElementById("firstName").value.trim();
    const ln = document.getElementById("lastName").value.trim();
    const bd = document.getElementById("birthdate").value;

    if (!fn || !ln || !bd) return alert("Fill all fields.");

    const docId = `${ln}_${fn}_${bd}`.replace(/\s+/g, "_");
    await db.collection("publishers").doc(docId).set({
      firstName: fn,
      lastName: ln,
      birthdate: bd,
      fullName: `${ln}, ${fn}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("Saved!");
    loadPublishers();
  }

  async function loadPublishers() {
  publisherList = [];
  currentIndex = -1;

  const snapshot = await db.collection("publishers").orderBy("timestamp", "desc").get();
  snapshot.forEach(doc => {
    publisherList.push(doc.data());
  });

  if (publisherList.length > 0) {
  currentIndex = -1; // start with no selection
} else {
  clearPublisherForm();
  alert("No publisher records found.");
}
}

function toggleBaptismDate() {
  const status = document.getElementById("baptismStatus").value;
  const baptismDateContainer = document.getElementById("baptismDateContainer");

  if (status === "Baptized") {
    baptismDateContainer.classList.remove("hidden");
  } else {
    baptismDateContainer.classList.add("hidden");
    document.getElementById("baptismDate").value = "";
  }
}
async function addPublisher() {
  const fn = document.getElementById("firstName").value.trim();
  const ln = document.getElementById("lastName").value.trim();
  const bd = document.getElementById("birthdate").value;
  const bs = document.getElementById("baptismStatus").value;
  const bDate = document.getElementById("baptismDate").value;
  const gender = document.getElementById("gender").value;
  const hope = document.getElementById("hope").value;
  const privilege = document.getElementById("privilege").value;
  const privilege2 = document.getElementById("privilege2").value;
  const group = document.getElementById("fieldServiceGroup").value;

  // Validate fields
  if (!fn || !ln || !bd || !bs || !gender || !hope || !privilege || !privilege2 || !group ||
      (bs === "Baptized" && !bDate)) {
    alert("Please complete all fields before submitting.");
    return;
  }

  const docId = `${ln}_${fn}_${bd}`.replace(/\s+/g, "_");

  // üîé Check if publisher already exists
  const existingDoc = await db.collection("publishers").doc(docId).get();
  if (existingDoc.exists) {
    alert("A publisher with the same name and birthdate already exists.");
    return;
  }

  // ‚úÖ Add to Firebase
  await db.collection("publishers").doc(docId).set({
    firstName: fn,
    lastName: ln,
    birthdate: bd,
    baptismStatus: bs,
    baptismDate: bs === "Baptized" ? bDate : "",
    gender: gender,
    hope: hope,
    privilege: privilege,
    privilege2: privilege2,
    fieldServiceGroup: group,
    fullName: `${ln}, ${fn}`,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Publisher successfully added!");
  clearPublisherForm();
  loadPublishers();
}

function clearPublisherForm() {
  document.getElementById("firstName").value = "";
  document.getElementById("lastName").value = "";
  document.getElementById("birthdate").value = "";
  document.getElementById("baptismStatus").selectedIndex = 0;
  document.getElementById("baptismDate").value = "";
  document.getElementById("baptismDateContainer").classList.add("hidden");
  document.getElementById("gender").selectedIndex = 0;
  document.getElementById("hope").selectedIndex = 0;
  document.getElementById("privilege").selectedIndex = 0;
  document.getElementById("privilege2").selectedIndex = 0;
  document.getElementById("fieldServiceGroup").selectedIndex = 0;

// Redisplay the current record after clearing
if (currentIndex >= 0 && currentIndex < publisherList.length) {
  displayPublisher(currentIndex);
}
}

function displayPublisher(index) {
  const pub = publisherList[index];
  if (!pub) return;

  document.getElementById("firstName").value = pub.firstName || "";
  document.getElementById("lastName").value = pub.lastName || "";
  document.getElementById("birthdate").value = pub.birthdate || "";
  document.getElementById("baptismStatus").value = pub.baptismStatus || "";
  document.getElementById("baptismDate").value = pub.baptismDate || "";

  // Show/hide baptism date field
  if (pub.baptismStatus === "Baptized") {
    document.getElementById("baptismDateContainer").classList.remove("hidden");
  } else {
    document.getElementById("baptismDateContainer").classList.add("hidden");
  }

  document.getElementById("gender").value = pub.gender || "";
  document.getElementById("hope").value = pub.hope || "";
  document.getElementById("privilege").value = pub.privilege || "";
  document.getElementById("privilege2").value = pub.privilege2 || "";
  document.getElementById("fieldServiceGroup").value = pub.fieldServiceGroup || "";

  // Save the current docId for updating
  currentDocId = `${pub.lastName}_${pub.firstName}_${pub.birthdate}`.replace(/\s+/g, "_");
}

function previousPublisher() {
  if (publisherList.length === 0) return;
  if (currentIndex > 0) {
    currentIndex--;
    displayPublisher(currentIndex);
  } else {
    alert("This is the first record.");
  }
}
function nextPublisher() {
  if (publisherList.length === 0) return;
  if (currentIndex < publisherList.length - 1) {
    currentIndex++;
    displayPublisher(currentIndex);
  } else {
    alert("This is the last record.");
  }
}
async function updatePublisher() {
  if (currentIndex === -1 || !publisherList[currentIndex] || !currentDocId) {
    alert("Please select a record to update first.");
    return;
  }

  const fn = document.getElementById("firstName").value.trim();
  const ln = document.getElementById("lastName").value.trim();
  const bd = document.getElementById("birthdate").value;
  const bs = document.getElementById("baptismStatus").value;
  const bDate = document.getElementById("baptismDate").value;
  const gender = document.getElementById("gender").value;
  const hope = document.getElementById("hope").value;
  const privilege = document.getElementById("privilege").value;
  const privilege2 = document.getElementById("privilege2").value;
  const group = document.getElementById("fieldServiceGroup").value;

  if (!fn || !ln || !bd || !bs || !gender || !hope || !privilege || !privilege2 || !group ||
      (bs === "Baptized" && !bDate)) {
    alert("Please complete all fields before updating.");
    return;
  }

  // Use original docId to overwrite the correct record
  await db.collection("publishers").doc(currentDocId).set({
    firstName: fn,
    lastName: ln,
    birthdate: bd,
    baptismStatus: bs,
    baptismDate: bs === "Baptized" ? bDate : "",
    gender: gender,
    hope: hope,
    privilege: privilege,
    privilege2: privilege2,
    fieldServiceGroup: group,
    fullName: `${ln}, ${fn}`,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Publisher record updated successfully!");
  loadPublishers();
}

</script>
</body>
</html>
