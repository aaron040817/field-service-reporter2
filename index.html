<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Publisher App with Login</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial; padding: 30px; }
        .hidden { display: none; }
        input, button { margin: 10px 0; padding: 8px; width: 300px; }
        .box { border: 1px solid #ccc; padding: 20px; border-radius: 8px; width: 400px; }
        button { width: auto; display: inline-block; margin-right: 10px; }
        .danger { color: red; font-size: 12px; }
        .suggestions {
            max-height: 150px;
            overflow-y: auto;
            background: white;
            position: absolute;
            z-index: 100;
            width: 100%;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        input[disabled] {
            background-color: #f9f9f9;
            color: #333;
        }
    </style>
</head>
<body>

    <div id="loginPage" class="box">
        <h2>Login</h2>
        <label>Username:<br><input type="text" id="loginUsername"></label><br>
        <label>Password:<br><input type="password" id="loginPassword"></label><br>
        <button onclick="login()">Login</button>
    </div>

    <div id="homePage" class="box hidden">
        <h2>Welcome, <span id="loggedInUser"></span>!</h2>
        <button onclick="goToManagePublisher()">Manage Publisher Record</button>
        <button>Review Approvals</button>
        <button id="addReportBtn">Add Report</button>
        <button>Update Report</button>
        <button>Export to Excel</button>
        <button onclick="logout()">Logout</button>
        <button>Manage Users</button>
        <div style="margin-top: 30px;">
            <button onclick="clearAllData()">Clear All Data</button><br>
            <span class="danger">Warning: This will delete all publisher and report data.</span>
        </div>
    </div>

    <div id="publisherPage" class="box hidden" style="width: 600px;">
        <h2>Manage Publisher Record</h2>
        <label>Search Publisher:<br><input type="text" id="searchPublisher" autocomplete="off" placeholder="Type to search..." /><div id="suggestionBox" class="suggestions"></div></label><br>
        <label>First Name:<br><input id="firstName" type="text" /></label><br>
        <label>Last Name:<br><input id="lastName" type="text" /></label><br>
        <label>Full Name:<br><input id="fullName" disabled type="text"/></label><br>
        <label>Birthdate:<br><input id="birthdate" type="date" /></label><br>

        <label>Baptism Status:<br>
            <select id="baptismStatus" onchange="toggleBaptismDate()">
                <option>-- Select --</option>
                <option>Unbaptized Publisher</option>
                <option>Baptized</option>
                <option>Baptized but cannot remember the date</option>
            </select>
        </label><br>

        <div id="baptismDateContainer" class="hidden">
            <label>Baptism Date:<br><input id="baptismDate" type="date" /></label><br>
        </div>

        <label>Gender:<br>
            <select id="gender">
                <option>-- Select --</option>
                <option>Male</option>
                <option>Female</option>
            </select>
        </label><br>

        <label>Hope:<br>
            <select id="hope">
                <option>-- Select --</option>
                <option>Other Sheep</option>
                <option>Anointed</option>
            </select>
        </label><br>

        <label>Privilege:<br>
            <select id="privilege">
                <option>-- Select --</option>
                <option>Not Applicable</option>
                <option>Ministerial Servant</option>
                <option>Elder</option>
            </select>
        </label><br>

        <label>Privilege2:<br>
            <select id="privilege2">
                <option>-- Select --</option>
                <option>Regular Pioneer</option>
                <option>Special Pioneer</option>
                <option>Field Missionary</option>
                <option>Continuous Auxiliary Pioneer</option>
                <option>Publisher/Auxi</option>
            </select>
        </label><br>

        <label>Field Service Group:<br>
            <select id="fieldServiceGroup">
                <option>-- Select --</option>
                <option>Field Service Group 1</option>
                <option>Field Service Group 2</option>
                <option>Field Service Group 3</option>
                <option>Field Service Group 4</option>
                <option>Field Service Group 5</option>
                <option>Field Service Group 6</option>
                <option>Field Service Group 7</option>
                <option>Field Service Group 8</option>
            </select>
        </label><br><br>

        <button onclick="addPublisher()">Add</button>
        <button onclick="updatePublisher()">Update</button>
        <button onclick="deletePublisher()">Delete</button>
        <button onclick="previousPublisher()">‚Üê</button>
        <button onclick="nextPublisher()">‚Üí</button>
        <button onclick="clearPublisherForm()">Clear</button>
        <button onclick="backToHome()">Back to HomePage</button>
        <button onclick="logout()">Logout</button>
    </div>

    <div id="addReportPage" class="box hidden">
        <h2>Add Report</h2>

        <label>Search Publisher:<br>
            <input type="text" id="searchPublisherReport" placeholder="Search Publisher..." autocomplete="off">
            <div id="suggestionBoxReport" class="suggestions"></div>
        </label><br>

        <label>Publisher Name:<br>
            <select id="publisherNameDropdown">
                <option>-- Select --</option>
            </select>
        </label><br>

        <label>Field Service Group:<br>
            <input type="text" id="fieldGroup" disabled>
        </label><br>

        <label>Privilege2:<br>
            <input type="text" id="privilege2Report" disabled>
        </label><br>

        <label>Service Year:<br>
            <select id="serviceYearDropdown">
                <option>-- Select --</option>
            </select>
        </label><br>

        <label>Month and Year:<br>
            <select id="monthYearDropdown">
                <option>-- Select --</option>
            </select>
        </label><br>

        <label>Field Hours:<br>
            <input type="number" id="fieldHours">
        </label><br>

        <label>Bible Studies:<br>
            <input type="number" id="bibleStudies">
        </label><br>

        <label><input type="checkbox" id="sharedMinistry"> Shared in Ministry</label><br><br>

        <button id="saveReportBtn">Save Report</button>
        <button id="clearReportBtn">Clear</button>
        <button id="backHomeFromReportBtn">Back to HomePage</button>
        <button onclick="logout()">Logout</button>
    </div>

    <script>
        // Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDbKyWaYclW4jZ2eQ0qrK_PIfrh-7sahwY",
            authDomain: "field-service-reporter.firebaseapp.com",
            projectId: "field-service-reporter",
            storageBucket: "field-service-reporter.firebasestorage.app",
            messagingSenderId: "434729902657",
            appId: "1:434729902657:web:c1b06d2695a47924f89cc0",
            measurementId: "G-9N52K2CGDD"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let publisherList = []; // All publishers from Firebase
        let currentIndex = -1;  // Index of current displayed record
        let currentDocId = null;

        document.addEventListener("DOMContentLoaded", function () {
            // Setup for the initial page load
            document.getElementById("addReportBtn").addEventListener("click", goToAddReport);
            document.getElementById("backHomeFromReportBtn").addEventListener("click", backToHomeFromReport);
            document.getElementById("clearReportBtn").addEventListener("click", clearAddReportForm);
            
            // Setup for publisher form
            document.getElementById("firstName").addEventListener("input", updateFullName);
            document.getElementById("lastName").addEventListener("input", updateFullName);
        });

        // --- Core Functions ---
        
        // üîê Simple Login
        function login() {
            const user = document.getElementById("loginUsername").value;
            const pass = document.getElementById("loginPassword").value;

            if (user === "admin" && pass === "admin123") {
                document.getElementById("loginPage").classList.add("hidden");
                document.getElementById("homePage").classList.remove("hidden");
                document.getElementById("loggedInUser").textContent = user;
            } else {
                alert("Invalid credentials.");
            }
        }

        function logout() {
            document.getElementById("loginPage").classList.remove("hidden");
            document.getElementById("homePage").classList.add("hidden");
            document.getElementById("publisherPage").classList.add("hidden");
            document.getElementById("addReportPage").classList.add("hidden");

            document.getElementById("loginUsername").value = "";
            document.getElementById("loginPassword").value = "";

            clearPublisherForm();
            clearAddReportForm();

            currentIndex = -1;
            currentDocId = null;
            publisherList = [];
        }

        async function clearAllData() {
            if (confirm("Are you sure you want to delete all publisher data? This cannot be undone.")) {
                const snapshot = await db.collection("publishers").get();
                const batch = db.batch();

                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                alert("All publisher records deleted.");
                loadPublishers();
            }
        }

        // --- Publisher Management Functions ---
        
        function goToManagePublisher() {
            document.getElementById("homePage").classList.add("hidden");
            document.getElementById("publisherPage").classList.remove("hidden");
            clearPublisherForm();
            loadPublishers();
        }

        function backToHome() {
            document.getElementById("publisherPage").classList.add("hidden");
            document.getElementById("homePage").classList.remove("hidden");
        }

        async function loadPublishers() {
    const snapshot = await db.collection("publishers").orderBy("fullName", "asc").get();
    publisherList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Ensure 'id' is included

    if (publisherList.length > 0) {
        currentIndex = 0; // Start with the first record
        displayPublisher(currentIndex);
    } else {
        clearPublisherForm(); // Clear form if no records
        currentIndex = -1;
        currentDocId = null;
    }
}
        // --- Report Management Functions ---

        function goToAddReport() {
            document.getElementById("homePage").classList.add("hidden");
            document.getElementById("addReportPage").classList.remove("hidden");
            setupAddReportPage();
        }

        function backToHomeFromReport() {
            document.getElementById("addReportPage").classList.add("hidden");
            document.getElementById("homePage").classList.remove("hidden");
        }

        function setupAddReportPage() {
            const searchInput = document.getElementById("searchPublisherReport");
            const suggestionBox = document.getElementById("suggestionBoxReport");
            const publisherNameDropdown = document.getElementById("publisherNameDropdown");
            const fieldGroupInput = document.getElementById("fieldGroup");
            const privilege2Input = document.getElementById("privilege2Report");
            
            // Clear fields
            searchInput.value = "";
            publisherNameDropdown.innerHTML = '<option>-- Select --</option>';
            fieldGroupInput.value = "";
            privilege2Input.value = "";

            // Populate publisher dropdown with data from Firebase
            publisherList.forEach(pub => {
                const opt = document.createElement("option");
                opt.value = pub.id;
                opt.textContent = pub.fullName;
                publisherNameDropdown.appendChild(opt);
            });

            // Autocomplete search logic
            searchInput.addEventListener("input", function () {
                const query = searchInput.value.toLowerCase();
                suggestionBox.innerHTML = "";
                
                if (!query) return;

                const matches = publisherList.filter(pub =>
                    pub.fullName && pub.fullName.toLowerCase().includes(query)
                );

                matches.forEach(pub => {
                    const div = document.createElement("div");
                    div.textContent = pub.fullName;
                    div.classList.add("suggestion-item");
                    div.addEventListener("click", () => {
                        searchInput.value = pub.fullName;
                        suggestionBox.innerHTML = "";
                        fieldGroupInput.value = pub.fieldServiceGroup || "";
                        privilege2Input.value = pub.privilege2 || "";
                        selectPublisherOption(pub.id, publisherNameDropdown);
                    });
                    suggestionBox.appendChild(div);
                });
            });

            // Handle dropdown change
            publisherNameDropdown.addEventListener("change", function () {
                const selectedPublisher = publisherList.find(pub => pub.id === this.value);
                if (selectedPublisher) {
                    fieldGroupInput.value = selectedPublisher.fieldServiceGroup || "";
                    privilege2Input.value = selectedPublisher.privilege2 || "";
                } else {
                    fieldGroupInput.value = "";
                    privilege2Input.value = "";
                }
            });
        }
        
        function selectPublisherOption(publisherId, dropdown) {
            Array.from(dropdown.options).forEach(opt => {
                if (opt.value === publisherId) opt.selected = true;
            });
        }
        
        function clearAddReportForm() {
            document.getElementById("searchPublisherReport").value = "";
            document.getElementById("suggestionBoxReport").innerHTML = "";
            document.getElementById("publisherNameDropdown").selectedIndex = 0;
            document.getElementById("fieldGroup").value = "";
            document.getElementById("privilege2Report").value = "";
            document.getElementById("serviceYearDropdown").selectedIndex = 0;
            document.getElementById("monthYearDropdown").selectedIndex = 0;
            document.getElementById("fieldHours").value = "";
            document.getElementById("bibleStudies").value = "";
            document.getElementById("sharedMinistry").checked = false;
        }

        // --- Other Functions ---

        function updateFullName() {
            const fn = document.getElementById("firstName").value.trim();
            const ln = document.getElementById("lastName").value.trim();
            document.getElementById("fullName").value = ln && fn ? `${ln}, ${fn}` : "";
        }
        
        // Placeholder save function for report
        document.getElementById("saveReportBtn").addEventListener("click", () => {
            alert("Report saved!");
        });
        
        // Placeholder for missing functions (you can add your logic here)
        function toggleBaptismDate() { /* ... */ }
        async function addPublisher() {
    const fn = document.getElementById("firstName").value.trim();
    const ln = document.getElementById("lastName").value.trim();
    const bd = document.getElementById("birthdate").value;
    const bs = document.getElementById("baptismStatus").value;
    const bDate = document.getElementById("baptismDate").value;
    const gender = document.getElementById("gender").value;
    const hope = document.getElementById("hope").value;
    const privilege = document.getElementById("privilege").value;
    const privilege2 = document.getElementById("privilege2").value;
    const group = document.getElementById("fieldServiceGroup").value;

    // Validation: Check if all required fields are filled and select options are chosen
    if (!fn || !ln || !bd || bs === "-- Select --" || gender === "-- Select --" || hope === "-- Select --" || privilege === "-- Select --" || privilege2 === "-- Select --" || group === "-- Select --" ||
        (bs === "Baptized" && !bDate)) {
        alert("Please complete all fields before adding a publisher.");
        return;
    }

    const docId = `${ln}_${fn}_${bd}`.replace(/\s+/g, "_"); // Simplified docId for Firebase

    // Check if publisher already exists
    const existingDoc = await db.collection("publishers").doc(docId).get();
    if (existingDoc.exists) {
        alert("A publisher with the same last name, first name, and birthdate already exists.");
        return;
    }

    // Add to Firebase
    await db.collection("publishers").doc(docId).set({
        firstName: fn,
        lastName: ln,
        birthdate: bd,
        baptismStatus: bs,
        baptismDate: bs === "Baptized" ? bDate : "", // Save baptism date only if status is "Baptized"
        gender: gender,
        hope: hope,
        privilege: privilege,
        privilege2: privilege2,
        fieldServiceGroup: group,
        fullName: `${ln}, ${fn}`, // Stored for easier search/display
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // For ordering
    });

    alert("Publisher record successfully added!");
    await loadPublishers(); // Reload to update list for navigation
    clearPublisherForm();
}
        async function updatePublisher() {
    if (!currentDocId) {
        alert("Please select a publisher record to update first.");
        return;
    }

    const fn = document.getElementById("firstName").value.trim();
    const ln = document.getElementById("lastName").value.trim();
    const bd = document.getElementById("birthdate").value;
    const bs = document.getElementById("baptismStatus").value;
    const bdate = document.getElementById("baptismDate").value;
    const gender = document.getElementById("gender").value;
    const hope = document.getElementById("hope").value;
    const priv = document.getElementById("privilege").value;
    const priv2 = document.getElementById("privilege2").value;
    const group = document.getElementById("fieldServiceGroup").value;

    // Validation: Check if all required fields are filled and select options are chosen
    if (!fn || !ln || !bd || bs === "-- Select --" || gender === "-- Select --" || hope === "-- Select --" || priv === "-- Select --" || priv2 === "-- Select --" || group === "-- Select --" ||
        (bs === "Baptized" && !bdate)) {
        alert("Please complete all fields before updating.");
        return;
    }

    const updatedData = {
        firstName: fn,
        lastName: ln,
        birthdate: bd,
        baptismStatus: bs,
        baptismDate: bs === "Baptized" ? bdate : "",
        gender: gender,
        hope: hope,
        privilege: priv,
        privilege2: priv2,
        fieldServiceGroup: group,
        fullName: `${ln}, ${fn}`, // Update full name in case of name change
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // Update timestamp if needed
    };

    try {
        await db.collection("publishers").doc(currentDocId).update(updatedData);
        alert("Publisher record updated successfully!");
        clearPublisherForm();
        await loadPublishers(); // Reload to update list for navigation
    } catch (error) {
        console.error("Error updating publisher:", error);
        alert("Failed to update publisher record. Please try again.");
    }
}
        async function deletePublisher() {
    if (!currentDocId) {
        alert("Please select a publisher record to delete first.");
        return;
    }

    const confirmed = confirm("Are you sure you want to delete this publisher record? This action cannot be undone.");
    if (!confirmed) {
        return;
    }

    try {
        await db.collection("publishers").doc(currentDocId).delete();
        alert("Publisher record deleted successfully!");
        clearPublisherForm();
        await loadPublishers(); // Reload to update list and display next/previous record if available
    } catch (error) {
        console.error("Error deleting publisher:", error);
        alert("Failed to delete publisher record. Please try again.");
    }
}
        function previousPublisher() {
    if (publisherList.length === 0) {
        alert("No records to display.");
        return;
    }
    if (currentIndex > 0) {
        currentIndex--;
        displayPublisher(currentIndex);
    } else {
        alert("This is the first record.");
    }
}

function nextPublisher() {
    if (publisherList.length === 0) {
        alert("No records to display.");
        return;
    }
    if (currentIndex < publisherList.length - 1) {
        currentIndex++;
        displayPublisher(currentIndex);
    } else {
        alert("This is the last record.");
    }
}
        function clearPublisherForm() {
    document.getElementById("firstName").value = "";
    document.getElementById("lastName").value = "";
    document.getElementById("birthdate").value = "";
    document.getElementById("baptismStatus").value = "-- Select --"; // Reset select to default
    document.getElementById("baptismDate").value = "";
    document.getElementById("baptismDateContainer").classList.add("hidden"); // Hide date field
    document.getElementById("gender").value = "-- Select --"; // Reset select to default
    document.getElementById("hope").value = "-- Select --"; // Reset select to default
    document.getElementById("privilege").value = "-- Select --"; // Reset select to default
    document.getElementById("privilege2").value = "-- Select --"; // Reset select to default
    document.getElementById("fieldServiceGroup").value = "-- Select --"; // Reset select to default
    document.getElementById("fullName").value = "";
    document.getElementById("searchPublisher").value = "";
    document.getElementById("suggestionBox").innerHTML = ""; // Clear suggestions

    // Reset current selected record
    currentIndex = -1;
    currentDocId = null;
}
        function displayPublisher(index) {
    const pub = publisherList[index];
    if (!pub) {
        clearPublisherForm(); // Clear the form if no publisher is found at this index
        currentDocId = null;
        return;
    }

    document.getElementById("firstName").value = pub.firstName || "";
    document.getElementById("lastName").value = pub.lastName || "";
    document.getElementById("birthdate").value = pub.birthdate || "";
    document.getElementById("baptismStatus").value = pub.baptismStatus || "";

    // Toggle baptism date container
    const baptismDateContainer = document.getElementById("baptismDateContainer");
    const baptismDateInput = document.getElementById("baptismDate");
    if (pub.baptismStatus === "Baptized") {
        baptismDateContainer.classList.remove("hidden");
        baptismDateInput.value = pub.baptismDate || "";
    } else {
        baptismDateContainer.classList.add("hidden");
        baptismDateInput.value = ""; // Clear if not baptized
    }

    document.getElementById("gender").value = pub.gender || "";
    document.getElementById("hope").value = pub.hope || "";
    document.getElementById("privilege").value = pub.privilege || "";
    document.getElementById("privilege2").value = pub.privilege2 || "";
    document.getElementById("fieldServiceGroup").value = pub.fieldServiceGroup || "";

    // Update Full Name field based on current data
    document.getElementById("fullName").value = `${pub.lastName || ''}, ${pub.firstName || ''}`;

    // ‚úÖ Crucial: Update currentDocId
    currentDocId = pub.id; // Use the actual document ID from Firebase
}
    </script>
</body>
</html>
