<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher App</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f4f4f4; margin: 0; padding: 20px; box-sizing: border-box; }
        .page-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        input, select { display: block; width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background-color: #0056b3; }
        .logout-btn, .delete-btn { background-color: #dc3545; }
        .logout-btn:hover, .delete-btn:hover { background-color: #c82333; }
        .clear-btn { background-color: #ffc107; color: #333; }
        .clear-btn:hover { background-color: #e0a800; }
        .back-btn { background-color: #6c757d; }
        .back-btn:hover { background-color: #5a6268; }
        
        /* HIDDEN CLASS: This is crucial for hiding/showing pages */
        .hidden { display: none !important; }

        .suggestion-box { border: 1px solid #ddd; max-height: 150px; overflow-y: auto; background-color: white; position: absolute; width: calc(100% - 42px); z-index: 100; }
        .suggestion-item { padding: 8px; cursor: pointer; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        input[type="checkbox"] { width: auto; margin-right: 5px;}
        .checkbox-container { display: flex; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="loginPage" class="page-container">
        <h2>Login</h2>
        <input type="text" id="loginUsername" placeholder="Username">
        <input type="password" id="loginPassword" placeholder="Password">
        <button id="loginBtn">Login</button>
    </div>

    <div id="homePage" class="page-container hidden">
        <h2>Welcome, <span id="loggedInUser"></span>!</h2>
        <button id="addReportBtn">Add Report</button>
        <button id="managePublisherBtn">Manage Publisher</button>
        <button id="clearAllDataBtn">Clear All Data</button>
        <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>

    <div id="addReportPage" class="page-container hidden">
        <h2>Add Field Service Report</h2>
        <label for="publisherNameDropdown">Publisher Name:</label>
        <select id="publisherNameDropdown"></select>
        <input type="text" id="searchPublisherReport" placeholder="Search Publisher...">
        <div id="suggestionBoxReport" class="suggestion-box"></div>
        
        <label for="fieldGroup">Field Service Group:</label>
        <input type="text" id="fieldGroup" disabled>
        
        <label for="privilege2Report">Privilege 2:</label>
        <input type="text" id="privilege2Report" disabled>

        <label for="serviceYearDropdown">Service Year:</label>
        <select id="serviceYearDropdown"></select>

        <label for="monthYearDropdown">Month:</label>
        <select id="monthYearDropdown"></select>

        <div id="auxPioneerQuestionContainer" class="hidden">
            <label for="isAuxiliaryPioneerThisMonth">Is Auxiliary Pioneer this Month?</label>
            <select id="isAuxiliaryPioneerThisMonth">
                <option value="">-- Select --</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
            </select>
        </div>

        <div id="fieldHoursContainer" class="hidden">
            <label for="fieldHours">Field Hours:</label>
            <input type="number" id="fieldHours">
        </div>

        <div id="bibleStudiesContainer" class="hidden">
            <label for="bibleStudies">Bible Studies:</label>
            <input type="number" id="bibleStudies">
        </div>

        <div id="sharedMinistryContainer" class="hidden">
            <div class="checkbox-container">
                <input type="checkbox" id="sharedMinistry">
                <label for="sharedMinistry">Shared in Ministry</label>
            </div>
        </div>

        <div id="auxiliaryPioneerCheckboxContainer" class="hidden">
            <div class="checkbox-container">
                <input type="checkbox" id="auxiliaryPioneerCheckbox">
                <label for="auxiliaryPioneerCheckbox">Auxiliary Pioneer</label>
            </div>
        </div>

        <button id="saveReportBtn">Save Report</button>
        <button id="clearReportBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromReportBtn" class="back-btn">Back to Home</button>
    </div>

    <div id="publisherPage" class="page-container hidden">
        <h2>Manage Publisher Records</h2>
        <label for="firstName">First Name:</label>
        <input type="text" id="firstName">
        
        <label for="lastName">Last Name:</label>
        <input type="text" id="lastName">
        
        <label for="fullName">Full Name:</label>
        <input type="text" id="fullName" disabled>
        
        <label for="birthdate">Birthdate:</label>
        <input type="date" id="birthdate">
        
        <label for="baptismStatus">Baptism Status:</label>
        <select id="baptismStatus">
            <option value="">-- Select --</option>
            <option value="Baptized">Baptized</option>
            <option value="Unbaptized">Unbaptized</option>
        </select>
        
        <div id="baptismDateContainer" class="hidden">
            <label for="baptismDate">Baptism Date:</label>
            <input type="date" id="baptismDate">
        </div>
        
        <label for="gender">Gender:</label>
        <select id="gender">
            <option value="">-- Select --</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
        
        <label for="hope">Hope:</label>
        <select id="hope">
            <option value="">-- Select --</option>
            <option value="Heavenly">Heavenly</option>
            <option value="Earthly">Earthly</option>
        </select>
        
        <label for="privilege">Privilege:</label>
        <select id="privilege">
            <option value="">-- Select --</option>
            <option value="Publisher">Publisher</option>
            <option value="Ministerial Servant">Ministerial Servant</option>
            <option value="Elder">Elder</option>
        </select>
        
        <label for="privilege2">Privilege 2:</label>
        <select id="privilege2">
            <option value="">-- Select --</option>
            <option value="Regular Pioneer">Regular Pioneer</option>
            <option value="Special Pioneer">Special Pioneer</option>
            <option value="Field Missionary">Field Missionary</option>
            <option value="Continuous Auxiliary Pioneer">Continuous Auxiliary Pioneer</option>
            <option value="Publisher/Auxi">Publisher/Auxi</option>
        </select>
        
        <label for="fieldServiceGroup">Field Service Group:</label>
        <select id="fieldServiceGroup">
            <option value="">-- Select --</option>
            <option value="Group 1">Group 1</option>
            <option value="Group 2">Group 2</option>
            <option value="Group 3">Group 3</option>
        </select>

        <button id="addPublisherBtn">Add</button>
        <button id="updatePublisherBtn">Update</button>
        <button id="deletePublisherBtn" class="delete-btn">Delete</button>
        <button id="previousPublisherBtn">Previous</button>
        <button id="nextPublisherBtn">Next</button>
        
        <input type="text" id="searchPublisher" placeholder="Search Publisher...">
        <div id="suggestionBox" class="suggestion-box"></div>
        
        <button id="clearPublisherFormBtn" class="clear-btn">Clear Form</button>
        <button id="backHomeFromPublisherBtn" class="back-btn">Back to Home</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="script.js"></script>
<script>
// script.js

// --- Firebase Config and Initialization (GLOBAL) ---
const firebaseConfig = {
    apiKey: "AIzaSyDbKyWaYclW4jZ2eQ0qrK_PIfrh-7sahwY",
    authDomain: "field-service-reporter.firebaseapp.com",
    projectId: "field-service-reporter",
    storageBucket: "field-service-reporter.firebasestorage.app",
    messagingSenderId: "434729902657",
    appId: "1:434729902657:web:c1b06d2695a47924f89cc0",
    measurementId: "G-9N52K2CGDD"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();

// --- Global App State Variables ---
let publisherList = [];
let currentIndex = -1;
let currentDocId = null;
let loggedInUser = null;

// --- References to Page Containers (GLOBAL) ---
let loginPage, homePage, addReportPage, publisherPage;

// --- References for Add Report page elements (GLOBAL) ---
let serviceYearDropdown, monthYearDropdown, auxPioneerQuestionContainer, isAuxiliaryPioneerThisMonth;
let fieldHoursContainer, fieldHoursInput, bibleStudiesContainer, bibleStudiesInput;
let sharedMinistryContainer, sharedMinistryCheckbox, auxiliaryPioneerCheckboxContainer, auxiliaryPioneerCheckbox;
let privilege2ReportInput;
let searchPublisherReportInput, suggestionBoxReport, publisherNameDropdown, fieldGroupInput;

// --- References for Manage Publisher page elements (GLOBAL) ---
let firstNameInput, lastNameInput, fullNameInput, birthdateInput, baptismStatusDropdown;
let baptismDateContainer, baptismDateInput, genderDropdown, hopeDropdown, privilegeDropdown;
let privilege2Dropdown, fieldServiceGroupDropdown;
let addPublisherBtn, updatePublisherBtn, deletePublisherBtn, previousPublisherBtn, nextPublisherBtn;
let clearPublisherFormBtn, backHomeFromPublisherBtn;
let searchInputManage, suggestionBoxManage;


// --- ROUTING FUNCTIONS ---
function showPage(pageId, path) {
    // Hide all pages
    const allPages = document.querySelectorAll('.page-container');
    allPages.forEach(page => page.classList.add('hidden'));

    // Show the desired page
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.remove('hidden');
    }

    // Update URL without reloading
    if (path && window.location.pathname !== path) {
        history.pushState({ page: pageId }, '', path);
    }
    
    // Perform page-specific setup
    if (pageId === 'homePage') {
        updateHomePage();
    } else if (pageId === 'addReportPage') {
        setupAddReportPage();
    } else if (pageId === 'publisherPage') {
        setupManagePublisherPage();
    }
}

function handleRouteChange() {
    const path = window.location.pathname;
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

    if (!isLoggedIn && path !== '/') {
        // If not logged in and trying to access other pages, redirect to login
        showPage('loginPage', '/');
        return;
    }

    switch (path) {
        case '/':
            if (isLoggedIn) {
                showPage('homePage', '/home'); // Redirect to home if already logged in
            } else {
                showPage('loginPage', '/');
            }
            break;
        case '/home':
            showPage('homePage', '/home');
            break;
        case '/add-report':
            showPage('addReportPage', '/add-report');
            break;
        case '/manage-publisher':
            showPage('publisherPage', '/manage-publisher');
            break;
        default:
            // Handle 404 or redirect to home/login
            showPage(isLoggedIn ? 'homePage' : 'loginPage', isLoggedIn ? '/home' : '/');
            break;
    }
}

// Listen for browser back/forward buttons
window.addEventListener('popstate', handleRouteChange);


// --- CORE APPLICATION LOGIC (Combined) ---

document.addEventListener("DOMContentLoaded", function () {
    // Initialize page container references
    loginPage = document.getElementById('loginPage');
    homePage = document.getElementById('homePage');
    addReportPage = document.getElementById('addReportPage');
    publisherPage = document.getElementById('publisherPage');

    // Initialize Add Report page element references
    serviceYearDropdown = document.getElementById("serviceYearDropdown");
    monthYearDropdown = document.getElementById("monthYearDropdown");
    auxPioneerQuestionContainer = document.getElementById("auxPioneerQuestionContainer");
    isAuxiliaryPioneerThisMonth = document.getElementById("isAuxiliaryPioneerThisMonth");
    fieldHoursContainer = document.getElementById("fieldHoursContainer");
    fieldHoursInput = document.getElementById("fieldHours");
    bibleStudiesContainer = document.getElementById("bibleStudiesContainer");
    bibleStudiesInput = document.getElementById("bibleStudies");
    sharedMinistryContainer = document.getElementById("sharedMinistryContainer");
    sharedMinistryCheckbox = document.getElementById("sharedMinistry");
    auxiliaryPioneerCheckboxContainer = document.getElementById("auxiliaryPioneerCheckboxContainer");
    auxiliaryPioneerCheckbox = document.getElementById("auxiliaryPioneerCheckbox");
    privilege2ReportInput = document.getElementById("privilege2Report");
    searchPublisherReportInput = document.getElementById("searchPublisherReport");
    suggestionBoxReport = document.getElementById("suggestionBoxReport");
    publisherNameDropdown = document.getElementById("publisherNameDropdown");
    fieldGroupInput = document.getElementById("fieldGroup");

    // Initialize Manage Publisher page element references
    firstNameInput = document.getElementById("firstName");
    lastNameInput = document.getElementById("lastName");
    fullNameInput = document.getElementById("fullName");
    birthdateInput = document.getElementById("birthdate");
    baptismStatusDropdown = document.getElementById("baptismStatus");
    baptismDateContainer = document.getElementById("baptismDateContainer");
    baptismDateInput = document.getElementById("baptismDate");
    genderDropdown = document.getElementById("gender");
    hopeDropdown = document.getElementById("hope");
    privilegeDropdown = document.getElementById("privilege");
    privilege2Dropdown = document.getElementById("privilege2");
    fieldServiceGroupDropdown = document.getElementById("fieldServiceGroup");
    addPublisherBtn = document.getElementById("addPublisherBtn");
    updatePublisherBtn = document.getElementById("updatePublisherBtn");
    deletePublisherBtn = document.getElementById("deletePublisherBtn");
    previousPublisherBtn = document.getElementById("previousPublisherBtn");
    nextPublisherBtn = document.getElementById("nextPublisherBtn");
    clearPublisherFormBtn = document.getElementById("clearPublisherFormBtn");
    backHomeFromPublisherBtn = document.getElementById("backHomeFromPublisherBtn");
    searchInputManage = document.getElementById("searchPublisher");
    suggestionBoxManage = document.getElementById("suggestionBox");


    // --- Global Event Listeners ---

    // Login Page
    const loginBtn = document.getElementById("loginBtn");
    if (loginBtn) {
        loginBtn.addEventListener("click", login);
    }

    // Home Page Buttons
    const addReportBtn = document.getElementById("addReportBtn");
    if (addReportBtn) addReportBtn.addEventListener("click", () => showPage('addReportPage', '/add-report'));

    const managePublisherBtn = document.getElementById("managePublisherBtn");
    if (managePublisherBtn) managePublisherBtn.addEventListener("click", () => showPage('publisherPage', '/manage-publisher'));

    const clearAllDataBtn = document.getElementById("clearAllDataBtn");
    if (clearAllDataBtn) clearAllDataBtn.addEventListener("click", clearAllData);

    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) logoutBtn.addEventListener("click", logout);

    // Add Report Page Buttons
    const saveReportBtn = document.getElementById("saveReportBtn");
    if (saveReportBtn) saveReportBtn.addEventListener("click", () => {
        alert("Report saved! (Implement save logic here)");
        clearAddReportForm();
    });
    const clearReportBtn = document.getElementById("clearReportBtn");
    if (clearReportBtn) clearReportBtn.addEventListener("click", clearAddReportForm);
    const backHomeFromReportBtn = document.getElementById("backHomeFromReportBtn");
    if (backHomeFromReportBtn) backHomeFromReportBtn.addEventListener("click", () => showPage('homePage', '/home'));

    // Manage Publisher Page Buttons
    if (addPublisherBtn) addPublisherBtn.addEventListener("click", addPublisher);
    if (updatePublisherBtn) updatePublisherBtn.addEventListener("click", updatePublisher);
    if (deletePublisherBtn) deletePublisherBtn.addEventListener("click", deletePublisher);
    if (previousPublisherBtn) previousPublisherBtn.addEventListener("click", previousPublisher);
    if (nextPublisherBtn) nextPublisherBtn.addEventListener("click", nextPublisher);
    if (clearPublisherFormBtn) clearPublisherFormBtn.addEventListener("click", clearPublisherForm);
    if (backHomeFromPublisherBtn) backHomeFromPublisherBtn.addEventListener("click", () => showPage('homePage', '/home'));


    // Initial route handling
    handleRouteChange();
});


// --- Functions ---

// ðŸ” Login/Logout
function login() {
    const user = document.getElementById("loginUsername").value;
    const pass = document.getElementById("loginPassword").value;

    if (user === "admin" && pass === "admin123") {
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('loggedInUser', user);
        loggedInUser = user; // Update global variable
        showPage('homePage', '/home');
    } else {
        alert("Invalid credentials.");
    }
}

function logout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('loggedInUser');
    localStorage.removeItem('selectedPublisherId');
    loggedInUser = null; // Clear global variable
    showPage('loginPage', '/');
    clearPublisherForm(); // Clear forms on logout
    clearAddReportForm();
}

async function clearAllData() {
    if (confirm("Are you sure you want to delete all publisher data? This cannot be undone.")) {
        try {
            const snapshot = await db.collection("publishers").get();
            const batch = db.batch();

            snapshot.forEach(doc => {
                batch.delete(doc.ref);
            });

            await batch.commit();
            alert("All publisher records deleted.");
            publisherList = []; // Clear local list
            currentIndex = -1;
            currentDocId = null;
        } catch (error) {
            console.error("Error clearing all data:", error);
            alert("Failed to clear all data. Please try again.");
        }
    }
}

// --- Page Specific Setups / Updates ---

function updateHomePage() {
    loggedInUser = localStorage.getItem('loggedInUser'); // Refresh value
    if (document.getElementById("loggedInUser")) {
        document.getElementById("loggedInUser").textContent = loggedInUser || 'Guest';
    }
    // Any other home page specific logic
}

function setupAddReportPage() {
    clearAddReportForm(); // Clear form on entry
    loadPublishers().then(() => { // Load publishers for dropdown and search
        // Add listeners after publishers are loaded
        if (publisherNameDropdown) {
            publisherNameDropdown.addEventListener("change", function () {
                autofillPublisherDetails(this.value);
            });
        }
        if (searchPublisherReportInput && suggestionBoxReport) {
            searchPublisherReportInput.addEventListener("input", function () {
                const query = searchPublisherReportInput.value.toLowerCase();
                suggestionBoxReport.innerHTML = "";
                if (!query) return;
                const matches = publisherList.filter(pub => pub.fullName && pub.fullName.toLowerCase().includes(query));
                matches.forEach(pub => {
                    const div = document.createElement("div");
                    div.textContent = pub.fullName;
                    div.classList.add("suggestion-item");
                    div.addEventListener("click", () => {
                        searchPublisherReportInput.value = pub.fullName;
                        suggestionBoxReport.innerHTML = "";
                        selectPublisherOption(pub.id, publisherNameDropdown);
                        autofillPublisherDetails(pub.id);
                    });
                    suggestionBoxReport.appendChild(div);
                });
            });
        }
    });

    populateServiceYears();
    if (serviceYearDropdown) serviceYearDropdown.addEventListener("change", populateMonths);
    if (isAuxiliaryPioneerThisMonth) isAuxiliaryPioneerThisMonth.addEventListener("change", updateReportFieldsVisibility);
    updateReportFieldsVisibility(); // Initial visibility update
}

function setupManagePublisherPage() {
    clearPublisherForm(); // Clear form on entry
    loadPublishers().then(() => { // Load publishers for navigation and search
        // Add listeners here
        if (firstNameInput && lastNameInput) {
            firstNameInput.addEventListener("input", updateFullName);
            lastNameInput.addEventListener("input", updateFullName);
        }
        if (baptismStatusDropdown) {
            baptismStatusDropdown.addEventListener("change", toggleBaptismDate);
        }

        if (searchInputManage && suggestionBoxManage) {
            searchInputManage.addEventListener("input", function () {
                const query = searchInputManage.value.toLowerCase();
                suggestionBoxManage.innerHTML = "";
                if (!query) return;
                const matches = publisherList.filter(pub => pub.fullName && pub.fullName.toLowerCase().includes(query));
                matches.forEach((pub) => {
                    const div = document.createElement("div");
                    div.textContent = pub.fullName;
                    div.classList.add("suggestion-item");
                    div.addEventListener("click", () => {
                        searchInputManage.value = pub.fullName;
                        suggestionBoxManage.innerHTML = "";
                        const originalIndex = publisherList.findIndex(p => p.id === pub.id);
                        if (originalIndex !== -1) {
                            currentIndex = originalIndex;
                            displayPublisher(currentIndex);
                        }
                    });
                    suggestionBoxManage.appendChild(div);
                });
            });
        }
    });
}


// --- Publisher Management Functions ---

async function loadPublishers() {
    try {
        const snapshot = await db.collection("publishers").orderBy("fullName", "asc").get();
        publisherList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (publisherList.length > 0) {
            currentIndex = 0; // Set to first item
            // Only display if on the manage publisher page to avoid errors
            if (document.getElementById('publisherPage') && !document.getElementById('publisherPage').classList.contains('hidden')) {
                displayPublisher(currentIndex);
            }
        } else {
            clearPublisherForm();
        }
        populatePublisherDropdown(); // For add_report page
    } catch (error) {
        console.error("Error loading publishers:", error);
    }
}

function updateFullName() {
    const firstNameValue = firstNameInput.value.trim();
    const lastNameValue = lastNameInput.value.trim();
    fullNameInput.value = lastNameValue && firstNameValue ? `${lastNameValue}, ${firstNameValue}` : "";
}

function toggleBaptismDate() {
    const status = baptismStatusDropdown.value;
    if (status === "Baptized") {
        baptismDateContainer.classList.remove("hidden");
        baptismDateInput.value = "";
    } else {
        baptismDateContainer.classList.add("hidden");
        baptismDateInput.value = "";
    }
}

async function addPublisher() {
    if (!firstNameInput || !lastNameInput || !birthdateInput || !baptismStatusDropdown || !baptismDateInput || !genderDropdown || !hopeDropdown || !privilegeDropdown || !privilege2Dropdown || !fieldServiceGroupDropdown ||
        !firstNameInput.value.trim() || !lastNameInput.value.trim() || !birthdateInput.value || baptismStatusDropdown.value === "-- Select --" || genderDropdown.value === "-- Select --" || hopeDropdown.value === "-- Select --" || privilegeDropdown.value === "-- Select --" || privilege2Dropdown.value === "-- Select --" || fieldServiceGroupDropdown.value === "-- Select --" ||
        (baptismStatusDropdown.value === "Baptized" && !baptismDateInput.value)) {
        alert("Please complete all fields before adding a publisher.");
        return;
    }

    const docId = `${lastNameInput.value.trim()}_${firstNameInput.value.trim()}_${birthdateInput.value}`.replace(/\s+/g, "_");

    try {
        const existingDoc = await db.collection("publishers").doc(docId).get();
        if (existingDoc.exists) {
            alert("A publisher with the same last name, first name, and birthdate already exists.");
            return;
        }

        await db.collection("publishers").doc(docId).set({
            firstName: firstNameInput.value.trim(),
            lastName: lastNameInput.value.trim(),
            birthdate: birthdateInput.value,
            baptismStatus: baptismStatusDropdown.value,
            baptismDate: baptismStatusDropdown.value === "Baptized" ? baptismDateInput.value : "",
            gender: genderDropdown.value,
            hope: hopeDropdown.value,
            privilege: privilegeDropdown.value,
            privilege2: privilege2Dropdown.value,
            fieldServiceGroup: fieldServiceGroupDropdown.value,
            fullName: `${lastNameInput.value.trim()}, ${firstNameInput.value.trim()}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Publisher record successfully added!");
        clearPublisherForm();
        await loadPublishers();
    } catch (error) {
        console.error("Error adding publisher:", error);
        alert("Failed to add publisher record. Please try again.");
    }
}

async function updatePublisher() {
    if (!currentDocId) {
        alert("Please select a publisher record to update first.");
        return;
    }

    if (!firstNameInput || !lastNameInput || !birthdateInput || !baptismStatusDropdown || !baptismDateInput || !genderDropdown || !hopeDropdown || !privilegeDropdown || !privilege2Dropdown || !fieldServiceGroupDropdown ||
        !firstNameInput.value.trim() || !lastNameInput.value.trim() || !birthdateInput.value || baptismStatusDropdown.value === "-- Select --" || genderDropdown.value === "-- Select --" || hopeDropdown.value === "-- Select --" || privilegeDropdown.value === "-- Select --" || privilege2Dropdown.value === "-- Select --" || fieldServiceGroupDropdown.value === "-- Select --" ||
        (baptismStatusDropdown.value === "Baptized" && !baptismDateInput.value)) {
        alert("Please complete all fields before updating.");
        return;
    }

    const updatedData = {
        firstName: firstNameInput.value.trim(),
        lastName: lastNameInput.value.trim(),
        birthdate: birthdateInput.value,
        baptismStatus: baptismStatusDropdown.value,
        baptismDate: baptismStatusDropdown.value === "Baptized" ? baptismDateInput.value : "",
        gender: genderDropdown.value,
        hope: hopeDropdown.value,
        privilege: privilegeDropdown.value,
        privilege2: privilege2Dropdown.value,
        fieldServiceGroup: fieldServiceGroupDropdown.value,
        fullName: `${lastNameInput.value.trim()}, ${firstNameInput.value.trim()}`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection("publishers").doc(currentDocId).update(updatedData);
        alert("Publisher record updated successfully!");
        clearPublisherForm();
        await loadPublishers();
    } catch (error) {
        console.error("Error updating publisher:", error);
        alert("Failed to update publisher record. Please try again.");
    }
}

async function deletePublisher() {
    if (!currentDocId) {
        alert("Please select a publisher record to delete first.");
        return;
    }

    const confirmed = confirm("Are you sure you want to delete this publisher record? This action cannot be undone.");
    if (!confirmed) {
        return;
    }

    try {
        await db.collection("publishers").doc(currentDocId).delete();
        alert("Publisher record deleted successfully!");
        clearPublisherForm();
        await loadPublishers();
    } catch (error) {
        console.error("Error deleting publisher:", error);
        alert("Failed to delete publisher record. Please try again.");
    }
}

function previousPublisher() {
    if (publisherList.length === 0) {
        alert("No records to display.");
        return;
    }
    if (currentIndex > 0) {
        currentIndex--;
        displayPublisher(currentIndex);
    } else {
        alert("This is the first record.");
    }
}

function nextPublisher() {
    if (publisherList.length === 0) {
        alert("No records to display.");
        return;
    }
    if (currentIndex < publisherList.length - 1) {
        currentIndex++;
        displayPublisher(currentIndex);
    } else {
        alert("This is the last record.");
    }
}

function clearPublisherForm() {
    // Clear all input/select fields for publisher form
    if (firstNameInput) firstNameInput.value = "";
    if (lastNameInput) lastNameInput.value = "";
    if (fullNameInput) fullNameInput.value = "";
    if (birthdateInput) birthdateInput.value = "";
    if (baptismStatusDropdown) baptismStatusDropdown.value = "-- Select --";
    if (baptismDateInput) baptismDateInput.value = "";
    if (baptismDateContainer) baptismDateContainer.classList.add("hidden");
    if (genderDropdown) genderDropdown.value = "-- Select --";
    if (hopeDropdown) hopeDropdown.value = "-- Select --";
    if (privilegeDropdown) privilegeDropdown.value = "-- Select --";
    if (privilege2Dropdown) privilege2Dropdown.value = "-- Select --";
    if (fieldServiceGroupDropdown) fieldServiceGroupDropdown.value = "-- Select --";
    if (searchInputManage) searchInputManage.value = "";
    if (suggestionBoxManage) suggestionBoxManage.innerHTML = "";

    currentIndex = -1;
    currentDocId = null;
}

function displayPublisher(index) {
    const pub = publisherList[index];
    if (!pub) {
        clearPublisherForm();
        currentDocId = null;
        return;
    }

    if (firstNameInput) firstNameInput.value = pub.firstName || "";
    if (lastNameInput) lastNameInput.value = pub.lastName || "";
    if (birthdateInput) birthdateInput.value = pub.birthdate || "";
    if (baptismStatusDropdown) baptismStatusDropdown.value = pub.baptismStatus || "";

    if (baptismDateContainer && baptismDateInput) {
        if (pub.baptismStatus === "Baptized") {
            baptismDateContainer.classList.remove("hidden");
            baptismDateInput.value = pub.baptismDate || "";
        } else {
            baptismDateContainer.classList.add("hidden");
            baptismDateInput.value = "";
        }
    }

    if (genderDropdown) genderDropdown.value = pub.gender || "";
    if (hopeDropdown) hopeDropdown.value = pub.hope || "";
    if (privilegeDropdown) privilegeDropdown.value = pub.privilege || "";
    if (privilege2Dropdown) privilege2Dropdown.value = pub.privilege2 || "";
    if (fieldServiceGroupDropdown) fieldServiceGroupDropdown.value = pub.fieldServiceGroup || "";
    if (fullNameInput) fullNameInput.value = `${pub.lastName || ''}, ${pub.firstName || ''}`;

    currentDocId = pub.id;
}


// --- Report Management Functions ---

function populatePublisherDropdown() {
    if (!publisherNameDropdown) return;

    publisherNameDropdown.innerHTML = '<option value="">-- Select Publisher --</option>';
    if (publisherList && publisherList.length > 0) {
        publisherList.forEach(pub => {
            const opt = document.createElement("option");
            opt.value = pub.id;
            opt.textContent = pub.fullName;
            publisherNameDropdown.appendChild(opt);
        });
    }
}

function selectPublisherOption(publisherId, dropdown) {
    if (!dropdown) return;
    Array.from(dropdown.options).forEach(opt => {
        if (opt.value === publisherId) {
            opt.selected = true;
        } else {
            opt.selected = false;
        }
    });
}

function autofillPublisherDetails(publisherId) {
    const selectedPublisher = publisherList.find(pub => pub.id === publisherId);

    if (selectedPublisher) {
        if (fieldGroupInput) fieldGroupInput.value = selectedPublisher.fieldServiceGroup || "";
        if (privilege2ReportInput) privilege2ReportInput.value = selectedPublisher.privilege2 || "";
    } else {
        if (fieldGroupInput) fieldGroupInput.value = "";
        if (privilege2ReportInput) privilege2ReportInput.value = "";
    }
    updateReportFieldsVisibility();
}

function populateServiceYears() {
    if (!serviceYearDropdown) return;
    serviceYearDropdown.innerHTML = '<option value="">-- Select Year --</option>';
    const startYear = 2015;
    const currentYear = new Date().getFullYear();
    const endYear = currentYear + 5;

    for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        serviceYearDropdown.appendChild(option);
    }
}

function populateMonths() {
    if (!monthYearDropdown || !serviceYearDropdown) return;
    monthYearDropdown.innerHTML = '<option value="">-- Select Month --</option>';
    const selectedServiceYear = parseInt(serviceYearDropdown.value);

    if (isNaN(selectedServiceYear)) {
        return;
    }

    const startMonthYear = new Date(selectedServiceYear - 1, 8, 1); // September (month 8 is Sep)
    const endMonthYear = new Date(selectedServiceYear, 7, 1);      // August (month 7 is Aug)

    let currentMonth = new Date(startMonthYear);
    while (currentMonth <= endMonthYear) {
        const option = document.createElement("option");
        const monthName = currentMonth.toLocaleString('en-US', { month: 'long' });
        const year = currentMonth.getFullYear();
        option.value = `${monthName} ${year}`;
        option.textContent = `${monthName} ${year}`;
        monthYearDropdown.appendChild(option);

        currentMonth.setMonth(currentMonth.getMonth() + 1);
    }
}

function updateReportFieldsVisibility() {
    // Safety checks for all global elements used here
    if (!privilege2ReportInput || !isAuxiliaryPioneerThisMonth || !auxPioneerQuestionContainer ||
        !fieldHoursContainer || !bibleStudiesContainer || !sharedMinistryContainer ||
        !auxiliaryPioneerCheckboxContainer || !fieldHoursInput || !bibleStudiesInput ||
        !sharedMinistryCheckbox || !auxiliaryPioneerCheckbox) {
        console.warn("One or more Add Report page elements not found during visibility update. Make sure all IDs are correct in HTML.");
        return;
    }

    const privilege2 = privilege2ReportInput.value;
    const isAuxPioneerSelected = isAuxiliaryPioneerThisMonth.value;

    // Reset all to hidden/default states first
    auxPioneerQuestionContainer.classList.add("hidden");
    fieldHoursContainer.classList.add("hidden");
    bibleStudiesContainer.classList.add("hidden");
    sharedMinistryContainer.classList.add("hidden");
    auxiliaryPioneerCheckboxContainer.classList.add("hidden");

    fieldHoursInput.disabled = false;
    bibleStudiesInput.disabled = false;
    sharedMinistryCheckbox.disabled = false;
    auxiliaryPioneerCheckbox.disabled = false;

    sharedMinistryCheckbox.checked = false;
    auxiliaryPioneerCheckbox.checked = false;
    fieldHoursInput.value = "";
    bibleStudiesInput.value = "";

    // IMPORTANT: Reset event listeners for inputs to avoid multiple attachments or incorrect behavior
    fieldHoursInput.oninput = null;
    bibleStudiesInput.oninput = null;
    isAuxiliaryPioneerThisMonth.onchange = null;

    switch (privilege2) {
        case "Regular Pioneer":
        case "Special Pioneer":
        case "Field Missionary":
            fieldHoursContainer.classList.remove("hidden");
            bibleStudiesContainer.classList.remove("hidden");
            sharedMinistryContainer.classList.remove("hidden");

            fieldHoursInput.oninput = () => {
                fieldHoursInput.value = fieldHoursInput.value.replace(/[^0-9]/g, '');
                const hours = parseInt(fieldHoursInput.value);
                if (hours > 0) {
                    sharedMinistryCheckbox.checked = true;
                    sharedMinistryCheckbox.disabled = true;
                } else {
                    sharedMinistryCheckbox.checked = false;
                    sharedMinistryCheckbox.disabled = false;
                }
            };
            bibleStudiesInput.oninput = () => {
                bibleStudiesInput.value = bibleStudiesInput.value.replace(/[^0-9]/g, '');
            };
            sharedMinistryCheckbox.disabled = true;
            break;

        case "Continuous Auxiliary Pioneer":
            fieldHoursContainer.classList.remove("hidden");
            bibleStudiesContainer.classList.remove("hidden");
            sharedMinistryContainer.classList.remove("hidden");
            auxiliaryPioneerCheckboxContainer.classList.remove("hidden");

            fieldHoursInput.oninput = () => {
                fieldHoursInput.value = fieldHoursInput.value.replace(/[^0-9]/g, '');
                const hours = parseInt(fieldHoursInput.value);
                if (hours > 0) {
                    sharedMinistryCheckbox.checked = true;
                    sharedMinistryCheckbox.disabled = true;
                    auxiliaryPioneerCheckbox.checked = true;
                    auxiliaryPioneerCheckbox.disabled = true;
                } else {
                    sharedMinistryCheckbox.checked = false;
                    sharedMinistryCheckbox.disabled = false;
                    auxiliaryPioneerCheckbox.checked = false;
                    auxiliaryPioneerCheckbox.disabled = false;
                }
            };
            bibleStudiesInput.oninput = () => {
                bibleStudiesInput.value = bibleStudiesInput.value.replace(/[^0-9]/g, '');
            };
            sharedMinistryCheckbox.disabled = true;
            auxiliaryPioneerCheckbox.disabled = true;
            break;

        case "Publisher/Auxi":
            auxPioneerQuestionContainer.classList.remove("hidden");

            isAuxiliaryPioneerThisMonth.onchange = () => {
                const currentAuxStatus = isAuxiliaryPioneerThisMonth.value;
                fieldHoursContainer.classList.add("hidden");
                bibleStudiesContainer.classList.add("hidden");
                sharedMinistryContainer.classList.add("hidden");
                auxiliaryPioneerCheckboxContainer.classList.add("hidden");

                fieldHoursInput.disabled = false;
                bibleStudiesInput.disabled = false;
                sharedMinistryCheckbox.disabled = false;
                auxiliaryPioneerCheckbox.disabled = false;

                sharedMinistryCheckbox.checked = false;
                auxiliaryPioneerCheckbox.checked = false;
                fieldHoursInput.value = "";
                bibleStudiesInput.value = "";

                if (currentAuxStatus === "Yes") {
                    fieldHoursContainer.classList.remove("hidden");
                    bibleStudiesContainer.classList.remove("hidden");
                    sharedMinistryContainer.classList.remove("hidden");
                    auxiliaryPioneerCheckboxContainer.classList.remove("hidden");

                    fieldHoursInput.oninput = () => {
                        fieldHoursInput.value = fieldHoursInput.value.replace(/[^0-9]/g, '');
                        const hours = parseInt(fieldHoursInput.value);
                        if (hours > 0) {
                            sharedMinistryCheckbox.checked = true;
                            sharedMinistryCheckbox.disabled = true;
                            auxiliaryPioneerCheckbox.checked = true;
                            auxiliaryPioneerCheckbox.disabled = true;
                        } else {
                            sharedMinistryCheckbox.checked = false;
                            sharedMinistryCheckbox.disabled = false;
                            auxiliaryPioneerCheckbox.checked = false;
                            auxiliaryPioneerCheckbox.disabled = false;
                        }
                    };
                    bibleStudiesInput.oninput = () => {
                        bibleStudiesInput.value = bibleStudiesInput.value.replace(/[^0-9]/g, '');
                    };
                    sharedMinistryCheckbox.disabled = true;
                    auxiliaryPioneerCheckbox.disabled = true;

                } else if (currentAuxStatus === "No") {
                    fieldHoursContainer.classList.add("hidden");
                    bibleStudiesContainer.classList.remove("hidden");
                    sharedMinistryContainer.classList.remove("hidden");

                    bibleStudiesInput.oninput = () => {
                        bibleStudiesInput.value = bibleStudiesInput.value.replace(/[^0-9]/g, '');
                    };
                    sharedMinistryCheckbox.disabled = false;
                    auxiliaryPioneerCheckboxContainer.classList.add("hidden");
                }
            };
            if (isAuxiliaryPioneerThisMonth.value) {
                 isAuxiliaryPioneerThisMonth.onchange();
            }
            break;
        default:
            break;
    }
}

function clearAddReportForm() {
    if (searchPublisherReportInput) searchPublisherReportInput.value = "";
    if (suggestionBoxReport) suggestionBoxReport.innerHTML = "";
    if (publisherNameDropdown) publisherNameDropdown.value = "";
    if (fieldGroupInput) fieldGroupInput.value = "";
    if (privilege2ReportInput) privilege2ReportInput.value = "";
    if (serviceYearDropdown) serviceYearDropdown.value = "";
    if (monthYearDropdown) monthYearDropdown.value = "";
    if (fieldHoursInput) fieldHoursInput.value = "";
    if (bibleStudiesInput) bibleStudiesInput.value = "";
    if (sharedMinistryCheckbox) sharedMinistryCheckbox.checked = false;
    if (isAuxiliaryPioneerThisMonth) isAuxiliaryPioneerThisMonth.value = "";
    if (auxiliaryPioneerCheckbox) auxiliaryPioneerCheckbox.checked = false;

    if (auxPioneerQuestionContainer) auxPioneerQuestionContainer.classList.add("hidden");
    if (fieldHoursContainer) fieldHoursContainer.classList.add("hidden");
    if (bibleStudiesContainer) bibleStudiesContainer.classList.add("hidden");
    if (sharedMinistryContainer) sharedMinistryContainer.classList.add("hidden");
    if (auxiliaryPioneerCheckboxContainer) auxiliaryPioneerCheckboxContainer.classList.add("hidden");

    if (fieldHoursInput) fieldHoursInput.oninput = null;
    if (bibleStudiesInput) bibleStudiesInput.oninput = null;
    if (isAuxiliaryPioneerThisMonth) isAuxiliaryPioneerThisMonth.onchange = null;
}
</script>
</body>
</html>
